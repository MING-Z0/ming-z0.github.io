<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>AimRT官方示例解析 | MINGの部落格</title><meta name="keywords" content="CPP,AimRT,机器人"><meta name="author" content="Ming"><meta name="copyright" content="Ming"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#fdf5fa"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="AimRT官方示例解析"><meta name="application-name" content="AimRT官方示例解析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#fdf5fa"><meta property="og:type" content="article"><meta property="og:title" content="AimRT官方示例解析"><meta property="og:url" content="https://ming-z0.github.io/2025/05/18/AimRT/AimRT官方示例解析/AimRT官方示例解析/index.html"><meta property="og:site_name" content="MINGの部落格"><meta property="og:description" content="工具链与基本概念aimrt_cli​ 工具用法示例123aimrt_cli gen -p [config.yaml] -o [output_folder]# 示例：aimrt_cli gen -p helloworld.yaml -o .&amp;#x2F;helloworld&amp;#x2F;   配置驱动：通过 YAML 定义项"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://ming-z0.github.io/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/1.jpg"><meta property="article:author" content="Ming"><meta property="article:tag" content=" "><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://ming-z0.github.io/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/1.jpg"><meta name="description" content="工具链与基本概念aimrt_cli​ 工具用法示例123aimrt_cli gen -p [config.yaml] -o [output_folder]# 示例：aimrt_cli gen -p helloworld.yaml -o .&amp;#x2F;helloworld&amp;#x2F;   配置驱动：通过 YAML 定义项"><link rel="shortcut icon" href="/img/%E9%85%8D%E7%BD%AE/%E5%A4%B4%E5%83%8F.jpg"><link rel="canonical" href="https://ming-z0.github.io/2025/05/18/AimRT/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "i5biwbw9sk");</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 休息休息吧！","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://vercel-c6qs1so68-mings-projects-7cb05430.vercel.app/',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"cdn","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"距离上次更新已经过去了","messageNext":"天，文章的内容可能已经过时。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Ming","link":"链接: ","source":"来源: MINGの部落格","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'MINGの部落格',
  title: 'AimRT官方示例解析',
  postAI: '',
  pageFillDescription: '工具链与基本概念, aimrt_cli​ 工具, 用法示例, 配置文档示例：, CMake 依赖修正（cmake/GetAimRT.cmake​）, aimrt_main主进程, 项目工作流程, 集成业务逻辑的两种方式(App与Pkg), 执行器, HelloWorld示例, 配置文件（configuration_helloworld.yaml​ ）, module目录, HelloWorld_module, 模块定义（helloworld_module.h​）, 模块实现（helloworld_module.cc​）, 初始化阶段, 运行阶段, 停止阶段, Pkg目录, Pkg模式集成（pkg_main.cc）, 注册表定义, 注册宏, 加载运行, App目录, 核心接口, 注册模块（helloworld_app_registration_mode​）（推荐方案）, **创建模块（**​helloworld_app​）, Executor示例, 配置文件（configuration_executor.yaml​）, module目录, executor_module, 模块定义（executor_module.h​）, 模块实现（executor_module.cc​）, 初始化阶段, 运行阶段, 停止阶段, 对应的启动配置文件, executor_co_module, 模块定义（executor_co_module.h​）, 模块实现（executor_co_module.cc​）, 初始化阶段, 运行阶段, 停止阶段, 对应的启动配置文件, executor_co_loop_module, 模块定义（executor_co_loop_module.h​）, 模块实现(executor_co_loop_module.cc​), 初始化阶段, 运行阶段, 停止阶段, 对应的启动配置文件, real_time_module, 模块定义（real_time_module.h​）, 模块实现（real_time_module.cc​）, 初始化阶段, 运行阶段, 停止阶段, 对应的启动配置文件, logger示例, 配置文件(configuration_logger.yaml​), module目录, logger, 模块定义（logger_module.h​）, 模块实现（logger_module.cc​）, 对应的启动配置文件, logger rotate file, 对应的启动配置文件, logger specify executor, 对应的启动配置文件, logger format, 对应的启动配置文件, logger rotate file with sync（0.8.x版本不支持最新main分支开始支持）, 对应的启动配置文件, Parameter示例, 配置文件(configuration_parameter.yaml​), module目录, parameter_module, 模块定义, 模块实现, 初始化阶段, 运行阶段, 停止阶段, 对应的启动配置文件, pb_chn示例, 配置文件(configuration_protobuf_channel.yaml), protocols目录, my_proto.proto文件, CMakeLists.txt文件, module目录, normal_publisher_module, 链接生成的消息文件(CMakeLists.txt​), 模块定义(normal_publisher_module.h​), 模块实现(normal_publisher_module.cc​), 初始化阶段, 运行阶段, 停止阶段, normal_subscriber_module, 链接生成的消息文件(CMakeLists.txt​), 模块定义(normal_subscriber_module.h​), 模块实现(normal_subscriber_module.cc​), 初始化阶段, 运行阶段, 停止阶段, 启动Pkg模式通信示例, protobuf channel, 对应配置文件(cfg/local_deploy_local_ins_protobuf_channel_cfg.yaml​), 以pkg模式启动, protobuf channel single pkg, 对应配置文件(cfg/local_deploy_local_ins_protobuf_channel_single_pkg_cfg.yaml​), 以pkg模式启动, App目录, normal_pb_chn_publisher_app, 链接Protobuf生成的消息文件(CMakeLists.txt​), 主函数(main.cpp​), normal_pb_chn_subscriber_app, 链接Protobuf生成的消息文件(CMakeLists.txt​), 主函数(main.cpp​), 启动APP模式通信示例, protobuf channel publisher app, 配置文件(cfg/local_deploy_local_ins_protobuf_channel_publisher_app_cfg.yaml​), 以app模式启动, protobuf channel subscriber app, 配置文件(cfg/local_deploy_local_ins_protobuf_channel_subscriber_app_cfg.yaml​), 以app模式启动, 知识点, 发布消息的流程, ✅ 1. 读取配置参数（如 topic 名称、发布频率）, ✅ 2. 获取执行器 ExecutorRef（用于任务调度）, ✅ 3. 获取发布者 PublisherRef（指定 topic）, ✅ 4. 注册发布消息类型（绑定 Protobuf 类型）, ✅ 5. 创建 PublisherProxy（可选简化发布）, ✅ 6. 构造并填充消息对象, ✅ 7. 发布消息, 🗂️ 总结表（含具体接口）, 接收消息的流程, ✅ 1. 读取配置参数（如 topic 名称）, ✅ 2. 获取订阅者 SubscriberRef（绑定到 topic）, ✅ 3. 注册订阅消息类型 + 绑定回调函数（完成订阅）, ✅ 4. 实现回调函数处理接收到的消息, 🗂️ 总结表（含具体接口）, 关于订阅方的执行器, ❓1. 为什么订阅方在代码中没有显式指定执行器？, 🛠️ 2. 相关配置解释, 🔌 3. AimRT 插件机制, pb_rpc示例工具链与基本概念工具用法示例示例配置驱动通过定义项目结构编译选项部署模式工程生成自动创建工程模块模板配置文件安全机制输出目录需为空避免文件覆盖冲突配置文档示例直接看示例可能无法理解快进到后续示例中我们自行编写的配置文件对照学习基础信息配置必填项项目名称将作为代码的命名空间构建模式标签可自定义编译选项格式为若无需要可置为空列表引入选项配置必须使用单引号包裹值是否构建运行时是否使用库是否使用构建是否使用本地编译器是否使用插件是否与一起构建依赖的标准模块配置可选依赖库名称应与实际库名一致库地址版本标签导入选项暂不支持协议配置可选协议名称协议类型选项暂不支持构建模式标签仅在指定模式下构建未设置表示在所有模式下都构建模块配置可选模块名称仅在模式下构建选项暂不支持模块包配置可选包名称包含的模块模块名命名空间自定义模块用外部模块使用其实际命名空间仅在模式下构建部署配置可选部署模式名称构建模式检查部署实例配置实例名称依赖的包禁用的模块列表简单实例无包配置简单部署模式默认在所有模式下构建依赖修正由工具生成的项目框架还需要指定仓库和版本必须指定版本号主进程提供的可执行程序在运行时根据配置文件加载动态库形式的导入其中的项目工作流程配置文件工具生成完整工程编译可执行程序动态库加载集成业务逻辑的两种方式与框架可以通过两种方式来集成业务逻辑分别是模式和模式实际采用哪种方式需要根据具体场景进行判断两者的区别如下模式在开发者自己的函数中直接链接运行时库编译时直接将业务逻辑代码编译进主程序优势没有这个步骤没有只会有最终一个劣势可能会有第三方库的冲突无法独立的发布想要二进制发布只能直接发布使用场景一般用于小工具小型场景没有太大的模块解耦需求模式使用提供的可执行程序在运行时根据配置文件加载动态库形式的导入其中的类优势编译业务时只需要链接非常轻量的接口层不需要链接运行时库减少潜在的依赖冲突问题可以二进制发布独立性较好劣势框架基于加载极少数场景下会有一些兼容性问题使用场景一般用于中大型项目对模块解耦二进制发布等有较强烈需求时无论采用哪种方式都不影响业务逻辑且两种方式可以共存实际采用哪种方式需要根据具体场景进行判断注意上述说的两种方式只是针对开发接口如果是使用开发则只支持模式执行器或者叫执行器是指一个可以运行任务的抽象概念一个执行器可以是一个或者我们平常写的代码也是默认的直接指定了一个执行器线程一般来说能提供以下接口的就可以算是一个执行器还有一种提供定时执行的功能可以指定在某个时间点或某段时间之后再执行任务其接口类似如下在中执行器功能由接口层和实际执行器的实现两部分组成两者相互解耦接口层定义了执行器的抽象提供投递任务的接口而实现层则负责实际的任务执行根据实现类型的不同有不一样的表现官方提供了几种执行器例如基于的线程池基于的无锁线程池基于时间轮的定时执行器等开发者使用的执行器功能时在业务层将任务打包成一个闭包然后调用接口层的将任务投递到具体的执行器内而执行器会根据自己的调度策略在一定时机执行投递过来的任务具体逻辑流程如下图所示示例官方仓库配置文件依据官方示例项目结构自行编写配置文件基础信息项目名称构建模式标签框架的构建选项是否构建测试代码是否构建示例代码是否构建文档是否构建运行时核心是否构建命令行工具是否启用支持是否使用本地编译器是否集成支持是否构建网络插件是否构建插件其他插件选项等模块会生成自定义模块名称同时会据此生成的类名可选指定模块的构建标签会生成包名包含的模块部署会生成目录及相应的启动脚本配置文件部署模式名称部署实例实例名称实例加载的包运行工具生成脚手架代码目录完整代码查看官方仓库这里只讨论核心逻辑建议对照源码阅读模块定义必须实现的三大生命周期方法初始化配置业务逻辑入口资源释放框架核心句柄模块实现初始化阶段会在这一过程初始化自己的资源例如日志通信等模块官方文档提到需要注意的是的阶段仅仅是框架自身的初始化阶段可能只是整个服务初始化阶段的一部分使用者可能还需要在的阶段先初始化自己的一些业务逻辑比如检查上下游资源进行一些配置等然后再真正的进入整个服务的运行阶段思考能否将自己的一些资源获取相关的业务逻辑也放在这一阶段似乎没必要绑定框架核心读取配置示例初始化成功标志运行阶段初始化结束后就会调用进入运行阶段执行开发人员自己的业务逻辑日志输出演示停止阶段收到停止信号后会调用方法进行资源释放等操作所有的业务逻辑我们都会在类中进行实现具体加载运行方式会由根据配置文件进行集成目录模式集成提供的可执行程序在运行时会根据配置文件加载动态库形式的并导入其中的类加载后框架会自动调用进行初始化随后执行启动模块具体流程可参考源码主函数代码注册表定义模块标识名工厂函数模块名称用于标识框架会通过它查找模块工厂函数返回的实例供运行时调用注册宏框架入口宏宏展开后会生成个接口函数供调用获取当前动态库中的模块数量获取所有可用的模块名称根据模块名称创建模块实例销毁模块实例释放资源加载运行运行目录下的启动进程脚本名称由创建工程时的配置文件自动生成这是启动脚本的具体内容运行流程解析配置文件查找需要加载的模块名称在注册表中匹配模块名调用对应的工厂函数创建实例依次执行和完成模块启动目录模式官网概念开发者在自己的函数中注册创建各个模块编译时直接将业务逻辑编译进主程序可以简单理解为我们手动实现了启动逻辑分别有两种实现方式创建模块和注册模块核心接口需要在中引用相关库此时即可使用文件中的类核心接口如下接口使用说明如下用于初始化框架接收一个作为初始化参数其中最重要的项是用于设置配置文件路径如果初始化失败会抛出一个异常启动框架如果启动失败会抛出一个异常必须在方法之后调用否则行为未定义如果启动成功会阻塞当前线程并将当前线程作为本实例的主线程异步启动框架如果启动失败会抛出一个异常必须在方法之后调用否则行为未定义如果启动成功会返回一个句柄需要在调用方法后调用该句柄的方法阻塞等待结束该方法会在内部新启动一个线程作为本实例的主线程阅读函数源码可以发现创建的后台线程的唯一作用就是等待信号并执行清理工作停止框架可以在任意线程任意阶段调用此方法也可以调用任意次数调用此方法后方法将在执行完主线程中的所有任务后退出阻塞需要注意有时候业务会阻塞住主线程中的任务导致方法无法退出阻塞优雅结束整个框架此时需要在外部强制注册模块推荐方案通过可以直接注册一个标准模块开发者需要先实现一个继承于基类的然后在实例调用方法之前注册该实例在此方式下仍然有一个比较清晰的边界参考代码这里引用的是我们之前创建的类通过下面的命令启动编译后的可执行文件创建模块在实例调用方法之后通过可以创建一个模块并返回一个句柄开发者可以直接基于此句柄调用一些框架的方法比如或者等在此方式下没有一个比较清晰的边界不利于大型项目的组织一般仅用于快速做一些小工具参考代码全局指针指向实例用于在信号处理函数中进行关闭操作信号处理函数处理和信号如果实例存在则调用其方法进行关闭调用方法优雅退出传递其他信号按照默认行为处理注册信号处理函数确保进程收到终止信号时能正确清理资源启动日志启动赋值全局指针以便信号处理时可以访问配置选项如果传入了参数则使用该参数作为配置文件路径初始化实例创建模块并获取模块句柄记录日志表示模块创建成功这是一个示例日志读取并解析配置文件异步启动实例返回一个对象启动成功日志启动成功等待运行结束即触发关闭实例清空全局指针避免悬空指针问题运行时发生异常退出退出日志退出通过下面的命令启动编译后的可执行文件示例官方仓库配置文件依据官方示例项目结构自行编写配置文件基础信息项目名称构建模式标签框架的构建选项是否构建测试代码是否构建示例代码是否构建文档是否构建运行时核心是否构建命令行工具是否启用支持是否使用本地编译器是否集成支持是否构建网络插件是否构建插件模块最基本的示例基于协程接口使用功能的示例基于协程接口使用功能实现定时循环的示例实时性相关功能的示例包名部署部署模式名称部署实例实例名称实例加载的包运行工具生成脚手架代码目录一个最基本的示例演示内容包括如何获取执行器如何投递任务到执行器中执行如何使用线程安全型执行器如何投递定时任务到执行器中说明此示例创建了一个会在时获取以下三种执行器名称为的普通执行器名称为的线程安全型执行器名称为的支持定时任务的执行器模块在阶段会依次使用获取的执行器运行具体的逻辑任务投递一个简单的任务到其中执行向该执行器中一次性投递个任务用于递增一个整数并在最终打印出的值由于执行器是线程安全故最终值还是通过该执行器实现了一个间隔的定时循环此示例将集成到中并在配置文件中加载此模块定义执行器模块类继承自模块基类获取模块信息复制官方代码过来后需要添加命名空间初始化模块启动模块关闭模块获取日志记录器简单执行演示线程安全演示时间调度演示框架核心引用普通执行器线程安全执行器运行标志原子变量循环计数器时间调度执行器这里主要是定义了几个的执行器句柄和会用到的变量模块实现初始化阶段初始化模块保存框架句柄获取工作执行器无法获取工作执行器获取线程安全执行器无法获取线程安全执行器获取时间调度执行器无法获取时间调度执行器初始化成功主要操作是根据名称获取执行器执行器名称会在启动时由文件确定例如执行器名称执行器类型基于的线程池分配的线程数量用于并发处理任务线程安全执行器通过实现串行执行避免竞态条件执行器类型基于的包装确保线程安全绑定的基础执行器实际任务由其线程池调度执行定时任务执行器用于周期性定时调度任务执行器类型使用独立的线程池执行定时任务分配的线程数量可根据定时任务复杂度调整运行阶段启动模块测试简单执行测试线程安全执行测试时间调度执行启动成功任务函数实现简单执行演示这是一个简单任务线程安全演示线程安全执行器普通执行器等待秒的值为时间调度演示检查运行标志循环计数秒后再次执行本函数通过调用执行器句柄的或者向执行器中投递任务停止阶段关闭模块设置运行标志为等待秒关闭成功将变量置用于控制定时器执行器的任务停止对应的启动配置文件一个基于协程接口使用功能的示例演示内容包括如何以协程的方式使用执行器模块定义定义一个协程模块继承自的接口返回模块信息初始化模块启动模块执行实际的协程逻辑模块关闭逻辑清理资源获取日志器简单执行器示例演示普通线程池调度线程安全执行器示例演示多个任务安全执行定时执行器示例定时打印计数框架核心引用协程上下文对象可以用来获取某个执行器的协程封装接口协程作用域用于启动协程和等待协程完成可以跟踪和管理多个异步协程的生命周期控制定时任务运行的标志位模块实现初始化阶段保存框架核心引用创建协程上下文对象检查普通执行器是否可用无法获取执行器检查线程安全执行器是否可用无法获取执行器或不支持线程安全检查定时执行器是否可用无法获取执行器或不支持定时调度初始化成功模块初始化成功注意这里获取的三个执行器只是用来检查是否可用将错误限制在初始化阶段运行阶段启动普通协程任务启动线程安全的协程任务启动定时执行的协程任务模块启动成功调用三个任务函数用于向协程这个协程作用域中启动一个协程任务指的是在当前线程执行协程的第一段代码表示让协程在上开始执行获取的调度器打印当前协程的线程当前协程的线程将当前协程调度到上执行打印切换后的线程切换执行器后的线程执行任务内容执行普通任务通过执行器名称获取协程封装版本的调度器挂起当前线程后续让异步执行后续代码可以简单添加两个日志打印观察不同线程执行协程函数的切换效果获取的调度器计数器启动个线程安全任务等待所有任务执行完毕输出最终计数值线程安全任务已完成的值为这里的区别是协程内部再启动了个异步的协程让恢复操作在当前线程中执行开始定时任务循环获取的调度器切换协程到定时调度线程池定时循环第次延迟秒后再次调度实现定时循环退出定时任务循环让等待任务完成后由执行器中的线程恢复停止阶段停止定时任务循环等待所有协程任务完成模块已关闭停止定时任务阻塞当前线程直到所控制的所有协程任务完成对应的启动配置文件一个基于协程接口使用功能实现定时循环的示例演示内容包括如何以协程的方式使用执行器实现定时循环与上一个示例中的定时器类似因此这里只简单地分析模块定义引入原子操作支持用于线程安全的布尔变量引入协程相关的接口所有代码都放在对应命名空间下防止命名冲突自定义模块类继承自框架的基类构造函数默认构造析构函数使用默认析构模块信息用于注册模块时描述其名称初始化函数框架会在模块加载时调用启动函数框架会在模块时调用关闭函数框架会在模块卸载或退出时调用获取模块的日志对象用于打印日志主逻辑循环使用协程定义框架核心对象引用用于访问其他模块调度器等指向时间调度执行器的引用用于控制调度策略异步任务作用域用于批量管理协程任务控制循环运行状态的原子布尔标志线程安全创建变量核心句柄执行器句柄协程作用域管理器循环控制标志模块实现初始化阶段保存框架核心对象引用从框架中获取名为的调度器执行器校验是否成功获取并且该执行器支持定时调度功能无法获取支持定时调度的执行器打印初始化成功日志中文模块初始化成功运行阶段在内联调度器上启动主协程循环任务打印启动成功日志中文模块启动成功模块的主协程逻辑打印循环开始日志中文协程主循环开始使用创建调度器对象切换协程到定时调度线程池开始循环直到被设置为打印当前循环次数中文协程主循环第次延迟秒后再次调度实现定时循环逻辑循环结束后打印退出日志中文协程主循环已退出停止阶段设置运行标志为用于结束循环阻塞等待所有协程任务完成打印关闭成功日志中文模块已关闭对应的启动配置文件一个实时性相关功能的示例演示内容包括如何通过配置文件设置执行器的线程调度策略和优先级绑核策略等本示例仅在上有效本示例重点在于最后的配置文件模块定义防止头文件被多次包含提供原子类型用于线程安全标志控制引入协程相关接口异步作用域管理协程生命周期协程任务定义模块基类定义是一个继承自框架的的模块实现默认构造函数析构函数确保虚析构行为实现模块信息接口返回模块的名称模块初始化函数在模块被加载时调用模块启动函数在模块开始运行时调用模块关闭函数在模块卸载或退出时调用获取模块的日志接口用于打印日志信息通过指定执行器名称启动一个协程工作循环工作循环协程函数接收一个执行器引用作为参数框架核心引用用于访问系统资源管理模块中所有异步协程任务的作用域控制定时循环协程是否继续运行的标志位模块实现初始化阶段初始化模块保存核心引用保存框架句柄日志初始化成功初始化成功运行阶段启动模块分别在三个不同类型的执行器上启动工作协程启动调度线程的协程启动调度线程的协程启动轮询调度线程的协程日志启动成功启动成功启动指定执行器名的协程工作循环校验执行器存在并支持定时调度获取执行器失败使用指定执行器调度协程并托管给工作协程逻辑定时执行并打印线程和信息日志启动工作循环在执行器中启动工作循环获取当前线程名称获取线程调度策略和优先级日志打印线程信息执行器名线程名调度策略优先级记录当前时间戳用于计算时间协程挂起毫秒使用指定调度器获取当前线程使用的集合调用失败错误码构造当前线程使用的字符串获取当前运行在哪个上逻辑核调用失败错误码日志打印循环次数耗时信息等循环次数执行器名睡眠时间当前节点使用集合非下仅打印次数与耗时循环次数执行器名睡眠时间日志协程正常退出退出工作循环日志协程因异常退出工作循环异常退出原因停止阶段关闭模块停止协程并等待其完成设置退出标志等待所有协程完成日志关闭失败打印异常信息关闭失败异常信息日志关闭成功关闭成功对应的启动配置文件官网文档配置文件执行器相关框架核心日志级别可选值日志输出后端表示打印到终端控制台执行器名称唯一标识执行器类型基于的线程池模型启动的线程数调度策略为实时优先级实时调度将该线程绑定到第和号核心上用于控制亲和性执行超时时间阈值单位微秒超过则记录报警日志普通时间片调度策略执行器普通调度策略非实时轮转调度策略执行器轮转调度策略优先级模块包路径编译出的动态库从该库中启用哪些模块类可包含多个启用的模块名称对应继承自的类名该模块的日志级别覆盖仅对模块本身有效示例官方仓库配置文件依据官方示例项目结构自行编写配置文件基础信息项目名称构建模式标签框架的构建选项是否构建测试代码是否构建示例代码是否构建文档是否构建运行时核心是否构建命令行工具是否启用支持是否使用本地编译器是否集成支持是否构建网络插件是否构建插件模块包名部署部署模式名称部署实例实例名称实例加载的包目录一个最基本的示例演示内容包括如何在中打印到控制台如何使用不同的日志级别模块定义日志模块类继承自模块基类获取模块信息初始化模块启动模块关闭模块核心引用执行器引用运行标志位停止信号模块实现保存框架句柄获取执行器句柄获取执行器失败初始化成功为当前作用域创建日志句柄输出各级别日志测试跟踪日志字符串计数器测试调试日志字符串计数器测试信息日志字符串计数器测试警告日志字符串计数器测试错误日志字符串计数器测试致命日志字符串计数器启动成功关闭成功注意提供的日志宏基于语法实现内容很简单不在此做具体分析只需要关注配置文件的部分对应的启动配置文件框架主配置日志系统配置核心日志级别可选值设置表示只记录及以上级别的日志日志后端配置使用控制台作为日志输出执行器配置执行器列表定义一个名为的执行器执行器类型为简单线程模块配置模块包配置指定模块包路径启用该包中的模块模块详细配置模块的配置该模块的日志级别设置为最详细设置的是核心的日志等级中的控制的是本模块的日志等级日志输出后端支持控制台滚动文件等多种类型一个最基本的示例演示内容包括如何使用类型后端并了解其配置项代码与上一个示例完全相同对应的启动配置文件框架根配置节点日志系统配置部分核心日志级别配置框架自身日志输出级别可选值区分大小写最详细跟踪信息开发调试用调试信息常规运行信息推荐生产环境使用警告信息错误信息致命错误关闭所有日志当前设置为级别日志输出后端配置支持同时配置多个输出目标控制台输出配置必选输出到标准控制台滚动文件输出配置可选滚动文件类型文件输出专属配置日志文件存储目录相对路径日志文件名单个文件最大大小单位最大保留文件数达到后自动删除最旧文件执行器线程池配置部分执行器列表可配置多个执行器工作执行器配置执行器名称需与代码中引用名称一致执行器类型简单线程模式模块系统配置部分动态模块包配置可配置多个模块包第一个模块包配置模块动态库路径相对绝对路径需要启用的模块列表数组格式模块详细参数配置可覆盖模块默认参数模块配置必须与代码中模块类名完全一致模块专用日志级别可独立于设置一个最基本的示例演示内容包括如何使用指定的执行器作为日志后端的执行线程代码与示例相同对应的启动配置文件框架根配置节点日志系统配置核心日志级别框架自身日志输出级别可选值区分大小写最详细跟踪信息调试信息常规信息推荐生产环境使用警告信息错误信息致命错误关闭日志当前设置为级别日志输出后端配置控制台日志输出配置控制台输出类型指定专用的日志执行器执行器线程池配置执行器列表可配置多个工作执行器用于业务逻辑执行器名称简单线程模式专用日志执行器确保日志输出不阻塞业务线程执行器名称需与日志配置一致简单线程模式模块系统配置动态模块包配置日志模块包配置模块动态库路径启用的模块列表模块参数配置日志模块配置必须与代码中模块名一致模块日志级别开发时可用这里创建了一个单独的日志执行器避免日志操作阻塞业务线程要求日志执行器是线程安全的后端使用产生日志写入一个最基本的示例演示内容包括如何使用自定义的格式输出日志代码与示例相同对应的启动配置文件框架根配置节点日志系统配置核心日志级别框架自身日志输出级别可选值区分大小写最详细跟踪信息调试信息常规信息推荐生产环境使用警告信息错误信息致命错误关闭日志当前设置为级别日志输出后端配置控制台日志输出配置控制台输出类型日志格式模板支持自定义格式可用占位符说明日志器名称文件名短格式完整文件名行号线程模块名称日志分组实际日志内容日志级别日期时间可带格式修饰如执行器线程池配置执行器列表可配置多个工作执行器配置执行器名称简单线程模式模块系统配置动态模块包配置日志模块包配置模块动态库路径启用的模块列表模块参数配置日志模块配置必须与代码中模块名一致模块日志级别开发时可用配置了日志打印格式为日志输出示例如下版本不支持最新分支开始支持一个最基本的示例演示内容包括如何使用类型后端并了解其配置项如何配置相关配置选项以开启定期落盘机制保证数据完整性对应的启动配置文件框架根配置节点日志系统配置核心日志级别框架自身日志输出级别可选值区分大小写最详细跟踪信息开发调试用调试信息常规运行信息推荐生产环境使用警告信息错误信息致命错误关闭所有日志当前设置为级别日志输出后端配置支持多后端同时输出控制台输出配置实时输出标准控制台输出轮转文件输出配置持久化存储支持日志文件轮转日志存储目录相对路径日志文件名单个文件最大最多保留个历史文件日志同步配置确保日志完整性启用定期同步每秒同步到磁盘使用专用执行器执行器线程池配置工作执行器处理业务逻辑简单线程模式日志同步定时器执行器模块系统配置动态模块包配置模块动态库路径启用的模块列表模块参数配置模块名称需与代码一致模块日志级别开发调试用示例官方仓库中提供了一个简单的模块级参数功能模块可以通过调用句柄的接口获取句柄来使用此功能该句柄提供的核心接口如下使用注意点如下接口用于获取参数如果不存在则返回空字符串该接口是线程安全的接口用于设置更新参数如果不存在则新建一个参数对如果存在则更新所对应的值为最新值该接口是线程安全的无论是设置参数还是获取参数都是模块级别的不同模块的参数互相独立互不可见配置文件依据官方示例项目结构自行编写配置文件基础信息项目名称构建模式标签框架的构建选项是否构建测试代码是否构建示例代码是否构建文档是否构建运行时核心是否构建命令行工具是否启用支持是否使用本地编译器是否集成支持是否构建网络插件是否构建插件模块包名部署部署模式名称部署实例实例名称实例加载的包目录一个最基本的示例演示内容包括如何使用的功能此示例创建了一个会在其的阶段循通过和方法设置和获取参数的值并通过日志打印出来模块定义参数模块类继承自模块基类返回模块信息模块名称模块初始化接口模块启动接口模块关闭接口获取日志记录器设置参数的循环任务获取参数的循环任务核心引用执行器参数操作句柄运行标志控制循环是否继续设置参数循环停止信号获取参数循环停止信号句柄可以用来设置和获取参数模块实现初始化阶段保存框架核心引用获取执行器获取执行器失败获取参数操作句柄获取参数句柄失败初始化失败初始化成功获取执行器获取参数操作句柄运行阶段启动模块将方法绑定到当前对象并提交到工作线程池执行将方法绑定到当前对象并提交到工作线程池执行启动失败启动成功设置参数循环任务开始设置参数循环设置参数循环计数构造键值对设置参数设置参数键值休眠秒退出设置参数循环设置参数循环异常退出通知循环已停止获取参数循环任务开始获取参数循环获取参数循环计数构造键获取参数值获取参数键值休眠秒退出获取参数循环获取参数循环异常退出通知循环已停止两个循环独立运行但通过共享的交互设置参数循环工作流程进入无限循环直到变为每次循环生成递增的键值对通过参数句柄存储这些参数每次操作后休眠秒退出时发送停止信号获取参数循环工作流程进入无限循环直到变为每次循环尝试获取对应键的参数值记录获取到的参数值每次操作后休眠秒退出时发送停止信号停止阶段设置停止标志等待设置参数循环停止等待获取参数循环停止关闭失败关闭成功对应的启动配置文件示例官方仓库这个官方示例展示了如何基于协议和后端实现通信主要包括四种场景基础示例分别用两个模块和发布和订阅消息使用通信单集成与基础示例类似但将发布和订阅模块集成到同一个运行模式以模式直接运行同时以方式运行模式以模式直接运行同时以方式运行需要先阅读一下官方文档的相关内容章节这里我们没有复现两个模块只关注通信相关内容配置文件依据官方示例项目结构自行编写配置文件基础信息项目名称构建模式标签框架构建选项启用支持必须开启启用模块化运行支持必须开启关闭测试模块构建关闭示例构建实际跑示例需打开关闭文档构建关闭命令行工具使用内置编译器关闭支持关闭网络插件关闭插件协议配置预留可扩展选项以下为注释掉的备用协议示例仅在模式启用模块定义定期发布消息订阅并处理消息包组合配置单包整合示例发布模块包仅发布者订阅模块包仅订阅者部署方案本地部署方案双包部署发布订阅分开单包部署发布订阅合一官方工具似乎不支持模式因此相关文件需要手动配置发布配置主要影响后续生成的文件和启动脚本可以将以下内容添加到配置文件中但仍需手动调整发布订阅模块包用于订阅发布的消息订阅发布模块包用于向发布消息目录这是配置文件中协议部分生成的目录管理通信协议相关的文件文件用来定义通信的消息类型命名空间在这里定义您的消息文件框架封装了从生成代码的操作只需要使用提供的方法即可相关内容见官方文档封装最终生成的需要链接到模块可以在文件最后添加下面的内容查看名称打印最终名称最终名称目录链接生成的消息文件略在这里进行链接模块定义普通发布者模块类该模块用于定期发布格式的消息到指定主题获取模块基本信息获取日志记录器主工作循环核心系统引用任务执行器引用运行状态标志停止信号量发布主题名称发布频率消息发布器引用定期发布格式的消息到指定主题模块实现初始化阶段保存后续模块操作需要用到从配置文件读取和发布频率获取执行器用来安排任务执行获取执行器失败是中安排异步任务的组件类似线程池或定时器调度器获取即通道的发布句柄获取主题的发布者失败是发布消息用的关键对象相当于话题写入器注册消息类型必须要做注册发布类型失败必须告诉系统这个上发送的是类型的消息初始化失败错误信息模块初始化成功获取了配置文件中的相关配置获取了执行器获取了消息发布者对消息类型进行注册运行阶段设置运行标志控制主循环启动主循环任务这里没有直接启动线程而是通过异步调度执行即委托给了的调度器管理模块启动失败错误信息模块启动成功主工作循环开始运行创建简化消息发布过程绑定后面发布时只需要传不用每次带还能管理更高级按配置的发布频率休眠发布循环计数构造并填充消息当前计数设置文本字段设置数字字段发布消息发布新消息内容是异步的实际发送取决于通道后端的实现如果后端阻塞可能导致耗时不稳定但一般很快返回主工作循环正常退出主工作循环异常退出错误信息通知主线程主循环已经结束通过执行器绑定函数函数首先创建了一个发布代理用来简化消息发布操作绑定后面发布时只需要传不用每次带构造并填充消息进行发布停止阶段通知主循环退出等待退出信号模块关闭失败错误信息模块已正常关闭通过信号量通知进行优雅退出链接生成的消息文件略链接生成的消息文件模块定义自定义消息头文件普通订阅者模块类该模块用于订阅并处理格式的消息获取模块基本信息初始化模块启动模块关闭模块获取日志记录器事件处理回调函数消息上下文接收到的消息数据上下文信息是由系统框架传递的在编译期确定核心系统引用订阅主题名称消息订阅者引用模块实现初始化阶段保存后续操作模块需要用到读取配置文件拿到订阅的话题名获取准备订阅主题获取主题的订阅者失败注册消息订阅回调订阅消息失败这里使用的是函数风格带参数智能指针回调的订阅形式必须在阶段完成订阅运行中不允许动态订阅初始化失败错误信息模块初始化成功处理收到的新消息收到新消息上下文数据内容提供了消息链路来源发送时间等上下文信息可以根据需要提取是消息的智能指针直接解引用使用即可获取配置文件中的相关配置获取订阅者注册消息订阅回调函数注意点可以看到回调函数会接收一个上下文参数而我们编写的发布者并没有看到这个数据这个上下文参数是由框架自动传入的也可以只保留一个参数这一过程是在编译期确定的运行阶段当前阶段无特定动作框架会自动管理订阅回调的调度停止阶段当前阶段无特定动作生命周期随模块销毁而结束启动模式通信示例一个最基本的基于协议与后端的示例演示内容包括如何使用协议作为传输协议如何基于方式使用和功能如何使用类型的后端如何以模式集成并启动对应配置文件消息通道相关配置官方文档类型的后端是官方提供的一种后端用于将消息发布到同进程中的其他模块它会自动判断发布端和订阅端是否在同一个内从而采用各种方式进行性能的优化如果配置为则直接使用发布端的执行器来执行订阅端的回调会阻塞发布端的方法直到所有的订阅端回调都执行完成仅在为时生效后端会将订阅端的回调都投递进此执行器中异步执行发布端的方法会立即返回模块自定义配置名称消息通道相关配置官方文档配置文件通道说明此示例创建了以下两个模块会基于执行器以配置的频率向配置的中发布类型的消息会订阅配置的下的类型的消息此示例将和分别集成到和两个中并在配置文件中加载这两个到一个进程中此示例使用类型的后端进行通信以模式启动启动命令为如果是通过工具生成代码框架则执行脚本一个最基本的基于协议与后端的示例演示内容包括如何使用协议作为传输协议如何基于方式使用和功能如何使用类型的后端如何以模式集成并启动对应配置文件说明此示例与示例基本一致唯一的区别是将和集成到一个中以模式启动启动命令为如果是通过工具生成代码框架则执行脚本目录链接生成的消息文件略主函数信号处理标准输入输出包含框架相关头文件生成的消息定义使用核心命名空间全局运行标志信号处理函数处理中断和终止信号设置运行标志为以优雅退出其他信号原样抛出主函数注册信号处理函数启动创建核心对象初始化配置从命令行参数获取配置文件路径初始化核心创建模块创建发布者模块默认主题名默认发布频率读取配置文件加载配置获取主题名配置获取发布频率配置注册发布类型获取发布者检查发布者是否有效失败会抛出异常获取主题的发布者失败创建发布者代理用于发布消息注册发布类型注册发布类型失败启动核心异步发布消息循环按配置频率休眠循环计数构造并发布消息计数设置消息内容设置消息编号记录日志并发布发布新的事件数据将转为格式日志发布消息优雅关闭关闭核心等待异步操作完成运行异常并退出异常退出退出正常退出日志基于模式创建模块的方式使用功能创建模块获取句柄以配置的频率向配置的中发布类型的消息链接生成的消息文件主函数全局核心指针用于信号处理信号处理函数接收到的信号如果是中断或终止信号且全局核心指针有效则优雅关闭其他信号继续传递主函数注册信号处理函数启动中创建核心对象初始化配置从命令行参数获取配置文件路径创建模块默认主题名从配置文件读取主题名获取订阅者获取主题的订阅者失败订阅事件收到消息时的回调函数收到新的协议事件消息内容订阅失败启动核心关闭核心清除全局指针运行时发生异常并退出正常退出基于模式创建模块的方式使用功能创建模块获取句柄会订阅配置的下的类型的消息启动模式通信示例一个基于协议与后端的示例演示内容包括如何使用协议作为传输协议如何基于模式创建模块的方式使用功能如何基于方式使用功能如何使用类型的后端如何以模式启动配置文件订阅方使用的是之前以模式编写的包启动发布模块模式编写启动订阅模块模式编写以模式启动启动命令为注意工具不支持生成模式代码框架因此不会有相应的启动脚本需要自行编写可以在生成代码框架时先使用模式进行设置之后对生成的配置文件启动脚本进行修改即可编写一个模式的启动脚本一个基于协议与后端的示例演示内容包括如何使用协议作为传输协议如何基于模式创建模块的方式使用功能如何基于方式使用功能如何使用类型的后端如何以模式启动配置文件以模式启动启动命令为注意工具不支持生成模式代码框架因此不会有相应的启动脚本需要自行编写可以在生成代码框架时先使用模式进行设置之后对生成的配置文件启动脚本进行修改即可编写一个模式的启动脚本知识点发布消息的流程读取配置参数如名称发布频率作用动态配置名发布频率等运行参数接口示例获取执行器用于任务调度作用用于安排主发布任务的异步执行接口验证是否支持定时调度获取发布者指定作用绑定发布主题用于后续发送消息接口注册发布消息类型绑定类型作用向系统注册将要发送的消息类型接口注册发布类型失败创建可选简化发布作用封装便于发布消息自动处理上下文接口构造并填充消息对象作用设置消息字段如文本数值接口当前计数发布消息作用将消息写入通道供订阅者消费接口总结表含具体接口步骤描述接口代码片段获取配置参数获取执行器获取注册消息类型创建构造消息发布消息接收消息的流程读取配置参数如名称作用动态配置接收的名便于部署时灵活调整接口示例获取订阅者绑定到作用从通道系统获取订阅者句柄准备订阅对应的消息通道接口获取主题的订阅者失败注册订阅消息类型绑定回调函数完成订阅作用声明要接收的消息类型注册回调函数回调函数将在消息到达时被自动触发接口订阅消息失败说明使用的是函数风格接口回调形式为带参数智能指针消息只能在模块的阶段调用订阅函数一个不能重复订阅相同类型实现回调函数处理接收到的消息作用处理订阅消息的内容可访问上下文信息执行业务逻辑接口收到新消息上下文数据内容说明提供上下文信息如消息来源时间戳是消息的智能指针可直接使用处理逻辑可以轻量也可以将任务调度到其它执行器中但执行器不是在订阅处指定的总结表含具体接口步骤描述接口代码片段获取配置参数获取注册消息回调实现回调处理函数关于订阅方的执行器为什么订阅方在代码中没有显式指定执行器在中订阅方执行器的配置不在订阅模块代码中指定而是通过配置文件的后端参数进行集中管理原因如下解耦设计理念框架采用高度模块化设计模块本身只声明对的订阅关系具体使用哪个执行器或是否同步处理由统一决定配置驱动逻辑清晰通过配置控制订阅执行行为可以更灵活地调整运行时特性例如从同步切换为异步调整执行线程数而无需更改模块实现利于跨模块优化调度在同一后端中集中处理执行策略有助于线程资源的统一调度和优化避免各模块各自为政造成资源浪费或线程争抢因此订阅方是否使用执行器由中的决定而非模块代码内部相关配置解释定义了一个线程池执行器基于类型拥有个线程这个线程池将会执行消息发布循环消息接收回调的代码配置了一个类型的后端表示不使用同步执行模式所有订阅回调将异步投递到执行器中因此订阅模块的回调逻辑不会阻塞发布方的调用通配符匹配所有使其均由后端处理因此可以实现不同话题使用不同后端处理插件机制的通信机制是高度可扩展的其后端实现支持插件化架构除了内置的后端之外官方或第三方还可以实现如下多种通信形式的插件网络通信如中间件集成如这些插件均可作为的新类型通过配置加载并与发布订阅模块联动实现模块间的远程跨进程或跨平台消息传递相关内容后续学习插件章节时再进行详细记录示例',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2025-08-27 21:34:54',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#1a1621')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fdf5fa')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/%E9%85%8D%E7%BD%AE/%E5%A4%B4%E5%83%8F.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://ming-blog.top/" title="MINGの部落格"><img class="back-menu-item-icon" src="/img/配置/头像.jpg" alt="MINGの部落格"/><span class="back-menu-item-text">MINGの部落格</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/MING-Z0/" title="GitHub"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">MINGの部落格</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/./img/%E6%89%93%E8%B5%8F/wechat.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src="/./img/%E6%89%93%E8%B5%8F/wechat.jpg"/></a><div class="post-qr-code-desc">微信</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AimRT/" style="font-size: 1.05rem;">AimRT<sup>1</sup></a><a href="/tags/CMake/" style="font-size: 1.05rem;">CMake<sup>2</sup></a><a href="/tags/CPP/" style="font-size: 1.05rem;">CPP<sup>21</sup></a><a href="/tags/CUDA/" style="font-size: 1.05rem;">CUDA<sup>10</sup></a><a href="/tags/STL/" style="font-size: 1.05rem;">STL<sup>5</sup></a><a href="/tags/%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97/" style="font-size: 1.05rem;">并行计算<sup>12</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" style="font-size: 1.05rem;">开发环境<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">开发语言<sup>5</sup></a><a href="/tags/%E6%9C%BA%E5%99%A8%E4%BA%BA/" style="font-size: 1.05rem;">机器人<sup>1</sup></a><a href="/tags/%E8%AE%BF%E5%AD%98%E4%BC%98%E5%8C%96/" style="font-size: 1.05rem;">访存优化<sup>1</sup></a><a href="/tags/%E9%9A%8F%E8%AE%B0/" style="font-size: 1.05rem;">随记<sup>5</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 1.05rem;">面试<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">15</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">十二月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/AimRT/" itemprop="url">AimRT</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/CPP/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>CPP</span></a><a class="article-meta__tags" href="/tags/AimRT/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>AimRT</span></a><a class="article-meta__tags" href="/tags/%E6%9C%BA%E5%99%A8%E4%BA%BA/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>机器人</span></a></span></div></div><h1 class="post-title" itemprop="name headline">AimRT官方示例解析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-05-17T16:00:00.000Z" title="发表于 2025-05-18 00:00:00">2025-05-18</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-08-27T13:34:54.607Z" title="更新于 2025-08-27 21:34:54">2025-08-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">21.2k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>84分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="AimRT官方示例解析"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/1.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://ming-z0.github.io/2025/05/18/AimRT/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/"><header><a class="post-meta-categories" href="/categories/AimRT/" itemprop="url">AimRT</a><a href="/tags/CPP/" tabindex="-1" itemprop="url">CPP</a><a href="/tags/AimRT/" tabindex="-1" itemprop="url">AimRT</a><a href="/tags/%E6%9C%BA%E5%99%A8%E4%BA%BA/" tabindex="-1" itemprop="url">机器人</a><h1 id="CrawlerTitle" itemprop="name headline">AimRT官方示例解析</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Ming</span><time itemprop="dateCreated datePublished" datetime="2025-05-17T16:00:00.000Z" title="发表于 2025-05-18 00:00:00">2025-05-18</time><time itemprop="dateCreated datePublished" datetime="2025-08-27T13:34:54.607Z" title="更新于 2025-08-27 21:34:54">2025-08-27</time></header><h1 id="工具链与基本概念"><a href="#工具链与基本概念" class="headerlink" title="工具链与基本概念"></a>工具链与基本概念</h1><h2 id="aimrt-cli​-工具"><a href="#aimrt-cli​-工具" class="headerlink" title="aimrt_cli​ 工具"></a><code>aimrt_cli</code>​ 工具</h2><h3 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aimrt_cli gen -p [config.yaml] -o [output_folder]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">示例：</span></span><br><span class="line">aimrt_cli gen -p helloworld.yaml -o ./helloworld/</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>配置驱动</strong>：通过 YAML 定义项目结构&#x2F;编译选项&#x2F;部署模式</li>
<li><strong>工程生成</strong>：自动创建 CMake 工程、模块模板、配置文件</li>
<li><strong>安全机制</strong>：输出目录需为空，避免文件覆盖冲突</li>
</ul>
<h3 id="配置文档示例："><a href="#配置文档示例：" class="headerlink" title="配置文档示例："></a>配置文档示例：</h3><p>直接看示例可能无法理解，快进到后续示例中我们自行编写的<a href="#20250402155159-hybss8y">配置文件</a>，对照学习</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"># 基础信息配置（必填项）</span><br><span class="line">base_info:</span><br><span class="line">  # 项目名称，将作为代码的命名空间</span><br><span class="line">  project_name: test_prj</span><br><span class="line"></span><br><span class="line">  # 构建模式标签，可自定义编译选项</span><br><span class="line">  # 格式为 &#123;PROJECT_NAME&#125;_&#123;OPTION_NAME&#125;，若无需要可置为空列表 []</span><br><span class="line">  build_mode_tags: [<span class="string">&quot;EXAMPLE&quot;</span>, <span class="string">&quot;SIMULATION&quot;</span>, <span class="string">&quot;TEST_CAMERA&quot;</span>]</span><br><span class="line"></span><br><span class="line">  # AIMRT引入选项配置（必须使用单引号包裹值）</span><br><span class="line">  aimrt_import_options:</span><br><span class="line">    # 是否构建运行时</span><br><span class="line">    AIMRT_BUILD_RUNTIME: <span class="string">&#x27;ON&#x27;</span></span><br><span class="line">    # 是否使用fmt库</span><br><span class="line">    AIMRT_USE_FMT_LIB: <span class="string">&#x27;ON&#x27;</span></span><br><span class="line">    # 是否使用protobuf构建</span><br><span class="line">    AIMRT_BUILD_WITH_PROTOBUF: <span class="string">&#x27;ON&#x27;</span></span><br><span class="line">    # 是否使用本地protoc编译器</span><br><span class="line">    AIMRT_USE_LOCAL_PROTOC_COMPILER: <span class="string">&#x27;OFF&#x27;</span></span><br><span class="line">    # 是否使用protoc python插件</span><br><span class="line">    AIMRT_USE_PROTOC_PYTHON_PLUGIN: <span class="string">&#x27;OFF&#x27;</span></span><br><span class="line">    # 是否与ROS2一起构建</span><br><span class="line">    AIMRT_BUILD_WITH_ROS2: <span class="string">&#x27;ON&#x27;</span></span><br><span class="line"></span><br><span class="line"># 依赖的标准模块配置（可选）</span><br><span class="line">depends_std_modules:</span><br><span class="line">  - name: xxx  # 依赖库名称（应与实际库名一致）</span><br><span class="line">    git_repository: https:<span class="comment">//github.com/xxx/xxx.git  # 库地址</span></span><br><span class="line">    git_tag: v<span class="number">0.1</span><span class="number">.5</span>  # 版本标签</span><br><span class="line">    import_options:  # 导入选项（暂不支持）</span><br><span class="line">      XXX: <span class="string">&#x27;ON&#x27;</span></span><br><span class="line">  - name: yyy</span><br><span class="line">    git_repository: https:<span class="comment">//github.com/yyy/yyy.git</span></span><br><span class="line">    git_tag: v<span class="number">0.1</span><span class="number">.11</span></span><br><span class="line"></span><br><span class="line"># 协议配置（可选）</span><br><span class="line">protocols:</span><br><span class="line">  - name: my_proto  # 协议名称</span><br><span class="line">    type: protobuf   # 协议类型（protobuf/ros2）</span><br><span class="line">    options:         # 选项（暂不支持）</span><br><span class="line">      xxx: xxx</span><br><span class="line"></span><br><span class="line">  - name: my_ros2_proto</span><br><span class="line">    type: ros2</span><br><span class="line">    options:</span><br><span class="line">      zzz: zzz</span><br><span class="line">    # 构建模式标签，仅在指定模式下构建</span><br><span class="line">    build_mode_tag: [<span class="string">&quot;EXAMPLE&quot;</span>]</span><br><span class="line"></span><br><span class="line">  - name: example_proto</span><br><span class="line">    type: protobuf</span><br><span class="line">    # 未设置build_mode_tag表示在所有模式下都构建</span><br><span class="line">    build_mode_tag: [<span class="string">&quot;EXAMPLE&quot;</span>]</span><br><span class="line"></span><br><span class="line"># 模块配置（可选）</span><br><span class="line">modules:</span><br><span class="line">  - name: my_foo_module  # 模块名称</span><br><span class="line"></span><br><span class="line">  - name: my_bar_module</span><br><span class="line"></span><br><span class="line">  - name: exmaple_module</span><br><span class="line">    # 仅在EXAMPLE模式下构建</span><br><span class="line">    build_mode_tag: [<span class="string">&quot;EXAMPLE&quot;</span>]</span><br><span class="line">    options:  # 选项（暂不支持）</span><br><span class="line">      aaa: aaa</span><br><span class="line"></span><br><span class="line"># 模块包配置（可选）</span><br><span class="line">pkgs:</span><br><span class="line">  - name: pkg1  # 包名称</span><br><span class="line">    modules:    # 包含的模块</span><br><span class="line">      - name: my_foo_module  # 模块名</span><br><span class="line">        <span class="keyword">namespace</span>: local     # 命名空间（自定义模块用local）</span><br><span class="line">      - name: my_bar_module</span><br><span class="line">        <span class="keyword">namespace</span>: local</span><br><span class="line">    options:</span><br><span class="line">      sss: sss</span><br><span class="line"></span><br><span class="line">  - name: pkg2</span><br><span class="line">    modules:</span><br><span class="line">      - name: exmaple_module</span><br><span class="line">        <span class="keyword">namespace</span>: local</span><br><span class="line">      - name: ep_example_bar_module</span><br><span class="line">        <span class="keyword">namespace</span>: ep_example_aimrt_module  # 外部模块使用其实际命名空间</span><br><span class="line">    build_mode_tag: [<span class="string">&quot;EXAMPLE&quot;</span>]  # 仅在EXAMPLE模式下构建</span><br><span class="line">    options:</span><br><span class="line">      sss: sss</span><br><span class="line"></span><br><span class="line"># 部署配置（可选）</span><br><span class="line">deploy_modes:</span><br><span class="line">  - name: exmaple_mode  # 部署模式名称</span><br><span class="line">    build_mode_tag: [<span class="string">&quot;EXAMPLE&quot;</span>]  # 构建模式检查</span><br><span class="line">    deploy_ins:  # 部署实例配置</span><br><span class="line">      - name: local_ins_1  # 实例名称</span><br><span class="line">        pkgs:    # 依赖的包</span><br><span class="line">          - name: pkg1</span><br><span class="line">            options:</span><br><span class="line">              disable_modules: []  # 禁用的模块列表</span><br><span class="line">      - name: local_ins_2  # 简单实例（无包配置）</span><br><span class="line">      - name: remote_ins_123</span><br><span class="line"></span><br><span class="line">  # 简单部署模式（默认在所有模式下构建）</span><br><span class="line">  - name: deploy_mode_1</span><br><span class="line">  - name: deploy_mode_2</span><br></pre></td></tr></table></figure>

<h3 id="CMake-依赖修正（cmake-GetAimRT-cmake​）"><a href="#CMake-依赖修正（cmake-GetAimRT-cmake​）" class="headerlink" title="CMake 依赖修正（cmake/GetAimRT.cmake​）"></a>CMake 依赖修正（<code>cmake/GetAimRT.cmake</code>​）</h3><p>由<code>aimrt_cli</code>​工具生成的项目框架，还需要指定仓库和版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmake/GetAimRT.cmake</span></span><br><span class="line">FetchContent_Declare(</span><br><span class="line">  aimrt</span><br><span class="line">  GIT_REPOSITORY https://github.com/AimRT/aimrt.git</span><br><span class="line">  GIT_TAG v0.8.3)  <span class="comment"># 必须指定版本号</span></span><br></pre></td></tr></table></figure>

<h2 id="aimrt-main主进程"><a href="#aimrt-main主进程" class="headerlink" title="aimrt_main主进程"></a>aimrt_main主进程</h2><p>AimRT 提供的<code>aimrt_main</code>​可执行程序，在运行时根据配置文件加载动态库形式的<code>Pkg</code>​，导入其中的<code>Module</code>​</p>
<h2 id="项目工作流程"><a href="#项目工作流程" class="headerlink" title="项目工作流程"></a>项目工作流程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A[YAML 配置文件] --&gt; B[aimrt_cli 工具]</span><br><span class="line">B --&gt; C[生成完整工程]</span><br><span class="line">C --&gt; D[CMake 编译]</span><br><span class="line">D --&gt; E[可执行程序]</span><br><span class="line">D --&gt; F[动态库]</span><br><span class="line">F --&gt; G[aimrt_main 加载]</span><br></pre></td></tr></table></figure>

<h2 id="集成业务逻辑的两种方式-App与Pkg"><a href="#集成业务逻辑的两种方式-App与Pkg" class="headerlink" title="集成业务逻辑的两种方式(App与Pkg)"></a>集成业务逻辑的两种方式(App与Pkg)</h2><p>AimRT 框架可以通过两种方式来集成业务逻辑，分别是 <strong>App模式</strong> 和 <strong>Pkg模式</strong>，实际采用哪种方式需要根据具体场景进行判断。两者的区别如下：</p>
<ul>
<li><p><strong>App模式</strong>：在开发者自己的 Main 函数中直接链接 AimRT 运行时库，编译时直接将业务逻辑代码编译进主程序：</p>
<ul>
<li><strong>优势</strong>：没有 dlopen 这个步骤，没有 so，只会有最终一个 exe。</li>
<li><strong>劣势</strong>：可能会有第三方库的冲突；无法独立的发布<code>Module</code>​，想要二进制发布只能直接发布 exe。</li>
<li><strong>使用场景</strong>：一般用于小工具、小型 Demo 场景，没有太大的模块解耦需求；</li>
</ul>
</li>
<li><p><strong>Pkg模式</strong>：使用 AimRT 提供的 <strong>aimrt_main</strong> 可执行程序，在运行时根据配置文件加载动态库形式的<code>Pkg</code>​，导入其中的<code>Module</code>​类:</p>
<ul>
<li><strong>优势</strong>：编译业务<code>Module</code>​时只需要链接非常轻量的 AimRT 接口层，不需要链接 AimRT 运行时库，减少潜在的依赖冲突问题；可以二进制发布 so；独立性较好。</li>
<li><strong>劣势</strong>：框架基于 dlopen 加载<code>Pkg</code>​，极少数场景下会有一些兼容性问题。</li>
<li><strong>使用场景</strong>：一般用于中大型项目，对模块解耦、二进制发布等有较强烈需求时；</li>
</ul>
</li>
</ul>
<p>无论采用哪种方式都不影响业务逻辑，且两种方式可以共存，实际采用哪种方式需要根据具体场景进行判断。</p>
<p>注意，上述说的两种方式只是针对 Cpp 开发接口。如果是使用 Python 开发，则只支持App模式。</p>
<h2 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h2><p><code>Executor</code>​，或者叫执行器，是指一个可以运行任务的抽象概念，一个执行器可以是一个 Fiber、Thread 或者 Thread Pool，我们平常写的代码也是默认的直接指定了一个执行器：Main 线程。一般来说，能提供以下接口的就可以算是一个执行器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void Execute(std::function&lt;void()&gt;&amp;&amp; task);</span><br></pre></td></tr></table></figure>

<p>还有一种<code>Executor</code>​提供定时执行的功能，可以指定在某个时间点或某段时间之后再执行任务。其接口类似如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void ExecuteAt(std::chrono::system_clock::time_point tp, std::function&lt;void()&gt;&amp;&amp; task);</span><br><span class="line">void ExecuteAfter(std::chrono::nanoseconds dt, std::function&lt;void()&gt;&amp;&amp; task);</span><br></pre></td></tr></table></figure>

<p>在 AimRT 中，执行器功能由<strong>接口层</strong>和<strong>实际执行器的实现</strong>两部分组成，两者相互解耦。接口层定义了执行器的抽象 Api，提供投递任务的接口。而实现层则负责实际的任务执行，根据实现类型的不同有不一样的表现。AimRT 官方提供了几种执行器，例如基于 Asio 的线程池、基于 Tbb 的无锁线程池、基于时间轮的定时执行器等。</p>
<p>开发者使用 AimRT 的执行器功能时，在业务层将任务打包成一个闭包，然后调用接口层的 API，将任务投递到具体的执行器内，而执行器会根据自己的调度策略，在一定时机执行投递过来的任务。具体逻辑流程如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2025/05/18/AimRT/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/AimRT%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91.png" alt="AimRT执行逻辑"></p>
<h1 id="HelloWorld示例"><a href="#HelloWorld示例" class="headerlink" title="HelloWorld示例"></a>HelloWorld示例</h1><p><span id="20250402154912-h5xyvvd" style="display: none;"></span>官方仓库：<a target="_blank" rel="noopener" href="https://github.com/AimRT/AimRT/blob/main/src/examples/cpp/helloworld">helloworld</a></p>
<h2 id="配置文件（configuration-helloworld-yaml​-）"><a href="#配置文件（configuration-helloworld-yaml​-）" class="headerlink" title="配置文件（configuration_helloworld.yaml​ ）"></a>配置文件（<code>configuration_helloworld.yaml</code>​ ）</h2><p><span id="20250402155159-hybss8y" style="display: none;"></span>依据官方示例项目结构自行编写YAML配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础信息</span></span><br><span class="line">base_info:</span><br><span class="line">  project_name: helloworld  <span class="comment"># 项目名称</span></span><br><span class="line">  build_mode_tags: [<span class="string">&quot;EXAMPLE&quot;</span>, <span class="string">&quot;SIMULATION&quot;</span>, <span class="string">&quot;TEST_CAMERA&quot;</span>]  <span class="comment"># 构建模式标签</span></span><br><span class="line">  aimrt_import_options:  <span class="comment"># AimRT框架的构建选项</span></span><br><span class="line">    AIMRT_BUILD_TESTS: <span class="string">&quot;OFF&quot;</span>  <span class="comment"># 是否构建测试代码</span></span><br><span class="line">    AIMRT_BUILD_EXAMPLES: <span class="string">&quot;ON&quot;</span>  <span class="comment"># 是否构建示例代码</span></span><br><span class="line">    AIMRT_BUILD_DOCUMENT: <span class="string">&quot;OFF&quot;</span>  <span class="comment"># 是否构建文档</span></span><br><span class="line">    AIMRT_BUILD_RUNTIME: <span class="string">&quot;ON&quot;</span>  <span class="comment"># 是否构建运行时核心</span></span><br><span class="line">    AIMRT_BUILD_CLI_TOOLS: <span class="string">&quot;OFF&quot;</span>  <span class="comment"># 是否构建命令行工具</span></span><br><span class="line">    AIMRT_BUILD_WITH_PROTOBUF: <span class="string">&quot;ON&quot;</span>  <span class="comment"># 是否启用Protobuf支持</span></span><br><span class="line">    AIMRT_USE_LOCAL_PROTOC_COMPILER: <span class="string">&quot;OFF&quot;</span>  <span class="comment"># 是否使用本地protoc编译器</span></span><br><span class="line">    AIMRT_BUILD_WITH_ROS2: <span class="string">&quot;OFF&quot;</span>  <span class="comment"># 是否集成ROS2支持</span></span><br><span class="line">    AIMRT_BUILD_NET_PLUGIN: <span class="string">&quot;OFF&quot;</span>  <span class="comment"># 是否构建网络插件</span></span><br><span class="line">    AIMRT_BUILD_ROS2_PLUGIN: <span class="string">&quot;OFF&quot;</span>  <span class="comment"># 是否构建ROS2插件</span></span><br><span class="line">    <span class="comment"># ...  # 其他插件选项（MQTT、Zenoh等）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块  会生成 ./helloworld/src/module/helloworld_module/helloworld_module.h</span></span><br><span class="line">modules:</span><br><span class="line">  - name: HelloWorld_module  <span class="comment"># 自定义模块名称，同时会据此生成module的类名</span></span><br><span class="line">  <span class="comment">#   build_mode_tag: [&quot;EXAMPLE&quot;]  # 可选：指定模块的构建标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pkg   会生成 ./helloworld/src/pkg/helloworld_pkg/pkg_main.cc</span></span><br><span class="line">pkgs:</span><br><span class="line">  - name: HelloWorld_pkg  <span class="comment"># 包名</span></span><br><span class="line">    modules:</span><br><span class="line">      - name: HelloWorld_module  <span class="comment"># 包含的模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署  会生成 ./helloworld/src/install 目录及相应的启动脚本、配置文件</span></span><br><span class="line">deploy_modes:</span><br><span class="line">  - name: local_deploy  <span class="comment"># 部署模式名称</span></span><br><span class="line">    deploy_ins: <span class="comment"># 部署实例</span></span><br><span class="line">      - name: local_ins_helloworld  <span class="comment"># 实例名称</span></span><br><span class="line">        pkgs:</span><br><span class="line">          - name: HelloWorld_pkg  <span class="comment"># 实例加载的包</span></span><br></pre></td></tr></table></figure>

<p>运行<code>aimrt_cli</code>​工具，生成脚手架代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aimrt_cli gen -p configuration_helloworld.yaml -o helloworld</span><br></pre></td></tr></table></figure>

<h2 id="module目录"><a href="#module目录" class="headerlink" title="module目录"></a>module目录</h2><h3 id="HelloWorld-module"><a href="#HelloWorld-module" class="headerlink" title="HelloWorld_module"></a>HelloWorld_module</h3><p>完整代码查看<a href="#20250402154912-h5xyvvd">官方仓库</a>，这里只讨论核心逻辑，建议对照源码阅读。</p>
<h4 id="模块定义（helloworld-module-h​）"><a href="#模块定义（helloworld-module-h​）" class="headerlink" title="模块定义（helloworld_module.h​）"></a>模块定义（<code>helloworld_module.h</code>​）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HelloworldModule</span> : <span class="keyword">public</span> aimrt::ModuleBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// 必须实现的三大生命周期方法</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Initialize</span><span class="params">(aimrt::CoreRef core)</span> <span class="keyword">override</span></span>;  <span class="comment">// 初始化配置</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Start</span><span class="params">()</span> <span class="keyword">override</span></span>;                         <span class="comment">// 业务逻辑入口</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span> <span class="keyword">override</span></span>;                      <span class="comment">// 资源释放</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  aimrt::CoreRef core_;  <span class="comment">// 框架核心句柄</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="模块实现（helloworld-module-cc​）"><a href="#模块实现（helloworld-module-cc​）" class="headerlink" title="模块实现（helloworld_module.cc​）"></a>模块实现（<code>helloworld_module.cc</code>​）</h4><h5 id="初始化阶段"><a href="#初始化阶段" class="headerlink" title="初始化阶段"></a>初始化阶段</h5><p>AimRT会在这一过程初始化自己的资源、例如日志、通信等模块。</p>
<p>官方文档提到：<em>需要注意的是，AimRT 的Initialize阶段仅仅是 AimRT 框架自身的初始化阶段，可能只是整个服务初始化阶段的一部分。使用者可能还需要在 AimRT 的Start阶段先初始化自己的一些业务逻辑，比如检查上下游资源、进行一些配置等，然后再真正的进入整个服务的运行阶段。</em></p>
<p>思考能否将自己的一些资源获取相关的业务逻辑也放在这一阶段（似乎没必要）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">HelloworldModule::Initialize</span><span class="params">(aimrt::CoreRef core)</span> </span>&#123;</span><br><span class="line">  core_ = core;  <span class="comment">// 绑定框架核心</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 读取 YAML 配置示例</span></span><br><span class="line">  <span class="keyword">auto</span> cfg_path = core_.<span class="built_in">GetConfigurator</span>().<span class="built_in">GetConfigFilePath</span>();</span><br><span class="line">  YAML::Node cfg = YAML::<span class="built_in">LoadFile</span>(cfg_path);</span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;Loaded config: &#123;&#125;&quot;</span>, cfg[<span class="string">&quot;param&quot;</span>].<span class="built_in">as</span>&lt;std::string&gt;());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// 初始化成功标志</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="运行阶段"><a href="#运行阶段" class="headerlink" title="运行阶段"></a>运行阶段</h5><p>初始化结束后，AimRT就会调用<code>Start</code>​进入运行阶段，执行开发人员自己的业务逻辑。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;Module Started&quot;</span>);  <span class="comment">// 日志输出演示</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="停止阶段"><a href="#停止阶段" class="headerlink" title="停止阶段"></a>停止阶段</h5><p>AimRT 收到停止信号后会调用<code>Shutdown</code>​方法，进行资源释放等操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">void <span class="function"><span class="title">Shutdown</span></span>() &#123;</span><br><span class="line">  AIMRT_INFO(<span class="string">&quot;Cleanup resources&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有的业务逻辑我们都会在Module类中进行实现，具体加载运行方式会由AimRT根据配置文件进行集成</p>
<h2 id="Pkg目录"><a href="#Pkg目录" class="headerlink" title="Pkg目录"></a>Pkg目录</h2><h3 id="Pkg模式集成（pkg-main-cc）"><a href="#Pkg模式集成（pkg-main-cc）" class="headerlink" title="Pkg模式集成（pkg_main.cc）"></a>Pkg模式集成（pkg_main.cc）</h3><p>AimRT 提供的 <code>aimrt_main</code>​ 可执行程序，在运行时会根据配置文件加载 <strong>动态库</strong> 形式的 Pkg，并导入其中的 Module 类。加载后，框架会自动调用 <code>Initialize</code>​ 进行初始化，随后执行 <code>Start</code>​ 启动模块。</p>
<p>具体流程可参考 <code>aimrt_main</code>​ 源码：<a target="_blank" rel="noopener" href="https://github.com/AimRT/AimRT/blob/v0.8.x/src/runtime/main/main.cc">aimrt_main主函数代码</a></p>
<h3 id="注册表定义"><a href="#注册表定义" class="headerlink" title="注册表定义"></a>注册表定义</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> std::tuple&lt;std::string_view, FactoryFunc&gt;</span><br><span class="line">    aimrt_module_register_array[] = &#123;</span><br><span class="line">  &#123;<span class="string">&quot;HelloWorldModule&quot;</span>,  <span class="comment">// 模块标识名</span></span><br><span class="line">   []() &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">HelloWorldModule</span>(); &#125;&#125;  <span class="comment">// 工厂函数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>模块名称</strong>：用于标识 <code>HelloWorldModule</code>​，框架会通过它查找模块。</li>
<li><strong>工厂函数</strong>：返回 <code>HelloWorldModule</code>​ 的实例，供 AimRT 运行时调用。</li>
</ul>
<h3 id="注册宏"><a href="#注册宏" class="headerlink" title="注册宏"></a>注册宏</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AIMRT_PKG_MAIN</span>(aimrt_module_register_array)  <span class="comment">// 框架入口宏</span></span><br></pre></td></tr></table></figure>

<p><strong>​<code>AIMRT_PKG_MAIN</code>​</strong>​ <strong>宏展开后，会生成 4 个 C 接口函数，供</strong> <strong>​<code>aimrt_main</code>​</strong>​ <strong>调用：</strong></p>
<ul>
<li><code>AimRTDynlibGetModuleNum()</code>​：获取当前动态库中的模块数量。</li>
<li><code>AimRTDynlibGetModuleNameList()</code>​：获取所有可用的模块名称。</li>
<li><code>AimRTDynlibCreateModule()</code>​：根据模块名称创建模块实例。</li>
<li><code>AimRTDynlibDestroyModule()</code>​：销毁模块实例，释放资源。</li>
</ul>
<h3 id="加载运行"><a href="#加载运行" class="headerlink" title="加载运行"></a>加载运行</h3><p>运行 <code>build</code>​ 目录下的 <code>start_local_deploy_local_ins_helloworld.sh</code>​ 启动进程。</p>
<blockquote>
<p><strong>脚本名称</strong> 由创建工程时的((20250401152311-auw052s “配置文件”))自动生成。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这是启动脚本的具体内容</span></span><br><span class="line">./aimrt_main --cfg_file_path=./cfg/local_deploy_local_ins_helloworld_cfg.yaml</span><br></pre></td></tr></table></figure>

<p><strong>运行流程：</strong></p>
<ol>
<li><strong>解析配置文件</strong>，查找需要加载的模块名称。</li>
<li><strong>在注册表中匹配模块名</strong>，调用对应的工厂函数创建实例。</li>
<li><strong>依次执行</strong> <strong>​<code>Initialize()</code>​</strong> ​ <strong>和</strong> <strong>​<code>Start()</code>​</strong> ​，完成模块启动。</li>
</ol>
<h2 id="App目录"><a href="#App目录" class="headerlink" title="App目录"></a>App目录</h2><p>**App模式官网概念：*<em>​</em>开发者在自己的 Main 函数中注册&#x2F;创建各个模块，编译时直接将业务逻辑编译进主程序；*</p>
<p>可以简单理解为我们手动实现了<code>aimrt_main</code>​启动逻辑，分别有两种实现方式：<a target="_blank" rel="noopener" href="https://docs.aimrt.org/v0.10.0/tutorials/interface_cpp/runtime.html#app">创建模块</a> 和 <a target="_blank" rel="noopener" href="https://docs.aimrt.org/v0.10.0/tutorials/interface_cpp/runtime.html#id3">注册模块</a></p>
<h3 id="核心接口"><a href="#核心接口" class="headerlink" title="核心接口"></a>核心接口</h3><p>需要在CMake中引用相关库：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="function">Set link libraries of target</span></span><br><span class="line"><span class="function"><span class="title">target_link_libraries</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  $&#123;CUR_TARGET_NAME&#125;</span></span></span><br><span class="line"><span class="params"><span class="function">  PRIVATE gflags::gflags</span></span></span><br><span class="line"><span class="params"><span class="function">          aimrt::runtime::core)</span></span></span><br></pre></td></tr></table></figure>

<p>此时即可使用 <code>core/aimrt_core.h</code>​ 文件中的<code>aimrt::runtime::core::AimRTCore</code>​类，核心接口如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> aimrt::runtime::core &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AimRTCore</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Options</span> &#123;</span><br><span class="line">    std::string cfg_file_path;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Initialize</span><span class="params">(<span class="type">const</span> Options&amp; options)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Start</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function">std::future&lt;<span class="type">void</span>&gt; <span class="title">AsyncStart</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">module</span>::ModuleManager&amp; <span class="title">GetModuleManager</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace aimrt::runtime::core</span></span><br></pre></td></tr></table></figure>

<p>接口使用说明如下：</p>
<ul>
<li><p><code>void Initialize(const Options&amp; options)</code>​：用于初始化框架。</p>
<ul>
<li>接收一个<code>AimRTCore::Options</code>​作为初始化参数。其中最重要的项是<code>cfg_file_path</code>​，用于设置配置文件路径。</li>
<li>如果初始化失败，会抛出一个异常。</li>
</ul>
</li>
<li><p><code>void Start()</code>​：启动框架。</p>
<ul>
<li>如果启动失败，会抛出一个异常。</li>
<li>必须在 Initialize 方法之后调用，否则行为未定义。</li>
<li>如果启动成功，会阻塞当前线程，并将当前线程作为本<code>AimRTCore</code>​实例的主线程。</li>
</ul>
</li>
<li><p><code>std::future&lt;void&gt; AsyncStart()</code>​：异步启动框架。</p>
<ul>
<li>如果启动失败，会抛出一个异常。</li>
<li>必须在 Initialize 方法之后调用，否则行为未定义。</li>
<li>如果启动成功，会返回一个<code>std::future&lt;void&gt;</code>​句柄，需要在调用 <code>Shutdown</code>​ 方法后调用该句柄的 <code>wait</code>​ 方法阻塞等待结束。</li>
<li>该方法会在内部新启动一个线程作为本<code>AimRTCore</code>​实例的主线程</li>
<li>阅读函数源码可以发现，创建的<strong>后台线程</strong>的<strong>唯一作用</strong>就是<strong>等待 shutdown 信号，并执行清理工作</strong>。</li>
</ul>
</li>
<li><p><code>void Shutdown()</code>​：停止框架。</p>
<ul>
<li>可以在任意线程、任意阶段调用此方法，也可以调用任意次数。</li>
<li>调用此方法后，<code>Start</code>​方法将在执行完主线程中的所有任务后，退出阻塞。</li>
<li>需要注意，有时候业务会阻塞住主线程中的任务，导致<code>Start</code>​方法无法退出阻塞、优雅结束整个框架，此时需要在外部强制 kill。</li>
</ul>
</li>
</ul>
<h3 id="注册模块（helloworld-app-registration-mode​）（推荐方案）"><a href="#注册模块（helloworld-app-registration-mode​）（推荐方案）" class="headerlink" title="注册模块（helloworld_app_registration_mode​）（推荐方案）"></a>注册模块（<code>helloworld_app_registration_mode</code>​）（推荐方案）</h3><p>通过<code>RegisterModule</code>​可以直接注册一个标准模块。开发者需要先实现一个继承于<code>ModuleBase</code>​基类的<code>Module</code>​，然后在<code>AimRTCor</code>​e实例调用<code>Initialize</code>​方法之前注册该<code>Module</code>​实例，在此方式下仍然有一个比较清晰的<code>Module</code>​边界。</p>
<p>参考代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;csignal&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;HelloWorld_module/HelloWorld_module.h&quot;</span>	<span class="comment">// 这里引用的是我们之前创建的Module类</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;core/aimrt_core.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> aimrt::runtime::core;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> helloworld::HelloWorld_module;</span><br><span class="line"></span><br><span class="line">AimRTCore* global_core_ptr = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SignalHandler</span><span class="params">(<span class="type">int</span> sig)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (global_core_ptr &amp;&amp; (sig == SIGINT || sig == SIGTERM)) &#123;</span><br><span class="line">    global_core_ptr-&gt;<span class="built_in">Shutdown</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">raise</span>(sig);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">main</span><span class="params">(<span class="type">int32_t</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">signal</span>(SIGINT, SignalHandler);</span><br><span class="line">  <span class="built_in">signal</span>(SIGTERM, SignalHandler);</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;AimRT start.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    AimRTCore core;</span><br><span class="line">    global_core_ptr = &amp;core;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// register module</span></span><br><span class="line">    HelloworldModule helloworld_module;</span><br><span class="line">    core.<span class="built_in">GetModuleManager</span>().<span class="built_in">RegisterModule</span>(helloworld_module.<span class="built_in">NativeHandle</span>());</span><br><span class="line"></span><br><span class="line">    AimRTCore::Options options;</span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) options.cfg_file_path = argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    core.<span class="built_in">Initialize</span>(options);</span><br><span class="line"></span><br><span class="line">    core.<span class="built_in">Start</span>();</span><br><span class="line"></span><br><span class="line">    core.<span class="built_in">Shutdown</span>();</span><br><span class="line"></span><br><span class="line">    global_core_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;AimRT run with exception and exit. &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;AimRT exit.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过下面的命令启动编译后的可执行文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./helloworld_app_registration_mode ./cfg/examples_cpp_helloworld_app_mode_cfg.yaml</span><br></pre></td></tr></table></figure>

<h3 id="创建模块（-​helloworld-app​）"><a href="#创建模块（-​helloworld-app​）" class="headerlink" title="**创建模块（**​helloworld_app​）"></a>**创建模块（**​<code>helloworld_app</code>​）</h3><p>在<code>AimRTCore</code>​实例调用Initialize方法之后，通过<code>CreateModule</code>​可以创建一个模块，并返回一个<code>aimrt::CoreRef</code>​句柄，开发者可以直接基于此句柄调用一些框架的方法，比如 <strong>RPC</strong> 或者 <strong>Log</strong> 等。在此方式下没有一个比较清晰的<code>Module</code>​边界，不利于大型项目的组织，一般仅用于快速做一些小工具。</p>
<p>参考代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2023, AgiBot Inc.</span></span><br><span class="line"><span class="comment">// All rights reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;csignal&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/core.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;core/aimrt_core.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> aimrt::runtime::core;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局指针，指向 AimRTCore 实例，用于在信号处理函数中进行关闭操作</span></span><br><span class="line">AimRTCore* global_core_ptr = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 信号处理函数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 处理 SIGINT (Ctrl+C) 和 SIGTERM 信号，如果 AimRTCore 实例存在，则调用其</span></span><br><span class="line"><span class="comment"> * Shutdown 方法进行关闭。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SignalHandler</span><span class="params">(<span class="type">int</span> sig)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (global_core_ptr &amp;&amp; (sig == SIGINT || sig == SIGTERM)) &#123;</span><br><span class="line">    global_core_ptr-&gt;<span class="built_in">Shutdown</span>();  <span class="comment">// 调用 Shutdown 方法，优雅退出</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">raise</span>(sig);  <span class="comment">// 传递其他信号，按照默认行为处理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">main</span><span class="params">(<span class="type">int32_t</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注册信号处理函数，确保进程收到终止信号时能正确清理资源</span></span><br><span class="line">  <span class="built_in">signal</span>(SIGINT, SignalHandler);</span><br><span class="line">  <span class="built_in">signal</span>(SIGTERM, SignalHandler);</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;AimRT 启动.&quot;</span> &lt;&lt; std::endl;  <span class="comment">// 日志：AimRT 启动</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    AimRTCore core;</span><br><span class="line">    global_core_ptr = &amp;core;  <span class="comment">// 赋值全局指针，以便信号处理时可以访问</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置 AimRTCore 选项</span></span><br><span class="line">    AimRTCore::Options options;</span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>)</span><br><span class="line">      options.cfg_file_path =</span><br><span class="line">          argv[<span class="number">1</span>];  <span class="comment">// 如果传入了参数，则使用该参数作为配置文件路径</span></span><br><span class="line"></span><br><span class="line">    core.<span class="built_in">Initialize</span>(options);  <span class="comment">// 初始化 AimRTCore 实例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 AimRT 模块，并获取模块句柄</span></span><br><span class="line">    <span class="function">aimrt::CoreRef <span class="title">module_handle</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        core.GetModuleManager().CreateModule(<span class="string">&quot;HelloWorldModule&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录日志，表示模块创建成功</span></span><br><span class="line">    <span class="built_in">AIMRT_HL_INFO</span>(module_handle.<span class="built_in">GetLogger</span>(), <span class="string">&quot;这是一个示例日志。&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取并解析 YAML 配置文件</span></span><br><span class="line">    <span class="keyword">auto</span> file_path = module_handle.<span class="built_in">GetConfigurator</span>().<span class="built_in">GetConfigFilePath</span>();</span><br><span class="line">    <span class="keyword">if</span> (!file_path.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">      YAML::Node cfg_node = YAML::<span class="built_in">LoadFile</span>(std::<span class="built_in">string</span>(file_path));</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; itr : cfg_node) &#123;</span><br><span class="line">        std::string k = itr.first.<span class="built_in">as</span>&lt;std::string&gt;();</span><br><span class="line">        std::string v = itr.second.<span class="built_in">as</span>&lt;std::string&gt;();</span><br><span class="line">        <span class="built_in">AIMRT_HL_INFO</span>(module_handle.<span class="built_in">GetLogger</span>(), <span class="string">&quot;cfg [&#123;&#125; : &#123;&#125;]&quot;</span>, k, v);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步启动 AimRT 实例，返回一个 future 对象</span></span><br><span class="line">    <span class="keyword">auto</span> fu = core.<span class="built_in">AsyncStart</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AIMRT_HL_INFO</span>(module_handle.<span class="built_in">GetLogger</span>(), <span class="string">&quot;启动成功。&quot;</span>);</span><br><span class="line">    <span class="comment">// 日志：启动成功。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待 AimRT 运行结束（即 shutdown 触发）</span></span><br><span class="line">    fu.<span class="built_in">wait</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭 AimRT 实例</span></span><br><span class="line">    core.<span class="built_in">Shutdown</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清空全局指针，避免悬空指针问题</span></span><br><span class="line">    global_core_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;AimRT 运行时发生异常，退出: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;AimRT 退出.&quot;</span> &lt;&lt; std::endl;  <span class="comment">// 日志：AimRT 退出</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过下面的命令启动编译后的可执行文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./helloworld_app_registration_mode ./cfg/examples_cpp_helloworld_app_mode_cfg.yaml</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Executor示例"><a href="#Executor示例" class="headerlink" title="Executor示例"></a>Executor示例</h1><p>官方仓库：<a target="_blank" rel="noopener" href="https://github.com/AimRT/AimRT/blob/main/src/examples/cpp/executor">executor</a></p>
<h2 id="配置文件（configuration-executor-yaml​）"><a href="#配置文件（configuration-executor-yaml​）" class="headerlink" title="配置文件（configuration_executor.yaml​）"></a>配置文件（<code>configuration_executor.yaml</code>​）</h2><p>依据官方示例项目结构自行编写YAML配置文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># 基础信息</span><br><span class="line">base_info:</span><br><span class="line">  project_name: Logger # 项目名称</span><br><span class="line">  build_mode_tags: [<span class="string">&quot;EXAMPLE&quot;</span>, <span class="string">&quot;SIMULATION&quot;</span>, <span class="string">&quot;TEST_CAMERA&quot;</span>] # 构建模式标签</span><br><span class="line">  aimrt_import_options: # AimRT框架的构建选项</span><br><span class="line">    AIMRT_BUILD_TESTS: <span class="string">&quot;OFF&quot;</span> # 是否构建测试代码</span><br><span class="line">    AIMRT_BUILD_EXAMPLES: <span class="string">&quot;ON&quot;</span> # 是否构建示例代码</span><br><span class="line">    AIMRT_BUILD_DOCUMENT: <span class="string">&quot;OFF&quot;</span> # 是否构建文档</span><br><span class="line">    AIMRT_BUILD_RUNTIME: <span class="string">&quot;ON&quot;</span> # 是否构建运行时核心</span><br><span class="line">    AIMRT_BUILD_CLI_TOOLS: <span class="string">&quot;OFF&quot;</span> # 是否构建命令行工具</span><br><span class="line">    AIMRT_BUILD_WITH_PROTOBUF: <span class="string">&quot;ON&quot;</span> # 是否启用Protobuf支持</span><br><span class="line">    AIMRT_USE_LOCAL_PROTOC_COMPILER: <span class="string">&quot;OFF&quot;</span> # 是否使用本地protoc编译器</span><br><span class="line">    AIMRT_BUILD_WITH_ROS2: <span class="string">&quot;OFF&quot;</span> # 是否集成ROS2支持</span><br><span class="line">    AIMRT_BUILD_NET_PLUGIN: <span class="string">&quot;OFF&quot;</span> # 是否构建网络插件</span><br><span class="line">    AIMRT_BUILD_ROS2_PLUGIN: <span class="string">&quot;OFF&quot;</span> # 是否构建ROS2插件</span><br><span class="line"></span><br><span class="line"># 模块</span><br><span class="line">modules:</span><br><span class="line">  - name: executor_module # 最基本的 cpp executor 示例</span><br><span class="line">  - name: executor_co_module # 基于协程接口使用 executor 功能的示例</span><br><span class="line">  - name: executor_co_loop_module # 基于协程接口使用 executor 功能实现定时循环的示例</span><br><span class="line">  - name: real_time_module <span class="meta">#  executor 实时性相关功能的示例</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># pkg</span></span><br><span class="line">pkgs:</span><br><span class="line">  - name: executor_pkg # 包名</span><br><span class="line">    modules:</span><br><span class="line">      - name: executor_module</span><br><span class="line">      - name: executor_co_module</span><br><span class="line">      - name: executor_co_loop_module</span><br><span class="line">      - name: real_time_module</span><br><span class="line"></span><br><span class="line"># 部署</span><br><span class="line">deploy_modes:</span><br><span class="line">  - name: local_deploy # 部署模式名称</span><br><span class="line">    deploy_ins: # 部署实例</span><br><span class="line">      - name: local_ins_executor # 实例名称</span><br><span class="line">        pkgs:</span><br><span class="line">          - name: executor_pkg # 实例加载的包</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行<code>aimrt_clt</code>​工具生成脚手架代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aimrt_cli gen -p configuration_executor.yaml -o executor</span><br></pre></td></tr></table></figure>

<h2 id="module目录-1"><a href="#module目录-1" class="headerlink" title="module目录"></a>module目录</h2><h3 id="executor-module"><a href="#executor-module" class="headerlink" title="executor_module"></a>executor_module</h3><p>一个最基本的 cpp executor 示例，演示内容包括：</p>
<ul>
<li>如何获取执行器；</li>
<li>如何投递任务到执行器中执行；</li>
<li>如何使用<strong>线程安全型</strong>执行器；</li>
<li>如何投递定时任务到执行器中；</li>
</ul>
<p>说明：</p>
<ul>
<li><p>此示例创建了一个 <code>ExecutorModule</code>​，会在<code>Initialize</code>​时获取以下三种执行器：</p>
<ul>
<li>名称为<code>work_executor</code>​的普通执行器；</li>
<li>名称为<code>thread_safe_executor</code>​的线程安全型执行器；</li>
<li>名称为<code>time_schedule_executor</code>​的支持定时任务的执行器；</li>
</ul>
</li>
<li><p><code>ExecutorModule</code>​模块在 <code>Start</code>​ 阶段会依次使用获取的执行器运行具体的逻辑任务：</p>
<ul>
<li><code>work_executor</code>​：投递一个简单的任务到其中执行；</li>
<li><code>thread_safe_executor</code>​：向该执行器中一次性投递 10000 个任务，用于递增一个整数 n，并在最终打印出 n 的值，由于执行器是线程安全，故 n 最终值还是 10000；</li>
<li><code>time_schedule_executor</code>​：通过该执行器实现了一个间隔 1s 的定时循环；</li>
</ul>
</li>
<li><p>此示例将 <code>ExecutorModule</code>​ 集成到 <code>executor_pkg</code>​ 中，并在配置文件中加载此 Pkg；</p>
</li>
</ul>
<h4 id="模块定义（executor-module-h​）"><a href="#模块定义（executor-module-h​）" class="headerlink" title="模块定义（executor_module.h​）"></a>模块定义（<code>executor_module.h</code>​）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/module_base.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Executor::executor_module &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行器模块类，继承自模块基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExecutorModule</span> : <span class="keyword">public</span> aimrt::ModuleBase &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">ExecutorModule</span>() = <span class="keyword">default</span>;</span><br><span class="line">  ~<span class="built_in">ExecutorModule</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取模块信息</span></span><br><span class="line">  <span class="function">aimrt::ModuleInfo <span class="title">Info</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> aimrt::ModuleInfo&#123;.name = <span class="string">&quot;ExecutorModule&quot;</span>&#125;;</span><br><span class="line">  &#125;  <span class="comment">// 复制官方代码过来后需要添加命名空间  aimrt</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化模块</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Initialize</span><span class="params">(aimrt::CoreRef aimrt_ptr)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动模块</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Start</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关闭模块</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// 获取日志记录器</span></span><br><span class="line">  <span class="function"><span class="keyword">auto</span> <span class="title">GetLogger</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> core_.<span class="built_in">GetLogger</span>(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 简单执行演示</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">SimpleExecuteDemo</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">// 线程安全演示</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">ThreadSafeDemo</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">// 时间调度演示</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">TimeScheduleDemo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  aimrt::CoreRef core_;  <span class="comment">// AIMRT框架核心引用</span></span><br><span class="line"></span><br><span class="line">  aimrt::executor::ExecutorRef work_executor_;         <span class="comment">// 普通执行器</span></span><br><span class="line">  aimrt::executor::ExecutorRef thread_safe_executor_;  <span class="comment">// 线程安全执行器</span></span><br><span class="line"></span><br><span class="line">  std::atomic_bool run_flag_ = <span class="literal">true</span>;                     <span class="comment">// 运行标志(原子变量)</span></span><br><span class="line">  <span class="type">uint32_t</span> loop_count_ = <span class="number">0</span>;                              <span class="comment">// 循环计数器</span></span><br><span class="line">  aimrt::executor::ExecutorRef time_schedule_executor_;  <span class="comment">// 时间调度执行器</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace Executor::executor_module</span></span><br></pre></td></tr></table></figure>

<p>这里主要是定义了几个AimRT的执行器句柄和会用到的变量</p>
<h4 id="模块实现（executor-module-cc​）"><a href="#模块实现（executor-module-cc​）" class="headerlink" title="模块实现（executor_module.cc​）"></a>模块实现（<code>executor_module.cc</code>​）</h4><h5 id="初始化阶段-1"><a href="#初始化阶段-1" class="headerlink" title="初始化阶段"></a>初始化阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化模块</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ExecutorModule::Initialize</span><span class="params">(aimrt::CoreRef core)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 保存AIMRT框架句柄</span></span><br><span class="line">  core_ = core;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取工作执行器</span></span><br><span class="line">  work_executor_ = core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;work_executor&quot;</span>);</span><br><span class="line">  <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(work_executor_, <span class="string">&quot;无法获取工作执行器(work_executor)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取线程安全执行器</span></span><br><span class="line">  thread_safe_executor_ =</span><br><span class="line">      core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;thread_safe_executor&quot;</span>);</span><br><span class="line">  <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(</span><br><span class="line">      thread_safe_executor_ &amp;&amp; thread_safe_executor_.<span class="built_in">ThreadSafe</span>(),</span><br><span class="line">      <span class="string">&quot;无法获取线程安全执行器(thread_safe_executor)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取时间调度执行器</span></span><br><span class="line">  time_schedule_executor_ =</span><br><span class="line">      core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;time_schedule_executor&quot;</span>);</span><br><span class="line">  <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(</span><br><span class="line">      time_schedule_executor_ &amp;&amp; time_schedule_executor_.<span class="built_in">SupportTimerSchedule</span>(),</span><br><span class="line">      <span class="string">&quot;无法获取时间调度执行器(time_schedule_executor)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;初始化成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要操作是根据名称获取执行器，执行器名称会在启动时由config.yaml文件确定，例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">executor:</span><br><span class="line">  executors:</span><br><span class="line">    - name: work_executor # 执行器名称</span><br><span class="line">      type: asio_thread # 执行器类型：基于 ASIO 的线程池，</span><br><span class="line">      options:</span><br><span class="line">        thread_num: <span class="number">2</span> # 分配的线程数量，用于并发处理任务</span><br><span class="line"></span><br><span class="line">    - name: thread_safe_executor # 线程安全执行器：通过 ASIO Strand 实现串行执行，避免竞态条件</span><br><span class="line">      type: asio_strand # 执行器类型：基于 ASIO 的 strand 包装，确保线程安全</span><br><span class="line">      options:</span><br><span class="line">        bind_asio_thread_executor_name: work_executor # 绑定的基础执行器，实际任务由其线程池调度执行</span><br><span class="line"></span><br><span class="line">    - name: time_schedule_executor # 定时任务执行器：用于周期性/定时调度任务</span><br><span class="line">      type: asio_thread # 执行器类型：使用独立的 ASIO 线程池执行定时任务</span><br><span class="line">      options:</span><br><span class="line">        thread_num: <span class="number">2</span> # 分配的线程数量，可根据定时任务复杂度调整</span><br></pre></td></tr></table></figure>

<h5 id="运行阶段-1"><a href="#运行阶段-1" class="headerlink" title="运行阶段"></a>运行阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动模块</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ExecutorModule::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 测试简单执行</span></span><br><span class="line">  <span class="built_in">SimpleExecuteDemo</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 测试线程安全执行</span></span><br><span class="line">  <span class="built_in">ThreadSafeDemo</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 测试时间调度执行</span></span><br><span class="line">  <span class="built_in">TimeScheduleDemo</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;启动成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 任务函数实现</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 简单执行演示</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecutorModule::SimpleExecuteDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  work_executor_.<span class="built_in">Execute</span>([<span class="keyword">this</span>]() &#123; <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;这是一个简单任务&quot;</span>); &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程安全演示</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecutorModule::ThreadSafeDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> n = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint32_t</span> ii = <span class="number">0</span>; ii &lt; <span class="number">10000</span>; ++ii) &#123;</span><br><span class="line">    thread_safe_executor_.<span class="built_in">Execute</span>([&amp;n]() &#123; n++; &#125;);  <span class="comment">// 线程安全执行器</span></span><br><span class="line">    <span class="comment">// work_executor_.Execute([&amp;n]() &#123; n++; &#125;); // 普通执行器</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));  <span class="comment">// 等待1秒</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;n的值为: &#123;&#125;&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间调度演示</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecutorModule::TimeScheduleDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!run_flag_) <span class="keyword">return</span>;  <span class="comment">// 检查运行标志</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;循环计数: &#123;&#125;&quot;</span>, loop_count_++);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1秒后再次执行本函数</span></span><br><span class="line">  time_schedule_executor_.<span class="built_in">ExecuteAfter</span>(</span><br><span class="line">      std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>),</span><br><span class="line">      std::<span class="built_in">bind</span>(&amp;ExecutorModule::TimeScheduleDemo, <span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过调用执行器句柄的<code>Execute</code>​或者<code>ExecuteAfter</code>​向执行器中投递任务</p>
<h5 id="停止阶段-1"><a href="#停止阶段-1" class="headerlink" title="停止阶段"></a>停止阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭模块</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecutorModule::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  run_flag_ = <span class="literal">false</span>;  <span class="comment">// 设置运行标志为false</span></span><br><span class="line"></span><br><span class="line">  std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));  <span class="comment">// 等待1秒</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;关闭成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将<code>run_flag_</code>​变量置false，用于控制定时器执行器的任务停止。</p>
<h4 id="对应的启动配置文件"><a href="#对应的启动配置文件" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># <span class="built_in">Copyright</span> (c) <span class="number">2023</span>, AgiBot Inc.</span><br><span class="line"># All rights reserved.</span><br><span class="line"></span><br><span class="line">aimrt:</span><br><span class="line">  log:</span><br><span class="line">    core_lvl: INFO # Trace/Debug/Info/Warn/Error/Fatal/Off</span><br><span class="line">    backends:</span><br><span class="line">      - type: console</span><br><span class="line">  executor:</span><br><span class="line">    executors:</span><br><span class="line">      - name: work_executor</span><br><span class="line">        type: asio_thread</span><br><span class="line">        options:</span><br><span class="line">          thread_num: <span class="number">2</span></span><br><span class="line">      - name: thread_safe_executor</span><br><span class="line">        type: asio_strand</span><br><span class="line">        options:</span><br><span class="line">          bind_asio_thread_executor_name: work_executor</span><br><span class="line">      - name: time_schedule_executor</span><br><span class="line">        type: asio_thread</span><br><span class="line">        options:</span><br><span class="line">          thread_num: <span class="number">2</span></span><br><span class="line">  <span class="keyword">module</span>:</span><br><span class="line">    pkgs:</span><br><span class="line">      - path: ./libexecutor_pkg.so</span><br><span class="line">        enable_modules: [ExecutorModule]</span><br><span class="line">    modules:</span><br><span class="line">      - name: ExecutorModule</span><br><span class="line">        log_lvl: INFO</span><br></pre></td></tr></table></figure>

<h3 id="executor-co-module"><a href="#executor-co-module" class="headerlink" title="executor_co_module"></a>executor_co_module</h3><p>一个基于协程接口使用 executor 功能的示例，演示内容包括：</p>
<ul>
<li>如何以协程的方式使用执行器；</li>
</ul>
<h4 id="模块定义（executor-co-module-h​）"><a href="#模块定义（executor-co-module-h​）" class="headerlink" title="模块定义（executor_co_module.h​）"></a>模块定义（<code>executor_co_module.h</code>​）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/co/aimrt_context.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/co/async_scope.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/co/task.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/module_base.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Executor::executor_co_module &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> aimrt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个协程模块，继承自 AimRT 的 ModuleBase 接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExecutorCoModule</span> : <span class="keyword">public</span> aimrt::ModuleBase &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">ExecutorCoModule</span>() = <span class="keyword">default</span>;</span><br><span class="line">  ~<span class="built_in">ExecutorCoModule</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回模块信息</span></span><br><span class="line">  <span class="function">aimrt::ModuleInfo <span class="title">Info</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ModuleInfo&#123;.name = <span class="string">&quot;ExecutorCoModule&quot;</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化模块</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Initialize</span><span class="params">(aimrt::CoreRef aimrt_ptr)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动模块，执行实际的协程逻辑</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Start</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模块关闭逻辑，清理资源</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// 获取日志器</span></span><br><span class="line">  <span class="function"><span class="keyword">auto</span> <span class="title">GetLogger</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> core_.<span class="built_in">GetLogger</span>(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 简单执行器示例：演示普通线程池调度</span></span><br><span class="line">  <span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">SimpleExecuteDemo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 线程安全执行器示例：演示多个任务安全执行</span></span><br><span class="line">  <span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">ThreadSafeDemo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定时执行器示例：定时打印计数</span></span><br><span class="line">  <span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">TimeScheduleDemo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  aimrt::CoreRef core_;  <span class="comment">// 框架核心引用</span></span><br><span class="line"></span><br><span class="line">  co::AimRTContext</span><br><span class="line">      ctx_;  <span class="comment">// 协程上下文对象，可以用来获取某个执行器的&quot;协程封装接口&quot;</span></span><br><span class="line"></span><br><span class="line">  co::AsyncScope</span><br><span class="line">      scope_;  <span class="comment">// 协程作用域，用于启动协程(spawn)和等待协程完成(complete),可以跟踪和管理多个异步协程的生命周期</span></span><br><span class="line"></span><br><span class="line">  std::atomic_bool run_flag_ = <span class="literal">true</span>;  <span class="comment">// 控制定时任务运行的标志位</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace Executor::executor_co_module</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="模块实现（executor-co-module-cc​）"><a href="#模块实现（executor-co-module-cc​）" class="headerlink" title="模块实现（executor_co_module.cc​）"></a>模块实现（<code>executor_co_module.cc</code>​）</h4><h5 id="初始化阶段-2"><a href="#初始化阶段-2" class="headerlink" title="初始化阶段"></a>初始化阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ExecutorCoModule::Initialize</span><span class="params">(aimrt::CoreRef core)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 保存框架核心引用</span></span><br><span class="line">  core_ = core;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建协程上下文对象</span></span><br><span class="line">  ctx_ = co::<span class="built_in">AimRTContext</span>(core_.<span class="built_in">GetExecutorManager</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查普通执行器是否可用</span></span><br><span class="line">  <span class="keyword">auto</span> work_executor = core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;work_executor&quot;</span>);</span><br><span class="line">  <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(work_executor, <span class="string">&quot;无法获取 work_executor 执行器&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查线程安全执行器是否可用</span></span><br><span class="line">  <span class="keyword">auto</span> thread_safe_executor =</span><br><span class="line">      core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;thread_safe_executor&quot;</span>);</span><br><span class="line">  <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(</span><br><span class="line">      thread_safe_executor &amp;&amp; thread_safe_executor.<span class="built_in">ThreadSafe</span>(),</span><br><span class="line">      <span class="string">&quot;无法获取 thread_safe_executor 执行器或不支持线程安全&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查定时执行器是否可用</span></span><br><span class="line">  <span class="keyword">auto</span> time_schedule_executor =</span><br><span class="line">      core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;time_schedule_executor&quot;</span>);</span><br><span class="line">    <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(</span><br><span class="line">        time_schedule_executor &amp;&amp;</span><br><span class="line">        time_schedule_executor.<span class="built_in">SupportTimerSchedule</span>(), <span class="string">&quot;无法获取</span></span><br><span class="line"><span class="string">        time_schedule_executor 执行器或不支持定时调度&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化成功</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块初始化成功。&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注意这里获取的三个执行器，只是用来检查是否可用，将错误限制在初始化阶段</li>
</ul>
<h5 id="运行阶段-2"><a href="#运行阶段-2" class="headerlink" title="运行阶段"></a>运行阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ExecutorCoModule::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 启动普通协程任务</span></span><br><span class="line">  scope_.<span class="built_in">spawn</span>(co::<span class="built_in">On</span>(co::<span class="built_in">InlineScheduler</span>(), <span class="built_in">SimpleExecuteDemo</span>()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动线程安全的协程任务</span></span><br><span class="line">  scope_.<span class="built_in">spawn</span>(co::<span class="built_in">On</span>(co::<span class="built_in">InlineScheduler</span>(), <span class="built_in">ThreadSafeDemo</span>()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动定时执行的协程任务</span></span><br><span class="line">  scope_.<span class="built_in">spawn</span>(co::<span class="built_in">On</span>(co::<span class="built_in">InlineScheduler</span>(), <span class="built_in">TimeScheduleDemo</span>()));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块启动成功。&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用三个任务函数</p>
<ul>
<li><code>scope_.spawn(...)</code>​用于向协程<code>scope_</code>​这个协程作用域中启动一个协程任务</li>
<li><code>co::InlineScheduler()</code>​指的是在当前线程执行协程的第一段代码</li>
<li><code>co::On(scheduler, SimpleExecuteDemo())</code>​表示让<code>SimpleExecuteDemo()</code>​协程在 <code>scheduler</code>​ 上开始执行</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">ExecutorCoModule::SimpleExecuteDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 获取 work_executor 的调度器</span></span><br><span class="line">  <span class="keyword">auto</span> work_scheduler = ctx_.<span class="built_in">GetScheduler</span>(<span class="string">&quot;work_executor&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 打印当前协程的线程 ID</span></span><br><span class="line">  std::ostringstream oss1;</span><br><span class="line">  oss1 &lt;&lt; std::this_thread::<span class="built_in">get_id</span>();</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;[SimpleExecuteDemo] 当前协程的线程 ID: &quot;</span> &lt;&lt; oss<span class="number">1.</span><span class="built_in">str</span>()</span><br><span class="line">            &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将当前协程调度到 work_executor 上执行</span></span><br><span class="line">  <span class="function"><span class="keyword">co_await</span> <span class="title">co::Schedule</span><span class="params">(work_scheduler)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 打印切换后的线程 ID</span></span><br><span class="line">  std::ostringstream oss2;</span><br><span class="line">  oss2 &lt;&lt; std::this_thread::<span class="built_in">get_id</span>();</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;[SimpleExecuteDemo] 切换执行器后的线程 ID: &quot;</span> &lt;&lt; oss<span class="number">2.</span><span class="built_in">str</span>()</span><br><span class="line">            &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行任务内容</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;执行普通任务：SimpleExecuteDemo&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">co_return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ctx_.GetScheduler(&quot;work_executor&quot;)</code>​通过执行器名称获取协程封装版本的调度器</li>
<li><code>co_await co::Schedule(work_scheduler)</code>​挂起当前线程，后续让<code>work_scheduler</code>​异步执行后续代码</li>
<li>可以简单添加两个日志打印，观察不同线程执行协程函数的切换效果</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">ExecutorCoModule::ThreadSafeDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 获取 thread_safe_executor 的调度器</span></span><br><span class="line">  <span class="keyword">auto</span> thread_safe_scheduler = ctx_.<span class="built_in">GetScheduler</span>(<span class="string">&quot;thread_safe_executor&quot;</span>);</span><br><span class="line"></span><br><span class="line">  co::AsyncScope scope;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> n = <span class="number">0</span>;  <span class="comment">// 计数器</span></span><br><span class="line">  <span class="keyword">auto</span> task = [&amp;n]() -&gt; co::Task&lt;<span class="type">void</span>&gt; &#123;</span><br><span class="line">    n++;</span><br><span class="line">    <span class="keyword">co_return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动 10000 个线程安全任务</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> ii = <span class="number">0</span>; ii &lt; <span class="number">10000</span>; ++ii) &#123;</span><br><span class="line">    scope.<span class="built_in">spawn</span>(co::<span class="built_in">On</span>(thread_safe_scheduler, <span class="built_in">task</span>()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 等待所有任务执行完毕</span></span><br><span class="line">  <span class="function"><span class="keyword">co_await</span> <span class="title">co::On</span><span class="params">(co::InlineScheduler(), scope.complete())</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出最终计数值</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;线程安全任务已完成，n 的值为 &#123;&#125;&quot;</span>, n);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">co_return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这里的区别是协程内部再启动了10000个异步的协程</p>
</li>
<li><p><code>co::On(co::InlineScheduler(), ...)</code>​让恢复操作 <strong>在当前线程（InlineScheduler）中执行</strong></p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">ExecutorCoModule::TimeScheduleDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;开始定时任务循环。&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 time_schedule_executor 的调度器</span></span><br><span class="line">  <span class="keyword">auto</span> time_scheduler = ctx_.<span class="built_in">GetScheduler</span>(<span class="string">&quot;time_schedule_executor&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 切换协程到定时调度线程池</span></span><br><span class="line">  <span class="function"><span class="keyword">co_await</span> <span class="title">co::Schedule</span><span class="params">(time_scheduler)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (run_flag_) &#123;</span><br><span class="line">    count++;</span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;定时循环第 &#123;&#125; 次 -------------------------&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 延迟 1 秒后再次调度（实现定时循环）</span></span><br><span class="line">    <span class="function"><span class="keyword">co_await</span> <span class="title">co::ScheduleAfter</span><span class="params">(time_scheduler, std::chrono::seconds(<span class="number">1</span>))</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;退出定时任务循环。&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">co_return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>co_await co::ScheduleAfter(time_scheduler,...)</code>​让等待任务完成后，由 <code>time_scheduler</code>​ 执行器中的线程恢复</li>
</ul>
<h5 id="停止阶段-2"><a href="#停止阶段-2" class="headerlink" title="停止阶段"></a>停止阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecutorCoModule::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 停止定时任务循环</span></span><br><span class="line">  run_flag_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 等待所有协程任务完成</span></span><br><span class="line">  co::<span class="built_in">SyncWait</span>(scope_.<span class="built_in">complete</span>());</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块已关闭。&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>停止定时任务</li>
<li><code>co::SyncWait(scope_.complete())</code>​<strong>阻塞当前线程</strong>，直到 <code>scope_.complete()</code>​ 所控制的所有协程任务完成</li>
</ul>
<h4 id="对应的启动配置文件-1"><a href="#对应的启动配置文件-1" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2023, AgiBot Inc.</span></span><br><span class="line"><span class="comment"># All rights reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">aimrt:</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span> <span class="comment"># Trace/Debug/Info/Warn/Error/Fatal/Off</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_executor</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thread_safe_executor</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">time_schedule_executor</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./libexecutor_pkg.so</span></span><br><span class="line">        <span class="attr">enable_modules:</span> [<span class="string">ExecutorCoModule</span>]</span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ExecutorCoModule</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure>

<h3 id="executor-co-loop-module"><a href="#executor-co-loop-module" class="headerlink" title="executor_co_loop_module"></a>executor_co_loop_module</h3><p>一个基于协程接口使用 executor 功能实现定时循环的示例，演示内容包括：</p>
<ul>
<li>如何以协程的方式使用执行器实现定时循环；</li>
</ul>
<p><em>与上一个示例中的定时器类似，因此这里只简单地分析。</em></p>
<h4 id="模块定义（executor-co-loop-module-h​）"><a href="#模块定义（executor-co-loop-module-h​）" class="headerlink" title="模块定义（executor_co_loop_module.h​）"></a>模块定义（<code>executor_co_loop_module.h</code>​）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入原子操作支持，用于线程安全的布尔变量</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入 AimRT 协程相关的接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/co/aimrt_context.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/co/async_scope.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/co/task.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/module_base.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有代码都放在对应命名空间下，防止命名冲突</span></span><br><span class="line"><span class="keyword">namespace</span> Executor::executor_co_loop_module &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> aimrt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义模块类，继承自 AimRT 框架的 ModuleBase 基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExecutorCoLoopModule</span> : <span class="keyword">public</span> aimrt::ModuleBase &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// 构造函数：默认构造</span></span><br><span class="line">  <span class="built_in">ExecutorCoLoopModule</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 析构函数：使用默认析构</span></span><br><span class="line">  ~<span class="built_in">ExecutorCoLoopModule</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模块信息，用于注册模块时描述其名称</span></span><br><span class="line">  <span class="function">ModuleInfo <span class="title">Info</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ModuleInfo&#123;.name = <span class="string">&quot;ExecutorCoLoopModule&quot;</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化函数，框架会在模块加载时调用</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Initialize</span><span class="params">(aimrt::CoreRef aimrt_ptr)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动函数，框架会在模块 Start 时调用</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Start</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关闭函数，框架会在模块卸载或退出时调用</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// 获取模块的日志对象，用于打印日志</span></span><br><span class="line">  <span class="function"><span class="keyword">auto</span> <span class="title">GetLogger</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> core_.<span class="built_in">GetLogger</span>(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主逻辑循环，使用协程定义</span></span><br><span class="line">  <span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">MainLoop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// 框架核心对象引用，用于访问其他模块/调度器等</span></span><br><span class="line">  aimrt::CoreRef core_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 指向时间调度执行器的引用，用于控制调度策略</span></span><br><span class="line">  aimrt::executor::ExecutorRef time_schedule_executor_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 异步任务作用域，用于批量管理协程任务</span></span><br><span class="line">  co::AsyncScope scope_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 控制循环运行状态的原子布尔标志，线程安全</span></span><br><span class="line">  std::atomic_bool run_flag_ = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace aimrt::examples::cpp::executor::executor_co_loop_module</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建变量：核心句柄、执行器句柄、协程作用域管理器、循环控制标志</li>
</ul>
<h4 id="模块实现-executor-co-loop-module-cc​"><a href="#模块实现-executor-co-loop-module-cc​" class="headerlink" title="模块实现(executor_co_loop_module.cc​)"></a>模块实现(<code>executor_co_loop_module.cc</code>​)</h4><h5 id="初始化阶段-3"><a href="#初始化阶段-3" class="headerlink" title="初始化阶段"></a>初始化阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ExecutorCoLoopModule::Initialize</span><span class="params">(aimrt::CoreRef core)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 保存框架核心对象引用</span></span><br><span class="line">  core_ = core;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从框架中获取名为 &quot;time_schedule_executor&quot; 的调度器执行器</span></span><br><span class="line">  time_schedule_executor_ =</span><br><span class="line">      core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;time_schedule_executor&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验是否成功获取，并且该执行器支持定时调度功能</span></span><br><span class="line">  <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(</span><br><span class="line">      time_schedule_executor_ &amp;&amp; time_schedule_executor_.<span class="built_in">SupportTimerSchedule</span>(),</span><br><span class="line">      <span class="string">&quot;无法获取支持定时调度的执行器：time_schedule_executor&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 打印初始化成功日志（中文）</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块初始化成功。&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="运行阶段-3"><a href="#运行阶段-3" class="headerlink" title="运行阶段"></a>运行阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ExecutorCoLoopModule::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 在内联调度器上启动主协程循环任务</span></span><br><span class="line">  scope_.<span class="built_in">spawn</span>(co::<span class="built_in">On</span>(co::<span class="built_in">InlineScheduler</span>(), <span class="built_in">MainLoop</span>()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 打印启动成功日志（中文）</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块启动成功。&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块的主协程逻辑</span></span><br><span class="line"><span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">ExecutorCoLoopModule::MainLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 打印循环开始日志（中文）</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;协程主循环开始。&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 time_schedule_executor 创建调度器对象</span></span><br><span class="line">  <span class="keyword">auto</span> scheduler = aimrt::co::<span class="built_in">AimRTScheduler</span>(time_schedule_executor_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 切换协程到定时调度线程池</span></span><br><span class="line">  <span class="function"><span class="keyword">co_await</span> <span class="title">co::Schedule</span><span class="params">(scheduler)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始循环，直到 run_flag_ 被设置为 false</span></span><br><span class="line">  <span class="keyword">while</span> (run_flag_) &#123;</span><br><span class="line">    count++;</span><br><span class="line">    <span class="comment">// 打印当前循环次数（中文）</span></span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;协程主循环第 &#123;&#125; 次 -------------------------&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 延迟 1 秒后再次调度，实现定时循环逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">co_await</span> <span class="title">co::ScheduleAfter</span><span class="params">(scheduler, std::chrono::seconds(<span class="number">1</span>))</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 循环结束后打印退出日志（中文）</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;协程主循环已退出。&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">co_return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="停止阶段-3"><a href="#停止阶段-3" class="headerlink" title="停止阶段"></a>停止阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecutorCoLoopModule::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 设置运行标志为 false，用于结束循环</span></span><br><span class="line">  run_flag_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阻塞等待所有协程任务完成</span></span><br><span class="line">  co::<span class="built_in">SyncWait</span>(scope_.<span class="built_in">complete</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 打印关闭成功日志（中文）</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块已关闭。&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对应的启动配置文件-2"><a href="#对应的启动配置文件-2" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2023, AgiBot Inc.</span></span><br><span class="line"><span class="comment"># All rights reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">aimrt:</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span> <span class="comment"># Trace/Debug/Info/Warn/Error/Fatal/Off</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">time_schedule_executor</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./libexecutor_pkg.so</span></span><br><span class="line">        <span class="attr">enable_modules:</span> [<span class="string">ExecutorCoLoopModule</span>]</span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ExecutorCoLoopModule</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure>

<h3 id="real-time-module"><a href="#real-time-module" class="headerlink" title="real_time_module"></a>real_time_module</h3><p>一个 executor 实时性相关功能的示例，演示内容包括：</p>
<ul>
<li>如何通过配置文件设置执行器的线程调度策略和优先级、绑核策略等；</li>
<li>本示例仅在 linux 上有效；</li>
<li>本示例重点在于最后的配置文件</li>
</ul>
<h4 id="模块定义（real-time-module-h​）"><a href="#模块定义（real-time-module-h​）" class="headerlink" title="模块定义（real_time_module.h​）"></a>模块定义（<code>real_time_module.h</code>​）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once  <span class="comment">// 防止头文件被多次包含</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span>  <span class="comment">// 提供原子类型 std::atomic，用于线程安全标志控制</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入协程相关接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/co/async_scope.h&quot;</span>  <span class="comment">// 异步作用域，管理协程生命周期</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/co/task.h&quot;</span>         <span class="comment">// 协程任务 Task 定义</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/module_base.h&quot;</span>  <span class="comment">// AIMRT 模块基类定义</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Executor::real_time_module &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RealTimeModule 是一个继承自 AIMRT 框架的 ModuleBase 的模块实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealTimeModule</span> : <span class="keyword">public</span> aimrt::ModuleBase &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">RealTimeModule</span>() = <span class="keyword">default</span>;            <span class="comment">// 默认构造函数</span></span><br><span class="line">  ~<span class="built_in">RealTimeModule</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;  <span class="comment">// 析构函数，确保虚析构行为</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现模块信息接口，返回模块的名称</span></span><br><span class="line">  <span class="function">ModuleInfo <span class="title">Info</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ModuleInfo&#123;.name = <span class="string">&quot;RealTimeModule&quot;</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模块初始化函数，在模块被加载时调用</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Initialize</span><span class="params">(aimrt::CoreRef aimrt_ptr)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模块启动函数，在模块开始运行时调用</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Start</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模块关闭函数，在模块卸载或退出时调用</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// 获取模块的日志接口，用于打印日志信息</span></span><br><span class="line">  <span class="function"><span class="keyword">auto</span> <span class="title">GetLogger</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> core_.<span class="built_in">GetLogger</span>(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过指定执行器名称启动一个协程工作循环</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">StartWorkLoopByExecutor</span><span class="params">(std::string_view executor_name)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 工作循环协程函数，接收一个执行器引用作为参数</span></span><br><span class="line">  <span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">WorkLoop</span><span class="params">(aimrt::executor::ExecutorRef executor_ptr)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  aimrt::CoreRef core_;               <span class="comment">// AIMRT 框架核心引用，用于访问系统资源</span></span><br><span class="line">  co::AsyncScope scope_;              <span class="comment">// 管理模块中所有异步协程任务的作用域</span></span><br><span class="line">  std::atomic_bool run_flag_ = <span class="literal">true</span>;  <span class="comment">// 控制定时循环协程是否继续运行的标志位</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace Executor::real_time_module</span></span><br></pre></td></tr></table></figure>

<h4 id="模块实现（real-time-module-cc​）"><a href="#模块实现（real-time-module-cc​）" class="headerlink" title="模块实现（real_time_module.cc​）"></a>模块实现（<code>real_time_module.cc</code>​）</h4><h5 id="初始化阶段-4"><a href="#初始化阶段-4" class="headerlink" title="初始化阶段"></a>初始化阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化模块，保存 AIMRT 核心引用</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">RealTimeModule::Initialize</span><span class="params">(aimrt::CoreRef core)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 保存 AIMRT 框架句柄</span></span><br><span class="line">  core_ = core;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 日志：初始化成功</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;初始化成功（Init succeeded）.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="运行阶段-4"><a href="#运行阶段-4" class="headerlink" title="运行阶段"></a>运行阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动模块，分别在三个不同类型的执行器上启动工作协程</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">RealTimeModule::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">StartWorkLoopByExecutor</span>(<span class="string">&quot;sched_fifo_thread&quot;</span>);   <span class="comment">// 启动 FIFO 调度线程的协程</span></span><br><span class="line">  <span class="built_in">StartWorkLoopByExecutor</span>(<span class="string">&quot;sched_other_thread&quot;</span>);  <span class="comment">// 启动 OTHER 调度线程的协程</span></span><br><span class="line">  <span class="built_in">StartWorkLoopByExecutor</span>(<span class="string">&quot;sched_rr_thread&quot;</span>);  <span class="comment">// 启动 RR（轮询）调度线程的协程</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 日志：启动成功</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;启动成功（Start succeeded）.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动指定执行器名的协程工作循环</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RealTimeModule::StartWorkLoopByExecutor</span><span class="params">(std::string_view executor_name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> executor = core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(executor_name);</span><br><span class="line">  <span class="comment">// 校验执行器存在并支持定时调度</span></span><br><span class="line">  <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(executor &amp;&amp; executor.<span class="built_in">SupportTimerSchedule</span>(),</span><br><span class="line">                          <span class="string">&quot;获取执行器 &#x27;&#123;&#125;&#x27; 失败（Get executor &#x27;&#123;&#125;&#x27; failed）.&quot;</span>,</span><br><span class="line">                          executor_name);</span><br><span class="line">  <span class="comment">// 使用指定执行器调度 WorkLoop 协程，并托管给 scope_</span></span><br><span class="line">  scope_.<span class="built_in">spawn</span>(co::<span class="built_in">On</span>(co::<span class="built_in">AimRTScheduler</span>(executor), <span class="built_in">WorkLoop</span>(executor)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工作协程逻辑：定时执行并打印线程和 CPU 信息</span></span><br><span class="line"><span class="function">co::Task&lt;<span class="type">void</span>&gt; <span class="title">RealTimeModule::WorkLoop</span><span class="params">(aimrt::executor::ExecutorRef executor)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 日志：启动工作循环</span></span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;在执行器 &#123;&#125; 中启动工作循环（Start WorkLoop in &#123;&#125;）.&quot;</span>,</span><br><span class="line">               executor.<span class="built_in">Name</span>());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __linux__</span></span><br><span class="line">    <span class="comment">// 获取当前线程名称</span></span><br><span class="line">    <span class="type">char</span> thread_name[<span class="number">16</span>];</span><br><span class="line">    <span class="built_in">pthread_getname_np</span>(<span class="built_in">pthread_self</span>(), thread_name, <span class="built_in">sizeof</span>(thread_name));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取线程调度策略和优先级</span></span><br><span class="line">    <span class="type">int</span> policy = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sched_param</span> param;</span><br><span class="line">    <span class="built_in">pthread_getschedparam</span>(<span class="built_in">pthread_self</span>(), &amp;policy, &amp;param);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 日志：打印线程信息</span></span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(</span><br><span class="line">        <span class="string">&quot;执行器名: &#123;&#125;, 线程名: &#123;&#125;, 调度策略: &#123;&#125;, 优先级: &#123;&#125;（Executor name: &quot;</span></span><br><span class="line">        <span class="string">&quot;&#123;&#125;, thread_name: &#123;&#125;, policy: &#123;&#125;, priority: &#123;&#125;）&quot;</span>,</span><br><span class="line">        executor.<span class="built_in">Name</span>(), thread_name, policy, param.sched_priority);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (run_flag_) &#123;</span><br><span class="line">      count++;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 记录当前时间戳（用于计算 sleep 时间）</span></span><br><span class="line">      <span class="keyword">auto</span> start_tp = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 协程挂起 1000 毫秒（使用指定调度器）</span></span><br><span class="line">      <span class="function"><span class="keyword">co_await</span> <span class="title">co::ScheduleAfter</span><span class="params">(co::AimRTScheduler(executor),</span></span></span><br><span class="line"><span class="params"><span class="function">                                 std::chrono::milliseconds(<span class="number">1000</span>))</span></span>;</span><br><span class="line">      <span class="keyword">auto</span> end_tp = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __linux__</span></span><br><span class="line">      <span class="comment">// 获取当前线程使用的 CPU 集合</span></span><br><span class="line">      <span class="type">cpu_set_t</span> cur_cpuset;</span><br><span class="line">      <span class="built_in">CPU_ZERO</span>(&amp;cur_cpuset);</span><br><span class="line">      <span class="keyword">auto</span> pthread_getaffinity_np_ret = <span class="built_in">pthread_getaffinity_np</span>(</span><br><span class="line">          <span class="built_in">pthread_self</span>(), <span class="built_in">sizeof</span>(<span class="type">cpu_set_t</span>), &amp;cur_cpuset);</span><br><span class="line">      <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(</span><br><span class="line">          pthread_getaffinity_np_ret == <span class="number">0</span>,</span><br><span class="line">          <span class="string">&quot;调用 pthread_getaffinity_np 失败，错误码：&#123;&#125;（Call &quot;</span></span><br><span class="line">          <span class="string">&quot;&#x27;pthread_getaffinity_np&#x27; get error: &#123;&#125;）&quot;</span>,</span><br><span class="line">          pthread_getaffinity_np_ret);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 构造当前线程使用的 CPU ID 字符串</span></span><br><span class="line">      <span class="type">uint32_t</span> cpu_size = std::thread::<span class="built_in">hardware_concurrency</span>();</span><br><span class="line">      std::string cur_cpuset_str;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> ii = <span class="number">0</span>; ii &lt; cpu_size; ii++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">CPU_ISSET</span>(ii, &amp;cur_cpuset)) &#123;</span><br><span class="line">          cur_cpuset_str += (std::<span class="built_in">to_string</span>(ii) + <span class="string">&quot;, &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cur_cpuset_str = cur_cpuset_str.<span class="built_in">substr</span>(<span class="number">0</span>, cur_cpuset_str.<span class="built_in">size</span>() - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取当前运行在哪个 CPU 上（逻辑核）</span></span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> current_cpu = <span class="number">0</span>, current_node = <span class="number">0</span>;</span><br><span class="line">      <span class="type">int</span> getcpu_ret = <span class="built_in">getcpu</span>(&amp;current_cpu, &amp;current_node);</span><br><span class="line">      <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(</span><br><span class="line">          getcpu_ret == <span class="number">0</span>,</span><br><span class="line">          <span class="string">&quot;调用 getcpu 失败，错误码：&#123;&#125;（Call &#x27;getcpu&#x27; get error: &#123;&#125;）&quot;</span>,</span><br><span class="line">          getcpu_ret);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 日志：打印循环次数、耗时、CPU 信息等</span></span><br><span class="line">      <span class="built_in">AIMRT_INFO</span>(</span><br><span class="line">          <span class="string">&quot;循环次数: &#123;&#125;, 执行器名: &#123;&#125;, 睡眠时间: &#123;&#125;, 当前 CPU: &#123;&#125;, NUMA 节点: &quot;</span></span><br><span class="line">          <span class="string">&quot;&#123;&#125;, 使用 CPU 集合: &#x27;&#123;&#125;&#x27;（&quot;</span></span><br><span class="line">          <span class="string">&quot;Loop count: &#123;&#125;, executor name: &#123;&#125;, sleep for &#123;&#125;, cpu: &#123;&#125;, node: &#123;&#125;, &quot;</span></span><br><span class="line">          <span class="string">&quot;use cpu: &#x27;&#123;&#125;&#x27;）&quot;</span>,</span><br><span class="line">          count, executor.<span class="built_in">Name</span>(), end_tp - start_tp, current_cpu, current_node,</span><br><span class="line">          cur_cpuset_str);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="comment">// 非 Linux 下仅打印次数与耗时</span></span><br><span class="line">      <span class="built_in">AIMRT_INFO</span>(</span><br><span class="line">          <span class="string">&quot;循环次数: &#123;&#125;, 执行器名: &#123;&#125;, 睡眠时间: &#123;&#125;（Loop count: &#123;&#125;, executor &quot;</span></span><br><span class="line">          <span class="string">&quot;name: &#123;&#125;, sleep for &#123;&#125;）&quot;</span>,</span><br><span class="line">          count, executor.<span class="built_in">Name</span>(), end_tp - start_tp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 日志：协程正常退出</span></span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;退出工作循环（Exit WorkLoop）.&quot;</span>);</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="comment">// 日志：协程因异常退出</span></span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(</span><br><span class="line">        <span class="string">&quot;工作循环异常退出，原因：&#123;&#125;（Exit WorkLoop with exception, &#123;&#125;）&quot;</span>,</span><br><span class="line">        e.<span class="built_in">what</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">co_return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="停止阶段-4"><a href="#停止阶段-4" class="headerlink" title="停止阶段"></a>停止阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭模块，停止协程并等待其完成</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RealTimeModule::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 设置退出标志，等待所有协程完成</span></span><br><span class="line">    run_flag_ = <span class="literal">false</span>;</span><br><span class="line">    co::<span class="built_in">SyncWait</span>(scope_.<span class="built_in">complete</span>());</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="comment">// 日志：关闭失败，打印异常信息</span></span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;关闭失败（Shutdown failed），异常信息：&#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 日志：关闭成功</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;关闭成功（Shutdown succeeded）.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对应的启动配置文件-3"><a href="#对应的启动配置文件-3" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><p>官网文档：<a target="_blank" rel="noopener" href="https://docs.aimrt.org/v0.10.0/tutorials/cfg/executor.html#aimrt-executor">配置文件-执行器相关</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2023, AgiBot Inc.</span></span><br><span class="line"><span class="comment"># All rights reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">aimrt:</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span> <span class="comment"># AimRT 框架核心日志级别，可选值：Trace / Debug / Info / Warn / Error / Fatal / Off</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span>  <span class="comment"># 日志输出后端，console 表示打印到终端控制台</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sched_fifo_thread</span>  <span class="comment"># 执行器名称（唯一标识）</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span>         <span class="comment"># 执行器类型：基于 Boost.Asio 的线程池模型</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">1</span>            <span class="comment"># 启动的线程数</span></span><br><span class="line">          <span class="attr">thread_sched_policy:</span> <span class="string">SCHED_FIFO:80</span> <span class="comment"># 调度策略为实时 FIFO，优先级 80（Linux 实时调度）</span></span><br><span class="line">          <span class="attr">thread_bind_cpu:</span> [<span class="number">0</span>, <span class="number">1</span>]  <span class="comment"># 将该线程绑定到第 0 和 1 号 CPU 核心上（用于控制 CPU 亲和性）</span></span><br><span class="line">          <span class="attr">timeout_alarm_threshold_us:</span> <span class="number">100</span>  <span class="comment"># 执行超时时间阈值（单位微秒），超过则记录报警日志</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sched_other_thread</span>  <span class="comment"># 普通时间片调度策略执行器</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">thread_sched_policy:</span> <span class="string">SCHED_OTHER</span>  <span class="comment"># 普通调度策略（非实时）</span></span><br><span class="line">          <span class="attr">thread_bind_cpu:</span> [<span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">          <span class="attr">timeout_alarm_threshold_us:</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sched_rr_thread</span>  <span class="comment"># 轮转调度策略执行器</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">thread_sched_policy:</span> <span class="string">SCHED_RR:80</span>  <span class="comment"># 轮转（Round Robin）调度策略，优先级 80</span></span><br><span class="line">          <span class="attr">thread_bind_cpu:</span> [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">          <span class="attr">timeout_alarm_threshold_us:</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./libexecutor_pkg.so</span>  <span class="comment"># 模块包路径（编译出的动态库）</span></span><br><span class="line">        <span class="attr">enable_modules:</span> [<span class="string">RealTimeModule</span>]  <span class="comment"># 从该库中启用哪些模块类（可包含多个）</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RealTimeModule</span>      <span class="comment"># 启用的模块名称（对应继承自 ModuleBase 的类名）</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span>             <span class="comment"># 该模块的日志级别（覆盖 core_lvl，仅对模块本身有效）</span></span><br></pre></td></tr></table></figure>

<h1 id="logger示例"><a href="#logger示例" class="headerlink" title="logger示例"></a>logger示例</h1><p>官方仓库：<a target="_blank" rel="noopener" href="https://github.com/AimRT/AimRT/blob/main/src/examples/cpp/logger">logger</a></p>
<h2 id="配置文件-configuration-logger-yaml​"><a href="#配置文件-configuration-logger-yaml​" class="headerlink" title="配置文件(configuration_logger.yaml​)"></a>配置文件(<code>configuration_logger.yaml</code>​)</h2><p>依据官方示例项目结构自行编写YAML配置文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 基础信息</span><br><span class="line">base_info:</span><br><span class="line">  project_name: Logger # 项目名称</span><br><span class="line">  build_mode_tags: [<span class="string">&quot;EXAMPLE&quot;</span>, <span class="string">&quot;SIMULATION&quot;</span>, <span class="string">&quot;TEST_CAMERA&quot;</span>] # 构建模式标签</span><br><span class="line">  aimrt_import_options: # AimRT框架的构建选项</span><br><span class="line">    AIMRT_BUILD_TESTS: <span class="string">&quot;OFF&quot;</span> # 是否构建测试代码</span><br><span class="line">    AIMRT_BUILD_EXAMPLES: <span class="string">&quot;ON&quot;</span> # 是否构建示例代码</span><br><span class="line">    AIMRT_BUILD_DOCUMENT: <span class="string">&quot;OFF&quot;</span> # 是否构建文档</span><br><span class="line">    AIMRT_BUILD_RUNTIME: <span class="string">&quot;ON&quot;</span> # 是否构建运行时核心</span><br><span class="line">    AIMRT_BUILD_CLI_TOOLS: <span class="string">&quot;OFF&quot;</span> # 是否构建命令行工具</span><br><span class="line">    AIMRT_BUILD_WITH_PROTOBUF: <span class="string">&quot;ON&quot;</span> # 是否启用Protobuf支持</span><br><span class="line">    AIMRT_USE_LOCAL_PROTOC_COMPILER: <span class="string">&quot;OFF&quot;</span> # 是否使用本地protoc编译器</span><br><span class="line">    AIMRT_BUILD_WITH_ROS2: <span class="string">&quot;OFF&quot;</span> # 是否集成ROS2支持</span><br><span class="line">    AIMRT_BUILD_NET_PLUGIN: <span class="string">&quot;OFF&quot;</span> # 是否构建网络插件</span><br><span class="line">    AIMRT_BUILD_ROS2_PLUGIN: <span class="string">&quot;OFF&quot;</span> # 是否构建ROS2插件</span><br><span class="line"></span><br><span class="line"># 模块</span><br><span class="line">modules:</span><br><span class="line">  - name: logger_module</span><br><span class="line">  - name: logger_bench_module</span><br><span class="line"></span><br><span class="line"><span class="meta"># pkg</span></span><br><span class="line">pkgs:</span><br><span class="line">  - name: logger_pkg # 包名</span><br><span class="line">    modules:</span><br><span class="line">      - name: logger_module</span><br><span class="line">      - name: logger_bench_module</span><br><span class="line"></span><br><span class="line"># 部署</span><br><span class="line">deploy_modes:</span><br><span class="line">  - name: local_deploy # 部署模式名称</span><br><span class="line">    deploy_ins: # 部署实例</span><br><span class="line">      - name: local_ins_logger # 实例名称</span><br><span class="line">        pkgs:</span><br><span class="line">          - name: logger_pkg # 实例加载的包</span><br></pre></td></tr></table></figure>

<h2 id="module目录-2"><a href="#module目录-2" class="headerlink" title="module目录"></a>module目录</h2><h3 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h3><p>一个最基本的 cpp logger 示例，演示内容包括：</p>
<ul>
<li>如何在 AimRT 中打印 Log 到控制台；</li>
<li>如何使用不同的日志级别；</li>
</ul>
<h4 id="模块定义（logger-module-h​）"><a href="#模块定义（logger-module-h​）" class="headerlink" title="模块定义（logger_module.h​）"></a>模块定义（<code>logger_module.h</code>​）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/module_base.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Logger::logger_module &#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> aimrt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志模块类，继承自AIMRT模块基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoggerModule</span> : <span class="keyword">public</span> aimrt::ModuleBase &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">LoggerModule</span>() = <span class="keyword">default</span>;</span><br><span class="line">  ~<span class="built_in">LoggerModule</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取模块信息</span></span><br><span class="line">  <span class="function">ModuleInfo <span class="title">Info</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ModuleInfo&#123;.name = <span class="string">&quot;LoggerModule&quot;</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化模块</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Initialize</span><span class="params">(aimrt::CoreRef aimrt_ptr)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动模块</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Start</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关闭模块</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  aimrt::CoreRef core_;                    <span class="comment">// AIMRT核心引用</span></span><br><span class="line">  aimrt::executor::ExecutorRef executor_;  <span class="comment">// 执行器引用</span></span><br><span class="line"></span><br><span class="line">  std::atomic_bool run_flag_ = <span class="literal">false</span>;  <span class="comment">// 运行标志位</span></span><br><span class="line">  std::promise&lt;<span class="type">void</span>&gt; stop_sig_;        <span class="comment">// 停止信号</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace Logger::logger_module</span></span><br></pre></td></tr></table></figure>

<h4 id="模块实现（logger-module-cc​）"><a href="#模块实现（logger-module-cc​）" class="headerlink" title="模块实现（logger_module.cc​）"></a>模块实现（<code>logger_module.cc</code>​）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;logger_module/logger_module.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;yaml-cpp/yaml.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Logger::logger_module &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> aimrt::logger;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">LoggerModule::Initialize</span><span class="params">(aimrt::CoreRef core)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 保存AIMRT框架句柄</span></span><br><span class="line">  core_ = core;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取执行器句柄</span></span><br><span class="line">  executor_ = core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;work_executor&quot;</span>);</span><br><span class="line">  <span class="built_in">AIMRT_HL_CHECK_ERROR_THROW</span>(core_.<span class="built_in">GetLogger</span>(), executor_,</span><br><span class="line">                             <span class="string">&quot;获取执行器&#x27;work_thread_pool&#x27;失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_HL_INFO</span>(core_.<span class="built_in">GetLogger</span>(), <span class="string">&quot;初始化成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">LoggerModule::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  run_flag_ = <span class="literal">true</span>;</span><br><span class="line">  executor_.<span class="built_in">Execute</span>([<span class="keyword">this</span>]() &#123;</span><br><span class="line">    <span class="comment">// 为当前作用域创建日志句柄</span></span><br><span class="line">    <span class="keyword">auto</span> GetLogger = [<span class="keyword">this</span>]() &#123; <span class="keyword">return</span> core_.<span class="built_in">GetLogger</span>(); &#125;;</span><br><span class="line"></span><br><span class="line">    std::string s = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (run_flag_.<span class="built_in">load</span>()) &#123;</span><br><span class="line">      ++n;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 输出各级别日志</span></span><br><span class="line">      <span class="built_in">AIMRT_TRACE</span>(<span class="string">&quot;测试跟踪日志, 字符串 = &#123;&#125;, 计数器 = &#123;&#125;&quot;</span>, s, n);</span><br><span class="line">      <span class="built_in">AIMRT_DEBUG</span>(<span class="string">&quot;测试调试日志, 字符串 = &#123;&#125;, 计数器 = &#123;&#125;&quot;</span>, s, n);</span><br><span class="line">      <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;测试信息日志, 字符串 = &#123;&#125;, 计数器 = &#123;&#125;&quot;</span>, s, n);</span><br><span class="line">      <span class="built_in">AIMRT_WARN</span>(<span class="string">&quot;测试警告日志, 字符串 = &#123;&#125;, 计数器 = &#123;&#125;&quot;</span>, s, n);</span><br><span class="line">      <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;测试错误日志, 字符串 = &#123;&#125;, 计数器 = &#123;&#125;&quot;</span>, s, n);</span><br><span class="line">      <span class="built_in">AIMRT_FATAL</span>(<span class="string">&quot;测试致命日志, 字符串 = &#123;&#125;, 计数器 = &#123;&#125;&quot;</span>, s, n);</span><br><span class="line"></span><br><span class="line">      std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stop_sig_.<span class="built_in">set_value</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_HL_INFO</span>(core_.<span class="built_in">GetLogger</span>(), <span class="string">&quot;启动成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoggerModule::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (run_flag_) &#123;</span><br><span class="line">    run_flag_ = <span class="literal">false</span>;</span><br><span class="line">    stop_sig_.<span class="built_in">get_future</span>().<span class="built_in">wait</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">AIMRT_HL_INFO</span>(core_.<span class="built_in">GetLogger</span>(), <span class="string">&quot;关闭成功&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace Logger::logger_module</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>注意</strong>，提供的日志宏基于 C++20 Format 语法</li>
</ul>
<p>实现内容很简单，不在此做具体分析，只需要关注配置文件的部分</p>
<h4 id="对应的启动配置文件-4"><a href="#对应的启动配置文件-4" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AIMRT框架主配置</span></span><br><span class="line"><span class="attr">aimrt:</span></span><br><span class="line">  <span class="comment"># 日志系统配置</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="comment"># 核心日志级别，可选值：Trace/Debug/Info/Warn/Error/Fatal/Off</span></span><br><span class="line">    <span class="comment"># 设置INFO表示只记录INFO及以上级别的日志</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志后端配置</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="comment"># 使用控制台作为日志输出</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 执行器配置</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="comment"># 执行器列表</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="comment"># 定义一个名为work_executor的执行器</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_executor</span></span><br><span class="line">        <span class="comment"># 执行器类型为简单线程</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">simple_thread</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 模块配置</span></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="comment"># 模块包配置</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="comment"># 指定模块包路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./liblogger_pkg.so</span></span><br><span class="line">        <span class="comment"># 启用该包中的LoggerModule模块</span></span><br><span class="line">        <span class="attr">enable_modules:</span> [<span class="string">LoggerModule</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模块详细配置</span></span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="comment"># LoggerModule模块的配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LoggerModule</span></span><br><span class="line">        <span class="comment"># 该模块的日志级别设置为TRACE（最详细）</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">TRACE</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>core_lvl</code>​设置的是AimRT核心的日志等级；<code>modules</code>​中的<code>log_lvl</code>​控制的是本模块的日志等级</li>
<li><code>backends</code>​：日志输出后端，支持<code>console</code>​(控制台)、<code>rotate_file</code>​(滚动文件)等多种类型</li>
</ul>
<h3 id="logger-rotate-file"><a href="#logger-rotate-file" class="headerlink" title="logger rotate file"></a>logger rotate file</h3><p>一个最基本的 cpp logger 示例，演示内容包括：</p>
<ul>
<li><p>如何使用 rotate_file 类型 Log 后端并了解其配置项；</p>
</li>
<li><p>代码与上一个<code>logger</code>​示例完全相同</p>
</li>
</ul>
<h4 id="对应的启动配置文件-5"><a href="#对应的启动配置文件-5" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aimrt:</span>  <span class="comment"># AIMRT框架根配置节点</span></span><br><span class="line">  <span class="comment"># 日志系统配置部分</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="comment"># 核心日志级别配置（框架自身日志输出级别）</span></span><br><span class="line">    <span class="comment"># 可选值（区分大小写）:</span></span><br><span class="line">    <span class="comment">#   TRACE   - 最详细跟踪信息（开发调试用）</span></span><br><span class="line">    <span class="comment">#   DEBUG   - 调试信息</span></span><br><span class="line">    <span class="comment">#   INFO    - 常规运行信息（推荐生产环境使用）</span></span><br><span class="line">    <span class="comment">#   WARN    - 警告信息</span></span><br><span class="line">    <span class="comment">#   ERROR   - 错误信息</span></span><br><span class="line">    <span class="comment">#   FATAL   - 致命错误</span></span><br><span class="line">    <span class="comment">#   OFF     - 关闭所有日志</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span>  <span class="comment"># 当前设置为INFO级别</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志输出后端配置（支持同时配置多个输出目标）</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="comment"># 控制台输出配置（必选）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span>  <span class="comment"># 输出到标准控制台</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 滚动文件输出配置（可选）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">rotate_file</span>  <span class="comment"># 滚动文件类型</span></span><br><span class="line">        <span class="attr">options:</span>  <span class="comment"># 文件输出专属配置</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">./log</span>  <span class="comment"># 日志文件存储目录（相对路径）</span></span><br><span class="line">          <span class="attr">filename:</span> <span class="string">examples_cpp_logger_rotate_file.log</span>  <span class="comment"># 日志文件名</span></span><br><span class="line">          <span class="attr">max_file_size_m:</span> <span class="number">4</span>  <span class="comment"># 单个文件最大大小（单位MB）</span></span><br><span class="line">          <span class="attr">max_file_num:</span> <span class="number">10</span>  <span class="comment"># 最大保留文件数（达到后自动删除最旧文件）</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 执行器（线程池）配置部分</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="comment"># 执行器列表（可配置多个执行器）</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="comment"># 工作执行器配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_executor</span>  <span class="comment"># 执行器名称（需与代码中引用名称一致）</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">simple_thread</span>  <span class="comment"># 执行器类型：简单线程模式</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 模块系统配置部分</span></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="comment"># 动态模块包配置（可配置多个模块包）</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="comment"># 第一个模块包配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./liblogger_pkg.so</span>  <span class="comment"># 模块动态库路径（相对/绝对路径）</span></span><br><span class="line">        <span class="attr">enable_modules:</span> [<span class="string">LoggerModule</span>]  <span class="comment"># 需要启用的模块列表（数组格式）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模块详细参数配置（可覆盖模块默认参数）</span></span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="comment"># Logger模块配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LoggerModule</span>  <span class="comment"># 必须与代码中模块类名完全一致</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">TRACE</span>  <span class="comment"># 模块专用日志级别（可独立于core_lvl设置）</span></span><br></pre></td></tr></table></figure>

<h3 id="logger-specify-executor"><a href="#logger-specify-executor" class="headerlink" title="logger specify executor"></a>logger specify executor</h3><p>一个最基本的 cpp logger 示例，演示内容包括：</p>
<ul>
<li>如何使用指定的执行器作为日志后端的执行线程；</li>
<li>代码与示例<code>logger</code>​相同</li>
</ul>
<h4 id="对应的启动配置文件-6"><a href="#对应的启动配置文件-6" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aimrt:</span>  <span class="comment"># AIMRT框架根配置节点</span></span><br><span class="line">  <span class="comment"># 日志系统配置</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="comment"># 核心日志级别（框架自身日志输出级别）</span></span><br><span class="line">    <span class="comment"># 可选值（区分大小写）：</span></span><br><span class="line">    <span class="comment">#   TRACE   - 最详细跟踪信息</span></span><br><span class="line">    <span class="comment">#   DEBUG   - 调试信息</span></span><br><span class="line">    <span class="comment">#   INFO    - 常规信息（推荐生产环境使用）</span></span><br><span class="line">    <span class="comment">#   WARN    - 警告信息</span></span><br><span class="line">    <span class="comment">#   ERROR   - 错误信息</span></span><br><span class="line">    <span class="comment">#   FATAL   - 致命错误</span></span><br><span class="line">    <span class="comment">#   OFF     - 关闭日志</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span>  <span class="comment"># 当前设置为INFO级别</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志输出后端配置</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="comment"># 控制台日志输出配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span>  <span class="comment"># 控制台输出类型</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">log_executor_name:</span> <span class="string">log_executor</span>  <span class="comment"># 指定专用的日志执行器</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 执行器（线程池）配置</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="comment"># 执行器列表（可配置多个）</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="comment"># 工作执行器（用于业务逻辑）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_executor</span>  <span class="comment"># 执行器名称</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">simple_thread</span>   <span class="comment"># 简单线程模式</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 专用日志执行器（确保日志输出不阻塞业务线程）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log_executor</span>    <span class="comment"># 执行器名称需与日志配置一致</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">simple_thread</span>  <span class="comment"># 简单线程模式</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 模块系统配置</span></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="comment"># 动态模块包配置</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="comment"># 日志模块包配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./liblogger_pkg.so</span>  <span class="comment"># 模块动态库路径</span></span><br><span class="line">        <span class="attr">enable_modules:</span> [<span class="string">LoggerModule</span>]  <span class="comment"># 启用的模块列表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模块参数配置</span></span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="comment"># 日志模块配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LoggerModule</span>  <span class="comment"># 必须与代码中模块名一致</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">TRACE</span>      <span class="comment"># 模块日志级别（开发时可用TRACE）</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这里创建了一个单独的日志执行器，避免日志I&#x2F;O操作阻塞业务线程</li>
<li>要求日志执行器是线程安全的</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">  A[console后端] --&gt;|使用| B[log_executor]</span><br><span class="line">  C[work_executor] --&gt;|产生日志| A</span><br><span class="line">  D[LoggerModule] --&gt;|写入| A</span><br></pre></td></tr></table></figure>

<h3 id="logger-format"><a href="#logger-format" class="headerlink" title="logger format"></a>logger format</h3><p>一个最基本的 cpp logger 示例，演示内容包括：</p>
<ul>
<li>如何使用自定义的 format 格式输出日志；</li>
<li>代码与示例<code>logger</code>​相同</li>
</ul>
<h4 id="对应的启动配置文件-7"><a href="#对应的启动配置文件-7" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aimrt:</span>  <span class="comment"># AIMRT框架根配置节点</span></span><br><span class="line">  <span class="comment"># 日志系统配置</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="comment"># 核心日志级别（框架自身日志输出级别）</span></span><br><span class="line">    <span class="comment"># 可选值（区分大小写）：</span></span><br><span class="line">    <span class="comment">#   TRACE   - 最详细跟踪信息</span></span><br><span class="line">    <span class="comment">#   DEBUG   - 调试信息</span></span><br><span class="line">    <span class="comment">#   INFO    - 常规信息（推荐生产环境使用）</span></span><br><span class="line">    <span class="comment">#   WARN    - 警告信息</span></span><br><span class="line">    <span class="comment">#   ERROR   - 错误信息</span></span><br><span class="line">    <span class="comment">#   FATAL   - 致命错误</span></span><br><span class="line">    <span class="comment">#   OFF     - 关闭日志</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span>  <span class="comment"># 当前设置为INFO级别</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志输出后端配置</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="comment"># 控制台日志输出配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span>  <span class="comment"># 控制台输出类型</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="comment"># 日志格式模板（支持自定义格式）</span></span><br><span class="line">          <span class="comment"># 可用占位符说明：</span></span><br><span class="line">          <span class="comment">#   %c - 日志器名称</span></span><br><span class="line">          <span class="comment">#   %f - 文件名（短格式）</span></span><br><span class="line">          <span class="comment">#   %A - 完整文件名</span></span><br><span class="line">          <span class="comment">#   %l - 行号</span></span><br><span class="line">          <span class="comment">#   %t - 线程ID</span></span><br><span class="line">          <span class="comment">#   %n - 模块名称</span></span><br><span class="line">          <span class="comment">#   %G - 日志分组</span></span><br><span class="line">          <span class="comment">#   %v - 实际日志内容</span></span><br><span class="line">          <span class="comment">#   %L - 日志级别</span></span><br><span class="line">          <span class="comment">#   %D - 日期时间（可带格式修饰，如%D&#123;%Y-%m-%d %H:%M:%S&#125;）</span></span><br><span class="line">          <span class="attr">pattern:</span> <span class="string">&quot;[%c.%f][%A][%l][%t][%n][%G] %v&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 执行器（线程池）配置</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="comment"># 执行器列表（可配置多个）</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="comment"># 工作执行器配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_executor</span>  <span class="comment"># 执行器名称</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">simple_thread</span>  <span class="comment"># 简单线程模式</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 模块系统配置</span></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="comment"># 动态模块包配置</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="comment"># 日志模块包配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./liblogger_pkg.so</span>  <span class="comment"># 模块动态库路径</span></span><br><span class="line">        <span class="attr">enable_modules:</span> [<span class="string">LoggerModule</span>]  <span class="comment"># 启用的模块列表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模块参数配置</span></span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="comment"># 日志模块配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LoggerModule</span>  <span class="comment"># 必须与代码中模块名一致</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">TRACE</span>      <span class="comment"># 模块日志级别（开发时可用TRACE）</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置了日志打印格式为[%c.%f][%A][%l][%t][%n][%G] %v，日志输出示例如下：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-10</span><span class="number">-31</span> <span class="number">20</span>:<span class="number">35</span>:<span class="number">28.378443</span>][Thursday][Info][<span class="number">126632</span>][LoggerModule][logger_module.cc] Test info log</span><br></pre></td></tr></table></figure>

<h3 id="logger-rotate-file-with-sync（0-8-x版本不支持，最新main分支开始支持）"><a href="#logger-rotate-file-with-sync（0-8-x版本不支持，最新main分支开始支持）" class="headerlink" title="logger rotate file with sync（0.8.x版本不支持，最新main分支开始支持）"></a>logger rotate file with sync（0.8.x版本不支持，最新main分支开始支持）</h3><p>一个最基本的 cpp logger 示例，演示内容包括：</p>
<ul>
<li>如何使用 rotate_file 类型 Log 后端并了解其配置项；</li>
<li>如何配置相关配置选项以开启定期落盘机制，保证数据完整性；</li>
</ul>
<h4 id="对应的启动配置文件-8"><a href="#对应的启动配置文件-8" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aimrt:</span>  <span class="comment"># AIMRT框架根配置节点</span></span><br><span class="line">  <span class="comment"># 日志系统配置</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="comment"># 核心日志级别（框架自身日志输出级别）</span></span><br><span class="line">    <span class="comment"># 可选值（区分大小写）：</span></span><br><span class="line">    <span class="comment">#   TRACE   - 最详细跟踪信息（开发调试用）</span></span><br><span class="line">    <span class="comment">#   DEBUG   - 调试信息</span></span><br><span class="line">    <span class="comment">#   INFO    - 常规运行信息（推荐生产环境使用）</span></span><br><span class="line">    <span class="comment">#   WARN    - 警告信息</span></span><br><span class="line">    <span class="comment">#   ERROR   - 错误信息</span></span><br><span class="line">    <span class="comment">#   FATAL   - 致命错误</span></span><br><span class="line">    <span class="comment">#   OFF     - 关闭所有日志</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span>  <span class="comment"># 当前设置为INFO级别</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志输出后端配置（支持多后端同时输出）</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="comment"># 控制台输出配置（实时输出）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span>  <span class="comment"># 标准控制台输出</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 轮转文件输出配置（持久化存储）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">rotate_file</span>  <span class="comment"># 支持日志文件轮转</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">./log</span>  <span class="comment"># 日志存储目录（相对路径）</span></span><br><span class="line">          <span class="attr">filename:</span> <span class="string">examples_cpp_logger_rotate_file.log</span>  <span class="comment"># 日志文件名</span></span><br><span class="line">          <span class="attr">max_file_size_m:</span> <span class="number">4</span>  <span class="comment"># 单个文件最大4MB</span></span><br><span class="line">          <span class="attr">max_file_num:</span> <span class="number">10</span>  <span class="comment"># 最多保留10个历史文件</span></span><br><span class="line"></span><br><span class="line">          <span class="comment"># 日志同步配置（确保日志完整性）</span></span><br><span class="line">          <span class="attr">enable_sync:</span> <span class="literal">true</span>  <span class="comment"># 启用定期同步</span></span><br><span class="line">          <span class="attr">sync_interval_ms:</span> <span class="number">5000</span>  <span class="comment"># 每5秒同步到磁盘</span></span><br><span class="line">          <span class="attr">sync_executor_name:</span> <span class="string">sync_timer_executor</span>  <span class="comment"># 使用专用执行器</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 执行器（线程池）配置</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="comment"># 工作执行器（处理业务逻辑）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_executor</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">simple_thread</span>  <span class="comment"># 简单线程模式</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 日志同步定时器执行器</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sync_timer_executor</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 模块系统配置</span></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="comment"># 动态模块包配置</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./liblogger_pkg.so</span>  <span class="comment"># 模块动态库路径</span></span><br><span class="line">        <span class="attr">enable_modules:</span> [<span class="string">LoggerModule</span>]  <span class="comment"># 启用的模块列表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模块参数配置</span></span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LoggerModule</span>  <span class="comment"># 模块名称（需与代码一致）</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">TRACE</span>  <span class="comment"># 模块日志级别（开发调试用TRACE）</span></span><br></pre></td></tr></table></figure>

<h1 id="Parameter示例"><a href="#Parameter示例" class="headerlink" title="Parameter示例"></a>Parameter示例</h1><p>官方仓库：<a target="_blank" rel="noopener" href="https://github.com/AimRT/AimRT/blob/main/src/examples/cpp/parameter">parameter</a></p>
<p>AimRT 中提供了一个简单的模块级 Key-Val 参数功能，模块可以通过调用<code>CoreRe</code>​f句柄的<code>GetParameterHandle()</code>​接口，获取<code>aimrt::parameter::ParameterHandleRef</code>​句柄，来使用此功能。</p>
<p>该句柄提供的核心接口如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">namespace aimrt::parameter &#123;</span><br><span class="line"></span><br><span class="line">class ParameterHandleRef &#123;</span><br><span class="line"> public:</span><br><span class="line">  std::string GetParameter(std::string_view key) const;</span><br><span class="line"></span><br><span class="line">  void SetParameter(std::string_view key, std::string_view val) const;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace aimrt::parameter</span><br></pre></td></tr></table></figure>

<p>使用注意点如下：</p>
<ul>
<li><p><code>std::string GetParameter(std::string_view key)</code>​接口：用于获取参数。</p>
<ul>
<li>如果不存在 key，则返回空字符串。</li>
<li>该接口是线程安全的。</li>
</ul>
</li>
<li><p><code>void SetParameter(std::string_view key, std::string_view val)</code>​接口：用于设置&#x2F;更新参数。</p>
<ul>
<li>如果不存在 key，则新建一个 key-val 参数对。</li>
<li>如果存在 key，则更新 key 所对应的 val 值为最新值。</li>
<li>该接口是线程安全的。</li>
</ul>
</li>
<li><p>无论是设置参数还是获取参数，都是模块级别的，不同模块的参数互相独立、互不可见。</p>
</li>
</ul>
<h2 id="配置文件-configuration-parameter-yaml​"><a href="#配置文件-configuration-parameter-yaml​" class="headerlink" title="配置文件(configuration_parameter.yaml​)"></a>配置文件(<code>configuration_parameter.yaml</code>​)</h2><p>依据官方示例项目结构自行编写YAML配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础信息</span></span><br><span class="line"><span class="attr">base_info:</span></span><br><span class="line">  <span class="attr">project_name:</span> <span class="string">Parameter</span> <span class="comment"># 项目名称</span></span><br><span class="line">  <span class="attr">build_mode_tags:</span> [<span class="string">&quot;EXAMPLE&quot;</span>, <span class="string">&quot;SIMULATION&quot;</span>, <span class="string">&quot;TEST_CAMERA&quot;</span>] <span class="comment"># 构建模式标签</span></span><br><span class="line">  <span class="attr">aimrt_import_options:</span> <span class="comment"># AimRT框架的构建选项</span></span><br><span class="line">    <span class="attr">AIMRT_BUILD_TESTS:</span> <span class="string">&quot;OFF&quot;</span> <span class="comment"># 是否构建测试代码</span></span><br><span class="line">    <span class="attr">AIMRT_BUILD_EXAMPLES:</span> <span class="string">&quot;ON&quot;</span> <span class="comment"># 是否构建示例代码</span></span><br><span class="line">    <span class="attr">AIMRT_BUILD_DOCUMENT:</span> <span class="string">&quot;OFF&quot;</span> <span class="comment"># 是否构建文档</span></span><br><span class="line">    <span class="attr">AIMRT_BUILD_RUNTIME:</span> <span class="string">&quot;ON&quot;</span> <span class="comment"># 是否构建运行时核心</span></span><br><span class="line">    <span class="attr">AIMRT_BUILD_CLI_TOOLS:</span> <span class="string">&quot;OFF&quot;</span> <span class="comment"># 是否构建命令行工具</span></span><br><span class="line">    <span class="attr">AIMRT_BUILD_WITH_PROTOBUF:</span> <span class="string">&quot;ON&quot;</span> <span class="comment"># 是否启用Protobuf支持</span></span><br><span class="line">    <span class="attr">AIMRT_USE_LOCAL_PROTOC_COMPILER:</span> <span class="string">&quot;OFF&quot;</span> <span class="comment"># 是否使用本地protoc编译器</span></span><br><span class="line">    <span class="attr">AIMRT_BUILD_WITH_ROS2:</span> <span class="string">&quot;OFF&quot;</span> <span class="comment"># 是否集成ROS2支持</span></span><br><span class="line">    <span class="attr">AIMRT_BUILD_NET_PLUGIN:</span> <span class="string">&quot;OFF&quot;</span> <span class="comment"># 是否构建网络插件</span></span><br><span class="line">    <span class="attr">AIMRT_BUILD_ROS2_PLUGIN:</span> <span class="string">&quot;OFF&quot;</span> <span class="comment"># 是否构建ROS2插件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块</span></span><br><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">parameter_module</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pkg</span></span><br><span class="line"><span class="attr">pkgs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">parameter_pkg</span> <span class="comment"># 包名</span></span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">parameter_module</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署</span></span><br><span class="line"><span class="attr">deploy_modes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">local_deploy</span> <span class="comment"># 部署模式名称</span></span><br><span class="line">    <span class="attr">deploy_ins:</span> <span class="comment"># 部署实例</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">local_ins_parameter</span> <span class="comment"># 实例名称</span></span><br><span class="line">        <span class="attr">pkgs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">parameter_pkg</span> <span class="comment"># 实例加载的包</span></span><br></pre></td></tr></table></figure>

<h2 id="module目录-3"><a href="#module目录-3" class="headerlink" title="module目录"></a>module目录</h2><h3 id="parameter-module"><a href="#parameter-module" class="headerlink" title="parameter_module"></a>parameter_module</h3><p>一个最基本的 cpp parameter 示例，演示内容包括：</p>
<ul>
<li>如何使用 AimRT 的 Parameter 功能；</li>
<li>此示例创建了一个 <code>ParameterModule</code>​，会在其 <code>Start</code>​ 的阶段循通过 SetParameter 和 GetParameter 方法设置和获取参数的值，并通过日志打印出来；</li>
</ul>
<h4 id="模块定义"><a href="#模块定义" class="headerlink" title="模块定义"></a>模块定义</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma once</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &quot;aimrt_module_cpp_interface/module_base.h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">namespace</span> <span class="string">Parameter::parameter_module</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">参数模块类，继承自AIMRT模块基类</span></span><br><span class="line"><span class="attr">class ParameterModule :</span> <span class="string">public</span> <span class="string">aimrt::ModuleBase</span> &#123;</span><br><span class="line"> <span class="attr">public:</span></span><br><span class="line">  <span class="string">ParameterModule()</span> <span class="string">=</span> <span class="string">default;</span></span><br><span class="line">  <span class="string">~ParameterModule()</span> <span class="string">override</span> <span class="string">=</span> <span class="string">default;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">//</span> <span class="string">返回模块信息</span></span><br><span class="line">  <span class="string">ModuleInfo</span> <span class="string">Info()</span> <span class="string">const</span> <span class="string">override</span> &#123;</span><br><span class="line">    <span class="string">return</span> <span class="string">ModuleInfo</span>&#123;<span class="string">.name</span> <span class="string">=</span> <span class="string">&quot;ParameterModule&quot;</span>&#125;<span class="string">;</span>  <span class="string">//</span> <span class="string">模块名称</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="string">//</span> <span class="string">模块初始化接口</span></span><br><span class="line">  <span class="string">bool</span> <span class="string">Initialize(aimrt::CoreRef</span> <span class="string">core)</span> <span class="string">override;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">//</span> <span class="string">模块启动接口</span></span><br><span class="line">  <span class="string">bool</span> <span class="string">Start()</span> <span class="string">override;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">//</span> <span class="string">模块关闭接口</span></span><br><span class="line">  <span class="string">void</span> <span class="string">Shutdown()</span> <span class="string">override;</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">private:</span></span><br><span class="line">  <span class="string">//</span> <span class="string">获取日志记录器</span></span><br><span class="line">  <span class="string">auto</span> <span class="string">GetLogger()</span> &#123; <span class="string">return</span> <span class="string">core_.GetLogger();</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="string">//</span> <span class="string">设置参数的循环任务</span></span><br><span class="line">  <span class="string">void</span> <span class="string">SetParameterLoop();</span></span><br><span class="line">  <span class="string">//</span> <span class="string">获取参数的循环任务</span></span><br><span class="line">  <span class="string">void</span> <span class="string">GetParameterLoop();</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">private:</span></span><br><span class="line">  <span class="string">aimrt::CoreRef</span> <span class="string">core_;</span>                                    <span class="string">//</span> <span class="string">AIMRT核心引用</span></span><br><span class="line">  <span class="string">aimrt::executor::ExecutorRef</span> <span class="string">work_executor_;</span>             <span class="string">//</span> <span class="string">执行器</span></span><br><span class="line">  <span class="string">aimrt::parameter::ParameterHandleRef</span> <span class="string">parameter_handle_;</span>  <span class="string">//</span> <span class="string">参数操作句柄</span></span><br><span class="line"></span><br><span class="line">  <span class="string">std::atomic_bool</span> <span class="string">run_flag_</span> <span class="string">=</span> <span class="literal">true</span><span class="string">;</span>      <span class="string">//</span> <span class="string">运行标志，控制循环是否继续</span></span><br><span class="line">  <span class="string">std::promise&lt;void&gt;</span> <span class="string">set_loop_stop_sig_;</span>  <span class="string">//</span> <span class="string">设置参数循环停止信号</span></span><br><span class="line">  <span class="string">std::promise&lt;void&gt;</span> <span class="string">get_loop_stop_sig_;</span>  <span class="string">//</span> <span class="string">获取参数循环停止信号</span></span><br><span class="line">&#125;<span class="string">;</span></span><br><span class="line"></span><br><span class="line">&#125;  <span class="string">//</span> <span class="string">namespace</span> <span class="string">Parameter::parameter_module</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>parameter_handle_</code>​句柄可以用来设置和获取参数</li>
</ul>
<h4 id="模块实现"><a href="#模块实现" class="headerlink" title="模块实现"></a>模块实现</h4><h5 id="初始化阶段-5"><a href="#初始化阶段-5" class="headerlink" title="初始化阶段"></a>初始化阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ParameterModule::Initialize</span><span class="params">(aimrt::CoreRef core)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 保存AIMRT框架核心引用</span></span><br><span class="line">  core_ = core;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 获取执行器</span></span><br><span class="line">    work_executor_ = core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;work_thread_pool&quot;</span>);</span><br><span class="line">    <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(</span><br><span class="line">        work_executor_ &amp;&amp; work_executor_.<span class="built_in">SupportTimerSchedule</span>(),</span><br><span class="line">        <span class="string">&quot;获取执行器&#x27;work_thread_pool&#x27;失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取参数操作句柄</span></span><br><span class="line">    parameter_handle_ = core_.<span class="built_in">GetParameterHandle</span>();</span><br><span class="line">    <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(parameter_handle_, <span class="string">&quot;获取参数句柄失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;初始化失败, &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;初始化成功&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>获取执行器<code>work_executor_</code>​</p>
</li>
<li><p>获取参数操作句柄<code>parameter_handle_</code>​</p>
</li>
</ul>
<h5 id="运行阶段-5"><a href="#运行阶段-5" class="headerlink" title="运行阶段"></a>运行阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 启动模块</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ParameterModule::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 将SetParameterLoop方法绑定到当前对象，并提交到工作线程池执行</span></span><br><span class="line">    work_executor_.<span class="built_in">Execute</span>(std::<span class="built_in">bind</span>(&amp;ParameterModule::SetParameterLoop, <span class="keyword">this</span>));</span><br><span class="line">    <span class="comment">// 将GetParameterLoop方法绑定到当前对象，并提交到工作线程池执行</span></span><br><span class="line">    work_executor_.<span class="built_in">Execute</span>(std::<span class="built_in">bind</span>(&amp;ParameterModule::GetParameterLoop, <span class="keyword">this</span>));</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;启动失败, &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;启动成功&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置参数循环任务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ParameterModule::SetParameterLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;开始设置参数循环&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (run_flag_) &#123;</span><br><span class="line">      count++;</span><br><span class="line">      <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;设置参数循环计数: &#123;&#125; -------------------------&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 构造键值对</span></span><br><span class="line">      std::string key = <span class="string">&quot;key-&quot;</span> + std::<span class="built_in">to_string</span>(count);</span><br><span class="line">      std::string val = <span class="string">&quot;val-&quot;</span> + std::<span class="built_in">to_string</span>(count);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置参数</span></span><br><span class="line">      parameter_handle_.<span class="built_in">SetParameter</span>(key, val);</span><br><span class="line">      <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;设置参数, 键: &#x27;&#123;&#125;&#x27;, 值: &#x27;&#123;&#125;&#x27;&quot;</span>, key, val);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 休眠1秒</span></span><br><span class="line">      std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;退出设置参数循环&quot;</span>);</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;设置参数循环异常退出, &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通知循环已停止</span></span><br><span class="line">  set_loop_stop_sig_.<span class="built_in">set_value</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取参数循环任务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ParameterModule::GetParameterLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;开始获取参数循环&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (run_flag_) &#123;</span><br><span class="line">      count++;</span><br><span class="line">      <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;获取参数循环计数: &#123;&#125; -------------------------&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 构造键</span></span><br><span class="line">      std::string key = <span class="string">&quot;key-&quot;</span> + std::<span class="built_in">to_string</span>(count);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取参数值</span></span><br><span class="line">      <span class="keyword">auto</span> val = parameter_handle_.<span class="built_in">GetParameter</span>(key);</span><br><span class="line">      <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;获取参数, 键: &#x27;&#123;&#125;&#x27;, 值: &#x27;&#123;&#125;&#x27;&quot;</span>, key, val);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 休眠1秒</span></span><br><span class="line">      std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;退出获取参数循环&quot;</span>);</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;获取参数循环异常退出, &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通知循环已停止</span></span><br><span class="line">  get_loop_stop_sig_.<span class="built_in">set_value</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>两个循环独立运行但通过共享的<code>parameter_handle_</code>​交互</li>
</ul>
<p>**设置参数循环工作流程：**​<code>SetParameterLoop()</code>​</p>
<ol>
<li>进入无限循环，直到<code>run_flag_</code>​变为false</li>
<li>每次循环生成递增的键值对(key-1&#x2F;val-1, key-2&#x2F;val-2…)</li>
<li>通过参数句柄存储这些参数</li>
<li>每次操作后休眠1秒</li>
<li>退出时发送停止信号</li>
</ol>
<p>**获取参数循环工作流程：**​<code>GetParameterLoop()</code>​</p>
<ol>
<li>进入无限循环，直到<code>run_flag_</code>​变为false</li>
<li>每次循环尝试获取对应键的参数值</li>
<li>记录获取到的参数值</li>
<li>每次操作后休眠1秒</li>
<li>退出时发送停止信号</li>
</ol>
<h5 id="停止阶段-5"><a href="#停止阶段-5" class="headerlink" title="停止阶段"></a>停止阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ParameterModule::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    run_flag_ = <span class="literal">false</span>;                       <span class="comment">// 设置停止标志</span></span><br><span class="line">    set_loop_stop_sig_.<span class="built_in">get_future</span>().<span class="built_in">wait</span>();  <span class="comment">// 等待设置参数循环停止</span></span><br><span class="line">    get_loop_stop_sig_.<span class="built_in">get_future</span>().<span class="built_in">wait</span>();  <span class="comment">// 等待获取参数循环停止</span></span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;关闭失败, &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;关闭成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对应的启动配置文件-9"><a href="#对应的启动配置文件-9" class="headerlink" title="对应的启动配置文件"></a>对应的启动配置文件</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">aimrt:</span><br><span class="line">  log:</span><br><span class="line">    core_lvl: INFO # Trace/Debug/Info/Warn/Error/Fatal/Off</span><br><span class="line">    backends:</span><br><span class="line">      - type: console</span><br><span class="line">  executor:</span><br><span class="line">    executors:</span><br><span class="line">      - name: work_thread_pool</span><br><span class="line">        type: asio_thread</span><br><span class="line">        options:</span><br><span class="line">          thread_num: <span class="number">2</span></span><br><span class="line">  <span class="keyword">module</span>:</span><br><span class="line">    pkgs:</span><br><span class="line">      - path: ./libparameter_pkg.so</span><br><span class="line">        enable_modules: [ParameterModule]</span><br><span class="line">    modules:</span><br><span class="line">      - name: ParameterModule</span><br><span class="line">        log_lvl: INFO</span><br></pre></td></tr></table></figure>

<h1 id="pb-chn示例"><a href="#pb-chn示例" class="headerlink" title="pb_chn示例"></a>pb_chn示例</h1><p>官方仓库：<a target="_blank" rel="noopener" href="https://github.com/AimRT/AimRT/tree/main/src/examples/cpp/pb_chn">pb_chn</a></p>
<p>这个官方示例展示了如何基于 protobuf 协议和 local 后端实现 channel 通信。主要包括四种场景：</p>
<ol>
<li><strong>基础示例</strong>：分别用两个模块（Publisher 和 Subscriber）发布和订阅 protobuf 消息，使用 local channel 通信。</li>
<li><strong>单 Pkg 集成</strong>：与基础示例类似，但将发布和订阅模块集成到同一个 Pkg 运行。</li>
<li><strong>Publisher App 模式</strong>：以 App 模式直接运行 Publisher，同时以 Module 方式运行 Subscriber。</li>
<li><strong>Subscriber App 模式</strong>：以 App 模式直接运行 Subscriber，同时以 Module 方式运行 Publisher。</li>
</ol>
<p>需要先阅读一下官方文档的相关内容：<a target="_blank" rel="noopener" href="https://docs.aimrt.org/v0.10.0/tutorials/interface_cpp/channel.html#channel">Channel</a> 章节</p>
<p><em>这里我们没有复现</em>​<em>​<code>benchmark</code>​</em>​<em>两个模块，只关注通信相关内容。</em></p>
<h2 id="配置文件-configuration-protobuf-channel-yaml"><a href="#配置文件-configuration-protobuf-channel-yaml" class="headerlink" title="配置文件(configuration_protobuf_channel.yaml)"></a>配置文件(configuration_protobuf_channel.yaml)</h2><p>依据官方示例项目结构自行编写YAML配置文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"># ============== 基础信息 ==============</span><br><span class="line">base_info:</span><br><span class="line">  project_name: Protobuf_channel # 项目名称</span><br><span class="line">  build_mode_tags: [<span class="string">&quot;EXAMPLE&quot;</span>, <span class="string">&quot;SIMULATION&quot;</span>, <span class="string">&quot;TEST_CAMERA&quot;</span>] # 构建模式标签</span><br><span class="line">  aimrt_import_options: # AimRT 框架构建选项</span><br><span class="line">    AIMRT_BUILD_WITH_PROTOBUF: <span class="string">&quot;ON&quot;</span> # 启用 Protobuf 支持（必须开启）</span><br><span class="line">    AIMRT_BUILD_RUNTIME: <span class="string">&quot;ON&quot;</span> # 启用模块化运行支持（必须开启）</span><br><span class="line">    AIMRT_BUILD_TESTS: <span class="string">&quot;OFF&quot;</span> # 关闭测试模块构建</span><br><span class="line">    AIMRT_BUILD_EXAMPLES: <span class="string">&quot;OFF&quot;</span> # 关闭示例构建（实际跑示例需打开）</span><br><span class="line">    AIMRT_BUILD_DOCUMENT: <span class="string">&quot;OFF&quot;</span> # 关闭文档构建</span><br><span class="line">    AIMRT_BUILD_CLI_TOOLS: <span class="string">&quot;OFF&quot;</span> # 关闭命令行工具</span><br><span class="line">    AIMRT_USE_LOCAL_PROTOC_COMPILER: <span class="string">&quot;OFF&quot;</span> # 使用内置 Protoc 编译器</span><br><span class="line">    AIMRT_BUILD_WITH_ROS2: <span class="string">&quot;OFF&quot;</span> # 关闭 ROS2 支持</span><br><span class="line">    AIMRT_BUILD_NET_PLUGIN: <span class="string">&quot;OFF&quot;</span> # 关闭网络插件</span><br><span class="line">    AIMRT_BUILD_ROS2_PLUGIN: <span class="string">&quot;OFF&quot;</span> # 关闭 ROS2 插件</span><br><span class="line"></span><br><span class="line"># ============== 协议配置 ==============</span><br><span class="line">protocols:</span><br><span class="line">  - name: my_proto</span><br><span class="line">    type: protobuf</span><br><span class="line">    options:</span><br><span class="line">      xxx: xxx # 预留可扩展选项</span><br><span class="line"></span><br><span class="line">  # 以下为注释掉的备用协议示例：</span><br><span class="line">  # - name: my_ros2_proto</span><br><span class="line">  <span class="meta">#   type: ros2</span></span><br><span class="line">  <span class="meta">#   options:</span></span><br><span class="line">  <span class="meta">#     zzz: zzz</span></span><br><span class="line">  #   build_mode_tag: [<span class="string">&quot;EXAMPLE&quot;</span>]</span><br><span class="line">  #</span><br><span class="line">  # - name: example_proto</span><br><span class="line">  <span class="meta">#   type: protobuf</span></span><br><span class="line">  #   build_mode_tag: [<span class="string">&quot;EXAMPLE&quot;</span>] # 仅在 EXAMPLE 模式启用</span><br><span class="line"></span><br><span class="line"># ============== 模块定义 ==============</span><br><span class="line">modules:</span><br><span class="line">  - name: normal_publisher_module # 定期发布 ExampleEventMsg 消息</span><br><span class="line">  - name: normal_subscriber_module # 订阅并处理 ExampleEventMsg 消息</span><br><span class="line"></span><br><span class="line"># ============== 包组合配置 ==============</span><br><span class="line">pkgs:</span><br><span class="line">  - name: protobuf_channel_pkg # 单包整合示例</span><br><span class="line">    modules:</span><br><span class="line">      - name: normal_publisher_module</span><br><span class="line">      - name: normal_subscriber_module</span><br><span class="line"></span><br><span class="line">  - name: protobuf_channel_pub_pkg # 发布模块包（仅发布者）</span><br><span class="line">    modules:</span><br><span class="line">      - name: normal_publisher_module</span><br><span class="line"></span><br><span class="line">  - name: protobuf_channel_sub_pkg # 订阅模块包（仅订阅者）</span><br><span class="line">    modules:</span><br><span class="line">      - name: normal_subscriber_module</span><br><span class="line"></span><br><span class="line"># ============== 部署方案 ==============</span><br><span class="line">deploy_modes:</span><br><span class="line">  - name: local_deploy # 本地部署方案</span><br><span class="line">    deploy_ins:</span><br><span class="line">      - name: local_ins_protobuf_channel # 双包部署（发布+订阅分开）</span><br><span class="line">        pkgs:</span><br><span class="line">          - name: protobuf_channel_pub_pkg</span><br><span class="line">          - name: protobuf_channel_sub_pkg</span><br><span class="line"></span><br><span class="line">      - name: local_ins_protobuf_channel_single_pkg # 单包部署（发布+订阅合一）</span><br><span class="line">        pkgs:</span><br><span class="line">          - name: protobuf_channel_pkg</span><br><span class="line"></span><br><span class="line">## ========================================================</span><br><span class="line">## 官方工具似乎不支持 App 模式，因此相关文件需要手动配置。</span><br><span class="line">## 发布配置主要影响后续生成的 cfg 文件和启动脚本。</span><br><span class="line">## 可以将以下内容添加到配置文件中，但仍需手动调整。</span><br><span class="line">## ========================================================</span><br><span class="line"># - name: local_ins_protobuf_channel_publisher_app <span class="meta"># app发布</span></span><br><span class="line"><span class="meta">#   pkgs:</span></span><br><span class="line">#     - name: protobuf_channel_sub_pkg # 订阅模块包，用于订阅app发布的消息</span><br><span class="line"></span><br><span class="line"># - name: local_ins_protobuf_channel_subscriber_app <span class="meta"># app订阅</span></span><br><span class="line"><span class="meta">#   pkgs:</span></span><br><span class="line">#     - name: protobuf_channel_pub_pkg # 发布模块包，用于向app发布消息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="protocols目录"><a href="#protocols目录" class="headerlink" title="protocols目录"></a>protocols目录</h2><p>这是配置文件中 <strong>协议</strong> 部分生成的目录，管理通信协议相关的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protocols/</span><br><span class="line">└── my_proto</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    └── my_proto.proto</span><br></pre></td></tr></table></figure>

<h3 id="my-proto-proto文件"><a href="#my-proto-proto文件" class="headerlink" title="my_proto.proto文件"></a>my_proto.proto文件</h3><p>用来定义通信的消息类型</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> Protobuf_channel.my_proto;	<span class="comment">// 命名空间：Protobuf_channel::my_proto</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这里定义您的消息</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">ExampleEventMsg</span> &#123;</span><br><span class="line">  <span class="type">string</span> msg = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int32</span> num = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CMakeLists-txt文件"><a href="#CMakeLists-txt文件" class="headerlink" title="CMakeLists.txt文件"></a>CMakeLists.txt文件</h3><p>AimRT框架封装了从Protobuf生成c++代码的操作，只需要使用提供的CMake 方法即可。相关内容见官方文档：<a target="_blank" rel="noopener" href="https://docs.aimrt.org/v0.10.0/tutorials/interface_cpp/channel.html#protobuf">Protobuf封装</a></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get the current folder name</span></span><br><span class="line"><span class="keyword">string</span>(REGEX REPLACE <span class="string">&quot;.*/\(.*\)&quot;</span> <span class="string">&quot;\\1&quot;</span> CUR_DIR <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get namespace</span></span><br><span class="line">get_namespace(CUR_SUPERIOR_NAMESPACE)</span><br><span class="line"><span class="keyword">string</span>(REPLACE <span class="string">&quot;::&quot;</span> <span class="string">&quot;_&quot;</span> CUR_SUPERIOR_NAMESPACE_UNDERLINE <span class="variable">$&#123;CUR_SUPERIOR_NAMESPACE&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set target name</span></span><br><span class="line"><span class="keyword">set</span>(CUR_TARGET_NAME <span class="variable">$&#123;CUR_SUPERIOR_NAMESPACE_UNDERLINE&#125;</span>_<span class="variable">$&#123;CUR_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">set</span>(CUR_TARGET_ALIAS_NAME <span class="variable">$&#123;CUR_SUPERIOR_NAMESPACE&#125;</span>::<span class="variable">$&#123;CUR_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add target</span></span><br><span class="line">add_protobuf_gencode_target_for_proto_path(</span><br><span class="line">  TARGET_NAME <span class="variable">$&#123;CUR_TARGET_NAME&#125;</span>_pb_gencode</span><br><span class="line">  PROTO_PATH <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">  GENCODE_PATH <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">add_library</span>(<span class="variable">$&#123;CUR_TARGET_ALIAS_NAME&#125;</span>_pb_gencode ALIAS <span class="variable">$&#123;CUR_TARGET_NAME&#125;</span>_pb_gencode)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set installation</span></span><br><span class="line"><span class="keyword">install</span>(</span><br><span class="line">  DIRECTORY <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">  DESTINATION <span class="string">&quot;share&quot;</span></span><br><span class="line">  FILES_MATCHING</span><br><span class="line">  PATTERN <span class="string">&quot;*.proto&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set_property</span>(<span class="keyword">TARGET</span> <span class="variable">$&#123;CUR_TARGET_NAME&#125;</span>_pb_gencode PROPERTY EXPORT_NAME <span class="variable">$&#123;CUR_TARGET_ALIAS_NAME&#125;</span>_pb_gencode)</span><br><span class="line"><span class="keyword">install</span>(</span><br><span class="line">  TARGETS <span class="variable">$&#123;CUR_TARGET_NAME&#125;</span>_pb_gencode</span><br><span class="line">  <span class="keyword">EXPORT</span> <span class="variable">$&#123;INSTALL_CONFIG_NAME&#125;</span></span><br><span class="line">  ARCHIVE DESTINATION lib</span><br><span class="line">          FILE_SET HEADERS</span><br><span class="line">          DESTINATION <span class="keyword">include</span>/<span class="variable">$&#123;CUR_TARGET_NAME&#125;</span>_pb_gencode)</span><br></pre></td></tr></table></figure>

<p>最终生成的Target需要链接到模块，可以在Cmake文件最后添加下面的内容，查看Target名称</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打印最终Target名称</span></span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;最终Target名称 - CUR_TARGET_NAME: $&#123;CUR_TARGET_NAME&#125;_pb_gencode&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="module目录-4"><a href="#module目录-4" class="headerlink" title="module目录"></a>module目录</h2><h3 id="normal-publisher-module"><a href="#normal-publisher-module" class="headerlink" title="normal_publisher_module"></a>normal_publisher_module</h3><h4 id="链接生成的消息文件-CMakeLists-txt​"><a href="#链接生成的消息文件-CMakeLists-txt​" class="headerlink" title="链接生成的消息文件(CMakeLists.txt​)"></a>链接生成的消息文件(<code>CMakeLists.txt</code>​)</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 略</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set link libraries of target</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(</span><br><span class="line">  <span class="variable">$&#123;CUR_TARGET_NAME&#125;</span></span><br><span class="line">  PRIVATE yaml-cpp::yaml-cpp</span><br><span class="line">  PUBLIC aimrt::interface::aimrt_module_cpp_interface</span><br><span class="line">  PUBLIC Protobuf_channel_my_proto_pb_gencode)  <span class="comment"># 在这里进行链接</span></span><br></pre></td></tr></table></figure>

<h4 id="模块定义-normal-publisher-module-h​"><a href="#模块定义-normal-publisher-module-h​" class="headerlink" title="模块定义(normal_publisher_module.h​)"></a>模块定义(<code>normal_publisher_module.h</code>​)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/module_base.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Protobuf_channel::normal_publisher_module &#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> aimrt;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 普通发布者模块类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 该模块用于定期发布Protobuf格式的消息到指定主题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NormalPublisherModule</span> : <span class="keyword">public</span> aimrt::ModuleBase &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">NormalPublisherModule</span>() = <span class="keyword">default</span>;</span><br><span class="line">  ~<span class="built_in">NormalPublisherModule</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取模块基本信息</span></span><br><span class="line">  <span class="function">ModuleInfo <span class="title">Info</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ModuleInfo&#123;.name = <span class="string">&quot;NormalPublisherModule&quot;</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Initialize</span><span class="params">(aimrt::CoreRef core)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">Start</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// 获取日志记录器</span></span><br><span class="line">  <span class="function"><span class="keyword">auto</span> <span class="title">GetLogger</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> core_.<span class="built_in">GetLogger</span>(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主工作循环</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">MainLoop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  aimrt::CoreRef core_;                    <span class="comment">// 核心系统引用</span></span><br><span class="line">  aimrt::executor::ExecutorRef executor_;  <span class="comment">// 任务执行器引用</span></span><br><span class="line"></span><br><span class="line">  std::atomic_bool run_flag_ = <span class="literal">false</span>;  <span class="comment">// 运行状态标志</span></span><br><span class="line">  std::promise&lt;<span class="type">void</span>&gt; stop_sig_;        <span class="comment">// 停止信号量</span></span><br><span class="line"></span><br><span class="line">  std::string topic_name_ = <span class="string">&quot;test_topic&quot;</span>;   <span class="comment">// 发布主题名称</span></span><br><span class="line">  <span class="type">double</span> channel_frq_ = <span class="number">0.5</span>;                <span class="comment">// 发布频率(Hz)</span></span><br><span class="line">  aimrt::channel::PublisherRef publisher_;  <span class="comment">// 消息发布器引用</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace Protobuf_channel::normal_publisher_module</span></span><br></pre></td></tr></table></figure>

<ul>
<li>定期发布Protobuf格式的消息到指定主题</li>
</ul>
<h4 id="模块实现-normal-publisher-module-cc​"><a href="#模块实现-normal-publisher-module-cc​" class="headerlink" title="模块实现(normal_publisher_module.cc​)"></a>模块实现(<code>normal_publisher_module.cc</code>​)</h4><h5 id="初始化阶段-6"><a href="#初始化阶段-6" class="headerlink" title="初始化阶段"></a>初始化阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">NormalPublisherModule::Initialize</span><span class="params">(aimrt::CoreRef core)</span> </span>&#123;</span><br><span class="line">  core_ = core;  <span class="comment">// 保存 CoreRef，后续模块操作需要用到</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// === Step 1: 从配置文件读取 topic 和发布频率 ===</span></span><br><span class="line">    <span class="keyword">auto</span> file_path = core_.<span class="built_in">GetConfigurator</span>().<span class="built_in">GetConfigFilePath</span>();</span><br><span class="line">    <span class="keyword">if</span> (!file_path.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">      YAML::Node cfg_node = YAML::<span class="built_in">LoadFile</span>(std::<span class="built_in">string</span>(file_path));</span><br><span class="line">      topic_name_ = cfg_node[<span class="string">&quot;topic_name&quot;</span>].<span class="built_in">as</span>&lt;std::string&gt;();</span><br><span class="line">      channel_frq_ = cfg_node[<span class="string">&quot;channel_frq&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">double</span>&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === Step 2: 获取执行器 ExecutorRef（用来安排任务执行） ===</span></span><br><span class="line">    executor_ = core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;work_thread_pool&quot;</span>);</span><br><span class="line">    <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(executor_ &amp;&amp; executor_.<span class="built_in">SupportTimerSchedule</span>(),</span><br><span class="line">                            <span class="string">&quot;获取执行器&#x27;work_thread_pool&#x27;失败&quot;</span>);</span><br><span class="line">    <span class="comment">// ➔ Note: Executor 是 AimRT</span></span><br><span class="line">    <span class="comment">// 中安排异步任务的组件，类似“线程池”或“定时器调度器”</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === Step 3: 获取 PublisherRef（即通道的发布句柄） ===</span></span><br><span class="line">    publisher_ = core_.<span class="built_in">GetChannelHandle</span>().<span class="built_in">GetPublisher</span>(topic_name_);</span><br><span class="line">    <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(publisher_, <span class="string">&quot;获取主题&#x27;&#123;&#125;&#x27;的发布者失败&quot;</span>,</span><br><span class="line">                            topic_name_);</span><br><span class="line">    <span class="comment">// ➔ Note: PublisherRef 是发布消息用的关键对象，相当于“话题写入器”</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === Step 4: 注册消息类型（必须要做！）===</span></span><br><span class="line">    <span class="type">bool</span> ret = aimrt::channel::<span class="built_in">RegisterPublishType</span>&lt;</span><br><span class="line">        Protobuf_channel::my_proto::ExampleEventMsg&gt;(publisher_);</span><br><span class="line">    <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(ret, <span class="string">&quot;注册发布类型失败&quot;</span>);</span><br><span class="line">    <span class="comment">// ➔ Note: 必须告诉系统：这个 Publisher 上发送的是 ExampleEventMsg 类型的</span></span><br><span class="line">    <span class="comment">// Protobuf 消息。</span></span><br><span class="line"></span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;初始化失败, 错误信息: &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块初始化成功&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>获取了配置文件中的相关配置</p>
</li>
<li><p>获取了执行器<code>executor_</code>​</p>
</li>
<li><p>获取了消息发布者<code>publisher_</code>​</p>
</li>
<li><p>对消息类型进行注册</p>
</li>
</ul>
<h5 id="运行阶段-6"><a href="#运行阶段-6" class="headerlink" title="运行阶段"></a>运行阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">NormalPublisherModule::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    run_flag_ = <span class="literal">true</span>;  <span class="comment">// 设置运行标志，控制主循环</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 启动主循环任务 ===</span></span><br><span class="line">    executor_.<span class="built_in">Execute</span>(std::<span class="built_in">bind</span>(&amp;NormalPublisherModule::MainLoop, <span class="keyword">this</span>));</span><br><span class="line">    <span class="comment">// ➔ Note: 这里没有直接启动线程，而是通过 executor 异步调度执行</span></span><br><span class="line">    <span class="comment">// MainLoop（即委托给了 AimRT 的调度器管理）</span></span><br><span class="line"></span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;模块启动失败, 错误信息: &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块启动成功&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NormalPublisherModule::MainLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;主工作循环开始运行&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === 创建 PublisherProxy，简化消息发布过程 ===</span></span><br><span class="line">    aimrt::<span class="function">channel::PublisherProxy&lt;Protobuf_channel::my_proto::ExampleEventMsg&gt;</span></span><br><span class="line"><span class="function">        <span class="title">publisher_proxy</span><span class="params">(publisher_)</span></span>;</span><br><span class="line">    <span class="comment">// ➔ Note: 绑定 publisher_，后面发布时只需要传 msg，不用每次带 PublisherRef</span></span><br><span class="line">    <span class="comment">// ➔ Note: Proxy 还能管理 Context，更高级</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (run_flag_) &#123;</span><br><span class="line">      <span class="comment">// === 按配置的发布频率休眠 ===</span></span><br><span class="line">      std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(</span><br><span class="line">          <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(<span class="number">1000</span> / channel_frq_)));</span><br><span class="line"></span><br><span class="line">      count++;</span><br><span class="line">      <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;发布循环计数: &#123;&#125;&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// === 构造并填充消息 ===</span></span><br><span class="line">      Protobuf_channel::my_proto::ExampleEventMsg msg;</span><br><span class="line">      msg.<span class="built_in">set_msg</span>(<span class="string">&quot;当前计数: &quot;</span> + std::<span class="built_in">to_string</span>(count));  <span class="comment">// 设置文本字段</span></span><br><span class="line">      msg.<span class="built_in">set_num</span>(count);                                 <span class="comment">// 设置数字字段</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// === 发布消息 ===</span></span><br><span class="line">      <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;发布新消息, 内容: &#123;&#125;&quot;</span>, aimrt::<span class="built_in">Pb2CompactJson</span>(msg));</span><br><span class="line">      publisher_proxy.<span class="built_in">Publish</span>(msg);</span><br><span class="line">      <span class="comment">// ➔ Note: Publish是异步的，实际发送取决于通道后端的实现</span></span><br><span class="line">      <span class="comment">// ➔ Note: 如果后端阻塞，可能导致 Publish 耗时不稳定，但一般很快返回</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;主工作循环正常退出&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;主工作循环异常退出, 错误信息: &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通知 Shutdown 主线程，主循环已经结束</span></span><br><span class="line">  stop_sig_.<span class="built_in">set_value</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过执行器绑定<code>MainLoop</code>​函数</p>
</li>
<li><p><code>MainLoop</code>​函数首先创建了一个发布代理<code>publisher_proxy</code>​，用来简化消息发布操作（绑定 publisher_，后面发布时只需要传 msg，不用每次带 PublisherRef）</p>
</li>
<li><p>构造并填充消息，进行发布</p>
</li>
</ul>
<h5 id="停止阶段-6"><a href="#停止阶段-6" class="headerlink" title="停止阶段"></a>停止阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">NormalPublisherModule::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (run_flag_) &#123;</span><br><span class="line">      run_flag_ = <span class="literal">false</span>;              <span class="comment">// 通知主循环退出</span></span><br><span class="line">      stop_sig_.<span class="built_in">get_future</span>().<span class="built_in">wait</span>();  <span class="comment">// 等待 MainLoop 退出信号</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;模块关闭失败, 错误信息: &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块已正常关闭&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过信号量通知进行优雅退出</li>
</ul>
<h3 id="normal-subscriber-module"><a href="#normal-subscriber-module" class="headerlink" title="normal_subscriber_module"></a>normal_subscriber_module</h3><h4 id="链接生成的消息文件-CMakeLists-txt​-1"><a href="#链接生成的消息文件-CMakeLists-txt​-1" class="headerlink" title="链接生成的消息文件(CMakeLists.txt​)"></a>链接生成的消息文件(<code>CMakeLists.txt</code>​)</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 略</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set link libraries of target</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(</span><br><span class="line">  <span class="variable">$&#123;CUR_TARGET_NAME&#125;</span></span><br><span class="line">  PRIVATE yaml-cpp::yaml-cpp</span><br><span class="line">  PUBLIC aimrt::interface::aimrt_module_cpp_interface</span><br><span class="line">  PUBLIC Protobuf_channel_my_proto_pb_gencode)	<span class="comment"># 链接生成的消息文件</span></span><br></pre></td></tr></table></figure>

<h4 id="模块定义-normal-subscriber-module-h​"><a href="#模块定义-normal-subscriber-module-h​" class="headerlink" title="模块定义(normal_subscriber_module.h​)"></a>模块定义(<code>normal_subscriber_module.h</code>​)</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pragma once</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &quot;aimrt_module_cpp_interface/module_base.h&quot;</span></span><br><span class="line"><span class="comment">#include &quot;my_proto.pb.h&quot;  // 自定义Protobuf消息头文件</span></span><br><span class="line"></span><br><span class="line">namespace Protobuf_channel::normal_subscriber_module &#123;</span><br><span class="line">using namespace aimrt;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @brief 普通订阅者模块类</span><br><span class="line"> *</span><br><span class="line"> * 该模块用于订阅并处理Protobuf格式的消息</span><br><span class="line"> */</span><br><span class="line">class NormalSubscriberModule : public aimrt::ModuleBase &#123;</span><br><span class="line"> public:</span><br><span class="line">  NormalSubscriberModule() = default;</span><br><span class="line">  ~NormalSubscriberModule() override = default;</span><br><span class="line"></span><br><span class="line">  // 获取模块基本信息</span><br><span class="line">  ModuleInfo Info() const override &#123;</span><br><span class="line">    <span class="keyword">return</span> ModuleInfo&#123;.name = <span class="string">&quot;NormalSubscriberModule&quot;</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  bool Initialize(aimrt::CoreRef core) override;  // 初始化模块</span><br><span class="line">  bool Start() override;                          // 启动模块</span><br><span class="line">  void Shutdown() override;                       // 关闭模块</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  // 获取日志记录器</span><br><span class="line">  auto GetLogger() &#123; <span class="keyword">return</span> core_.GetLogger(); &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @brief 事件处理回调函数</span><br><span class="line">   * @param ctx 消息上下文</span><br><span class="line">   * @param data 接收到的消息数据</span><br><span class="line">   */</span><br><span class="line">  void EventHandle(</span><br><span class="line">      aimrt::channel::ContextRef</span><br><span class="line">          ctx,  // 上下文信息是由AimRT系统框架传递的，在编译期确定</span><br><span class="line">      const std::shared_ptr&lt;const Protobuf_channel::my_proto::ExampleEventMsg&gt;&amp;</span><br><span class="line">          data);</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  aimrt::CoreRef core_;                       // 核心系统引用</span><br><span class="line">  std::<span class="keyword">string</span> topic_name_ = <span class="string">&quot;test_topic&quot;</span>;     // 订阅主题名称</span><br><span class="line">  aimrt::channel::SubscriberRef subscriber_;  // 消息订阅者引用</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace Protobuf_channel::normal_subscriber_module</span><br></pre></td></tr></table></figure>

<h4 id="模块实现-normal-subscriber-module-cc​"><a href="#模块实现-normal-subscriber-module-cc​" class="headerlink" title="模块实现(normal_subscriber_module.cc​)"></a>模块实现(<code>normal_subscriber_module.cc</code>​)</h4><h5 id="初始化阶段-7"><a href="#初始化阶段-7" class="headerlink" title="初始化阶段"></a>初始化阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">NormalSubscriberModule::Initialize</span><span class="params">(aimrt::CoreRef core)</span> </span>&#123;</span><br><span class="line">  core_ = core;  <span class="comment">// 保存 CoreRef，后续操作模块需要用到</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// === Step 1: 读取配置文件，拿到订阅的话题名 ===</span></span><br><span class="line">    <span class="keyword">auto</span> file_path = core_.<span class="built_in">GetConfigurator</span>().<span class="built_in">GetConfigFilePath</span>();</span><br><span class="line">    <span class="keyword">if</span> (!file_path.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">      YAML::Node cfg_node = YAML::<span class="built_in">LoadFile</span>(std::<span class="built_in">string</span>(file_path));</span><br><span class="line">      topic_name_ = cfg_node[<span class="string">&quot;topic_name&quot;</span>].<span class="built_in">as</span>&lt;std::string&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === Step 2: 获取SubscriberRef，准备订阅主题 ===</span></span><br><span class="line">    subscriber_ = core_.<span class="built_in">GetChannelHandle</span>().<span class="built_in">GetSubscriber</span>(topic_name_);</span><br><span class="line">    <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(subscriber_, <span class="string">&quot;获取主题&#x27;&#123;&#125;&#x27;的订阅者失败&quot;</span>,</span><br><span class="line">                            topic_name_);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// === Step 3: 注册消息订阅回调 ===</span></span><br><span class="line">    <span class="type">bool</span> ret =</span><br><span class="line">        aimrt::channel::<span class="built_in">Subscribe</span>&lt;Protobuf_channel::my_proto::ExampleEventMsg&gt;(</span><br><span class="line">            subscriber_,</span><br><span class="line">            std::<span class="built_in">bind</span>(&amp;NormalSubscriberModule::EventHandle, <span class="keyword">this</span>,</span><br><span class="line">                      std::placeholders::_1, std::placeholders::_2));</span><br><span class="line">    <span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(ret, <span class="string">&quot;订阅消息失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ➔ Note: 这里使用的是【函数风格】【带 Context</span></span><br><span class="line">    <span class="comment">// 参数】【智能指针回调】的订阅形式</span></span><br><span class="line">    <span class="comment">// ➔ Note: 必须在 Initialize阶段完成订阅，运行中不允许动态订阅</span></span><br><span class="line"></span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    <span class="built_in">AIMRT_ERROR</span>(<span class="string">&quot;初始化失败，错误信息: &#123;&#125;&quot;</span>, e.<span class="built_in">what</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;模块初始化成功&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NormalSubscriberModule::EventHandle</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    aimrt::channel::ContextRef ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> Protobuf_channel::my_proto::ExampleEventMsg&gt;&amp;</span></span></span><br><span class="line"><span class="params"><span class="function">        data)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// === Step 4: 处理收到的新消息 ===</span></span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;收到新消息，上下文: &#123;&#125;, 数据内容: &#123;&#125;&quot;</span>, ctx.<span class="built_in">ToString</span>(),</span><br><span class="line">             aimrt::<span class="built_in">Pb2CompactJson</span>(*data));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ➔ Note: ContextRef</span></span><br><span class="line">  <span class="comment">// 提供了消息链路、来源、发送时间等上下文信息，可以根据需要提取</span></span><br><span class="line">  <span class="comment">// ➔ Note: data 是 Protobuf 消息的【const智能指针】，直接解引用使用即可</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取配置文件中的相关配置</li>
<li>获取订阅者<code>subscriber_</code>​</li>
<li>注册消息订阅回调<code>EventHandle</code>​函数</li>
<li><strong>注意点：可以看到回调函数会接收一个</strong>​<strong>​<code>ctx</code>​</strong>​<strong>上下文参数，而我们编写的发布者并没有看到这个数据。</strong></li>
<li><strong>这个上下文参数是由AimRT框架自动传入的，也可以只保留</strong>​<strong>​<code>data</code>​</strong>​<strong>一个参数。这一过程是在编译期确定的</strong></li>
</ul>
<h5 id="运行阶段-7"><a href="#运行阶段-7" class="headerlink" title="运行阶段"></a>运行阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">NormalSubscriberModule::Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 当前 Start 阶段无特定动作，AimRT 框架会自动管理订阅回调的调度</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="停止阶段-7"><a href="#停止阶段-7" class="headerlink" title="停止阶段"></a>停止阶段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">NormalSubscriberModule::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 当前 Shutdown 阶段无特定动作，SubscriberRef 生命周期随模块销毁而结束</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="启动Pkg模式通信示例"><a href="#启动Pkg模式通信示例" class="headerlink" title="启动Pkg模式通信示例"></a>启动Pkg模式通信示例</h2><h3 id="protobuf-channel"><a href="#protobuf-channel" class="headerlink" title="protobuf channel"></a>protobuf channel</h3><p>一个最基本的、基于 protobuf 协议与 local 后端的 channel 示例，演示内容包括：</p>
<ul>
<li>如何使用 protobuf 协议作为 channel 传输协议；</li>
<li>如何基于 Module 方式使用 Executor、Channel publish 和 subscribe 功能；</li>
<li>如何使用 local 类型的 channel 后端；</li>
<li>如何以 Pkg 模式集成 Module 并启动；</li>
</ul>
<h4 id="对应配置文件-cfg-local-deploy-local-ins-protobuf-channel-cfg-yaml​"><a href="#对应配置文件-cfg-local-deploy-local-ins-protobuf-channel-cfg-yaml​" class="headerlink" title="对应配置文件(cfg/local_deploy_local_ins_protobuf_channel_cfg.yaml​)"></a>对应配置文件(<code>cfg/local_deploy_local_ins_protobuf_channel_cfg.yaml</code>​)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aimrt:</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span> <span class="comment"># Trace/Debug/Info/Warn/Error/Fatal/Off</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_thread_pool</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">4</span></span><br><span class="line">  <span class="comment"># 消息通道相关配置官方文档：https://docs.aimrt.org/v0.10.0/tutorials/cfg/channel.html#aimrt-channel</span></span><br><span class="line">  <span class="attr">channel:</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">local</span> <span class="comment"># local类型的 Channel 后端是 AimRT 官方提供的一种 Channel 后端，用于将消息发布到同进程中的其他模块，它会自动判断发布端和订阅端是否在同一个Pkg内，从而采用各种方式进行性能的优化</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">subscriber_use_inline_executor:</span> <span class="literal">false</span> <span class="comment"># 如果配置为true，则直接使用发布端的执行器来执行订阅端的回调，会阻塞发布端的 Publish 方法直到所有的订阅端回调都执行完成</span></span><br><span class="line">          <span class="attr">subscriber_executor:</span> <span class="string">work_thread_pool</span> <span class="comment"># 仅在subscriber_use_inline_executor为false时生效，后端会将订阅端的回调都投递进此执行器中异步执行，发布端的 Publish 方法会立即返回</span></span><br><span class="line">    <span class="attr">pub_topics_options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">        <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br><span class="line">    <span class="attr">sub_topics_options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">        <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br><span class="line"></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./libprotobuf_channel_pub_pkg.so</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./libprotobuf_channel_sub_pkg.so</span></span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NormalPublisherModule</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NormalSubscriberModule</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块自定义配置</span></span><br><span class="line"><span class="attr">NormalPublisherModule:</span></span><br><span class="line">  <span class="attr">topic_name:</span> <span class="string">test_topic</span> <span class="comment"># topic名称</span></span><br><span class="line">  <span class="attr">channel_frq:</span> <span class="number">0.5</span> <span class="comment"># 0.5Hz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">NormalSubscriberModule:</span></span><br><span class="line">  <span class="attr">topic_name:</span> <span class="string">test_topic</span></span><br></pre></td></tr></table></figure>

<p>消息通道相关配置官方文档：<a target="_blank" rel="noopener" href="https://docs.aimrt.org/v0.10.0/tutorials/cfg/channel.html#aimrt-channel">配置文件-通道</a></p>
<p>说明：</p>
<ul>
<li><p>此示例创建了以下两个模块：</p>
<ul>
<li><code>NormalPublisherModule</code>​：会基于 <code>work_thread_pool</code>​ 执行器，以配置的频率、向配置的 topic 中发布 <code>ExampleEventMsg</code>​ 类型的消息；</li>
<li><code>NormalSubscriberModule</code>​：会订阅配置的 topic 下的 <code>ExampleEventMsg</code>​ 类型的消息；</li>
</ul>
</li>
<li><p>此示例将 <code>NormalPublisherModule</code>​ 和 <code>NormalSubscriberModule</code>​ 分别集成到 <code>pb_chn_pub_pkg</code>​ 和 <code>pb_chn_sub_pkg</code>​ 两个 Pkg 中，并在配置文件中加载这两个 Pkg 到一个 AimRT 进程中；</p>
</li>
<li><p>此示例使用 local 类型的 channel 后端进行通信；</p>
</li>
</ul>
<h4 id="以pkg模式启动"><a href="#以pkg模式启动" class="headerlink" title="以pkg模式启动"></a>以pkg模式启动</h4><p>启动命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./aimrt_main --cfg_file_path=./cfg/local_deploy_local_ins_protobuf_channel_cfg.yaml</span><br></pre></td></tr></table></figure>

<p>如果是通过<code>aimrt_cli</code>​工具生成代码框架，则执行<code>start_local_deploy_local_ins_protobuf_channel.sh</code>​脚本</p>
<h3 id="protobuf-channel-single-pkg"><a href="#protobuf-channel-single-pkg" class="headerlink" title="protobuf channel single pkg"></a>protobuf channel single pkg</h3><p>一个最基本的、基于 protobuf 协议与 local 后端的 channel 示例，演示内容包括：</p>
<ul>
<li>如何使用 protobuf 协议作为 channel 传输协议；</li>
<li>如何基于 Module 方式使用 Executor、Channel publish 和 subscribe 功能；</li>
<li>如何使用 local 类型的 channel 后端；</li>
<li>如何以 Pkg 模式集成 Module 并启动；</li>
</ul>
<h4 id="对应配置文件-cfg-local-deploy-local-ins-protobuf-channel-single-pkg-cfg-yaml​"><a href="#对应配置文件-cfg-local-deploy-local-ins-protobuf-channel-single-pkg-cfg-yaml​" class="headerlink" title="对应配置文件(cfg/local_deploy_local_ins_protobuf_channel_single_pkg_cfg.yaml​)"></a>对应配置文件(<code>cfg/local_deploy_local_ins_protobuf_channel_single_pkg_cfg.yaml</code>​)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aimrt:</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span> <span class="comment"># Trace/Debug/Info/Warn/Error/Fatal/Off</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_thread_pool</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">channel:</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">subscriber_use_inline_executor:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">subscriber_executor:</span> <span class="string">work_thread_pool</span></span><br><span class="line">    <span class="attr">pub_topics_options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">        <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br><span class="line">    <span class="attr">sub_topics_options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">        <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./libprotobuf_channel_pkg.so</span></span><br><span class="line">        <span class="attr">disable_modules:</span> []</span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NormalPublisherModule</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NormalSubscriberModule</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Module custom configuration</span></span><br><span class="line"><span class="attr">NormalPublisherModule:</span></span><br><span class="line">  <span class="attr">topic_name:</span> <span class="string">test_topic</span></span><br><span class="line">  <span class="attr">channel_frq:</span> <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">NormalSubscriberModule:</span></span><br><span class="line">  <span class="attr">topic_name:</span> <span class="string">test_topic</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>此示例与 <strong>protobuf channel</strong> 示例基本一致，唯一的区别是将 <code>NormalPublisherModule</code>​ 和 <code>NormalSubscriberModule</code>​ 集成到 <code>protobuf_channel_pkg</code>​ 一个 Pkg 中；</li>
</ul>
<h4 id="以pkg模式启动-1"><a href="#以pkg模式启动-1" class="headerlink" title="以pkg模式启动"></a>以pkg模式启动</h4><p>启动命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./aimrt_main --cfg_file_path=./cfg/local_deploy_local_ins_protobuf_channel_single_pkg_cfg.yaml</span><br></pre></td></tr></table></figure>

<p>如果是通过<code>aimrt_cli</code>​工具生成代码框架，则执行<code>start_local_deploy_local_ins_protobuf_channel_single_pkg.sh</code>​脚本</p>
<h2 id="App目录-1"><a href="#App目录-1" class="headerlink" title="App目录"></a>App目录</h2><h3 id="normal-pb-chn-publisher-app"><a href="#normal-pb-chn-publisher-app" class="headerlink" title="normal_pb_chn_publisher_app"></a>normal_pb_chn_publisher_app</h3><h4 id="链接Protobuf生成的消息文件-CMakeLists-txt​"><a href="#链接Protobuf生成的消息文件-CMakeLists-txt​" class="headerlink" title="链接Protobuf生成的消息文件(CMakeLists.txt​)"></a>链接Protobuf生成的消息文件(<code>CMakeLists.txt</code>​)</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 略</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(</span><br><span class="line">  <span class="variable">$&#123;CUR_TARGET_NAME&#125;</span></span><br><span class="line">  PRIVATE gflags::gflags</span><br><span class="line">          aimrt::runtime::core</span><br><span class="line">          aimrt::interface::aimrt_module_protobuf_interface</span><br><span class="line">          Protobuf_channel_my_proto_pb_gencode)</span><br></pre></td></tr></table></figure>

<h4 id="主函数-main-cpp​"><a href="#主函数-main-cpp​" class="headerlink" title="主函数(main.cpp​)"></a>主函数(<code>main.cpp</code>​)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;csignal&gt;</span>   <span class="comment">// 信号处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  <span class="comment">// 标准输入输出</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 包含AIMRT框架相关头文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/core.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_protobuf_interface/channel/protobuf_channel.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_protobuf_interface/util/protobuf_tools.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;core/aimrt_core.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;my_proto.pb.h&quot;</span>  <span class="comment">// Protobuf生成的消息定义</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> aimrt::runtime::core;  <span class="comment">// 使用AIMRT核心命名空间</span></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> run_flag = <span class="literal">true</span>;  <span class="comment">// 全局运行标志</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号处理函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SignalHandler</span><span class="params">(<span class="type">int</span> sig)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (sig == SIGINT || sig == SIGTERM) &#123;  <span class="comment">// 处理中断和终止信号</span></span><br><span class="line">    run_flag = <span class="literal">false</span>;                     <span class="comment">// 设置运行标志为false以优雅退出</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">raise</span>(sig);  <span class="comment">// 其他信号原样抛出</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主函数</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">main</span><span class="params">(<span class="type">int32_t</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注册信号处理函数</span></span><br><span class="line">  <span class="built_in">signal</span>(SIGINT, SignalHandler);</span><br><span class="line">  <span class="built_in">signal</span>(SIGTERM, SignalHandler);</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;AimRT 启动.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    AimRTCore core;  <span class="comment">// 创建AIMRT核心对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化配置</span></span><br><span class="line">    AimRTCore::Options options;</span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>)</span><br><span class="line">      options.cfg_file_path = argv[<span class="number">1</span>];  <span class="comment">// 从命令行参数获取配置文件路径</span></span><br><span class="line"></span><br><span class="line">    core.<span class="built_in">Initialize</span>(options);  <span class="comment">// 初始化核心</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建模块</span></span><br><span class="line">    <span class="function">aimrt::CoreRef <span class="title">module_handle</span><span class="params">(core.GetModuleManager().CreateModule(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;NormalPublisherModule&quot;</span>))</span></span>;  <span class="comment">// 创建发布者模块</span></span><br><span class="line"></span><br><span class="line">    std::string topic_name = <span class="string">&quot;test_topic&quot;</span>;  <span class="comment">// 默认主题名</span></span><br><span class="line">    <span class="type">double</span> channel_frq = <span class="number">0.5</span>;               <span class="comment">// 默认发布频率(Hz)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取配置文件</span></span><br><span class="line">    <span class="keyword">auto</span> file_path = module_handle.<span class="built_in">GetConfigurator</span>().<span class="built_in">GetConfigFilePath</span>();</span><br><span class="line">    <span class="keyword">if</span> (!file_path.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">      YAML::Node cfg_node =</span><br><span class="line">          YAML::<span class="built_in">LoadFile</span>(std::<span class="built_in">string</span>(file_path));             <span class="comment">// 加载YAML配置</span></span><br><span class="line">      topic_name = cfg_node[<span class="string">&quot;topic_name&quot;</span>].<span class="built_in">as</span>&lt;std::string&gt;();  <span class="comment">// 获取主题名配置</span></span><br><span class="line">      channel_frq = cfg_node[<span class="string">&quot;channel_frq&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">double</span>&gt;();  <span class="comment">// 获取发布频率配置</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册发布类型</span></span><br><span class="line">    <span class="keyword">auto</span> publisher = module_handle.<span class="built_in">GetChannelHandle</span>().<span class="built_in">GetPublisher</span>(</span><br><span class="line">        topic_name);  <span class="comment">// 获取发布者</span></span><br><span class="line">    <span class="comment">// 检查发布者是否有效(失败会抛出异常)</span></span><br><span class="line">    <span class="built_in">AIMRT_HL_CHECK_ERROR_THROW</span>(module_handle.<span class="built_in">GetLogger</span>(), publisher,</span><br><span class="line">                               <span class="string">&quot;获取主题&#x27;&#123;&#125;&#x27;的发布者失败&quot;</span>, topic_name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建发布者代理(用于发布Protobuf消息)</span></span><br><span class="line">    aimrt::<span class="function">channel::PublisherProxy&lt;Protobuf_channel::my_proto::ExampleEventMsg&gt;</span></span><br><span class="line"><span class="function">        <span class="title">publisher_proxy</span><span class="params">(publisher)</span></span>;</span><br><span class="line">    <span class="type">bool</span> ret = publisher_proxy.<span class="built_in">RegisterPublishType</span>();  <span class="comment">// 注册发布类型</span></span><br><span class="line">    <span class="built_in">AIMRT_HL_CHECK_ERROR_THROW</span>(module_handle.<span class="built_in">GetLogger</span>(), ret,</span><br><span class="line">                               <span class="string">&quot;注册发布类型失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动核心(异步)</span></span><br><span class="line">    <span class="keyword">auto</span> fu = core.<span class="built_in">AsyncStart</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发布消息循环</span></span><br><span class="line">    <span class="type">uint32_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (run_flag) &#123;</span><br><span class="line">      <span class="comment">// 按配置频率休眠</span></span><br><span class="line">      std::this_thread::<span class="built_in">sleep_for</span>(</span><br><span class="line">          std::chrono::<span class="built_in">milliseconds</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(<span class="number">1000</span> / channel_frq)));</span><br><span class="line"></span><br><span class="line">      count++;</span><br><span class="line">      <span class="built_in">AIMRT_HL_INFO</span>(module_handle.<span class="built_in">GetLogger</span>(),</span><br><span class="line">                    <span class="string">&quot;循环计数 : &#123;&#125; -------------------------&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 构造并发布Protobuf消息</span></span><br><span class="line">      Protobuf_channel::my_proto::ExampleEventMsg msg;</span><br><span class="line">      msg.<span class="built_in">set_msg</span>(<span class="string">&quot;计数: &quot;</span> + std::<span class="built_in">to_string</span>(count));  <span class="comment">// 设置消息内容</span></span><br><span class="line">      msg.<span class="built_in">set_num</span>(count);                             <span class="comment">// 设置消息编号</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 记录日志并发布</span></span><br><span class="line">      <span class="built_in">AIMRT_HL_INFO</span>(module_handle.<span class="built_in">GetLogger</span>(), <span class="string">&quot;发布新的Protobuf事件, 数据: &#123;&#125;&quot;</span>,</span><br><span class="line">                    aimrt::<span class="built_in">Pb2CompactJson</span>(msg));  <span class="comment">// 将Protobuf转为JSON格式日志</span></span><br><span class="line">      publisher_proxy.<span class="built_in">Publish</span>(msg);               <span class="comment">// 发布消息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优雅关闭</span></span><br><span class="line">    core.<span class="built_in">Shutdown</span>();  <span class="comment">// 关闭核心</span></span><br><span class="line">    fu.<span class="built_in">wait</span>();        <span class="comment">// 等待异步操作完成</span></span><br><span class="line"></span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;AimRT 运行异常并退出: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;  <span class="comment">// 异常退出</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;AimRT 退出.&quot;</span> &lt;&lt; std::endl;  <span class="comment">// 正常退出日志</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>基于 App 模式创建模块的方式使用 Channel publish 功能</p>
</li>
<li><p>创建 NormalPublisherModule 模块，获取 CoreRef 句柄，以配置的频率、向配置的 topic 中发布 ExampleEventMsg 类型的消息</p>
</li>
</ul>
<h3 id="normal-pb-chn-subscriber-app"><a href="#normal-pb-chn-subscriber-app" class="headerlink" title="normal_pb_chn_subscriber_app"></a>normal_pb_chn_subscriber_app</h3><h4 id="链接Protobuf生成的消息文件-CMakeLists-txt​-1"><a href="#链接Protobuf生成的消息文件-CMakeLists-txt​-1" class="headerlink" title="链接Protobuf生成的消息文件(CMakeLists.txt​)"></a>链接Protobuf生成的消息文件(<code>CMakeLists.txt</code>​)</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(</span><br><span class="line">  <span class="variable">$&#123;CUR_TARGET_NAME&#125;</span></span><br><span class="line">  PRIVATE gflags::gflags</span><br><span class="line">          aimrt::runtime::core</span><br><span class="line">          aimrt::interface::aimrt_module_protobuf_interface</span><br><span class="line">          Protobuf_channel_my_proto_pb_gencode)</span><br></pre></td></tr></table></figure>

<h4 id="主函数-main-cpp​-1"><a href="#主函数-main-cpp​-1" class="headerlink" title="主函数(main.cpp​)"></a>主函数(<code>main.cpp</code>​)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;csignal&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_cpp_interface/core.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_protobuf_interface/channel/protobuf_channel.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aimrt_module_protobuf_interface/util/protobuf_tools.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;core/aimrt_core.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;my_proto.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> aimrt::runtime::core;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局核心指针，用于信号处理</span></span><br><span class="line">AimRTCore* global_core_ptr = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 信号处理函数</span></span><br><span class="line"><span class="comment"> * @param sig 接收到的信号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SignalHandler</span><span class="params">(<span class="type">int</span> sig)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 如果是SIGINT(中断)或SIGTERM(终止)信号，且全局核心指针有效，则优雅关闭</span></span><br><span class="line">  <span class="keyword">if</span> (global_core_ptr &amp;&amp; (sig == SIGINT || sig == SIGTERM)) &#123;</span><br><span class="line">    global_core_ptr-&gt;<span class="built_in">Shutdown</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 其他信号继续传递</span></span><br><span class="line">  <span class="built_in">raise</span>(sig);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 主函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">main</span><span class="params">(<span class="type">int32_t</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注册信号处理函数</span></span><br><span class="line">  <span class="built_in">signal</span>(SIGINT, SignalHandler);</span><br><span class="line">  <span class="built_in">signal</span>(SIGTERM, SignalHandler);</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;AimRT 启动中...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 创建核心对象</span></span><br><span class="line">    AimRTCore core;</span><br><span class="line">    global_core_ptr = &amp;core;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化配置</span></span><br><span class="line">    AimRTCore::Options options;</span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      options.cfg_file_path = argv[<span class="number">1</span>];  <span class="comment">// 从命令行参数获取配置文件路径</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    core.<span class="built_in">Initialize</span>(options);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建模块</span></span><br><span class="line">    <span class="function">aimrt::CoreRef <span class="title">module_handle</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        core.GetModuleManager().CreateModule(<span class="string">&quot;NormalSubscriberModule&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    std::string topic_name = <span class="string">&quot;test_topic&quot;</span>;  <span class="comment">// 默认主题名</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从配置文件读取主题名</span></span><br><span class="line">    <span class="keyword">auto</span> file_path = module_handle.<span class="built_in">GetConfigurator</span>().<span class="built_in">GetConfigFilePath</span>();</span><br><span class="line">    <span class="keyword">if</span> (!file_path.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">      YAML::Node cfg_node = YAML::<span class="built_in">LoadFile</span>(std::<span class="built_in">string</span>(file_path));</span><br><span class="line">      topic_name = cfg_node[<span class="string">&quot;topic_name&quot;</span>].<span class="built_in">as</span>&lt;std::string&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取订阅者</span></span><br><span class="line">    <span class="keyword">auto</span> subscriber =</span><br><span class="line">        module_handle.<span class="built_in">GetChannelHandle</span>().<span class="built_in">GetSubscriber</span>(topic_name);</span><br><span class="line">    <span class="built_in">AIMRT_HL_CHECK_ERROR_THROW</span>(module_handle.<span class="built_in">GetLogger</span>(), subscriber,</span><br><span class="line">                               <span class="string">&quot;获取主题 &#x27;&#123;&#125;&#x27; 的订阅者失败&quot;</span>, topic_name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订阅事件</span></span><br><span class="line">    <span class="type">bool</span> ret =</span><br><span class="line">        aimrt::channel::<span class="built_in">Subscribe</span>&lt;Protobuf_channel::my_proto::ExampleEventMsg&gt;(</span><br><span class="line">            subscriber,</span><br><span class="line">            [module_handle](</span><br><span class="line">                <span class="type">const</span> std::shared_ptr&lt;</span><br><span class="line">                    <span class="type">const</span> Protobuf_channel::my_proto::ExampleEventMsg&gt;&amp; data) &#123;</span><br><span class="line">              <span class="comment">// 收到消息时的回调函数</span></span><br><span class="line">              <span class="built_in">AIMRT_HL_INFO</span>(module_handle.<span class="built_in">GetLogger</span>(),</span><br><span class="line">                            <span class="string">&quot;收到新的PB协议事件消息, 内容: &#123;&#125;&quot;</span>,</span><br><span class="line">                            aimrt::<span class="built_in">Pb2CompactJson</span>(*data));</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="built_in">AIMRT_HL_CHECK_ERROR_THROW</span>(module_handle.<span class="built_in">GetLogger</span>(), ret, <span class="string">&quot;订阅失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动核心</span></span><br><span class="line">    core.<span class="built_in">Start</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭核心</span></span><br><span class="line">    core.<span class="built_in">Shutdown</span>();</span><br><span class="line"></span><br><span class="line">    global_core_ptr = <span class="literal">nullptr</span>;  <span class="comment">// 清除全局指针</span></span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;AimRT 运行时发生异常并退出: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;AimRT 正常退出&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>基于 App 模式创建模块的方式使用 Channel subscribe 功能</li>
<li>创建 NormalSubscriberModule 模块，获取 CoreRef 句柄，会订阅配置的 topic 下的 ExampleEventMsg 类型的消息</li>
</ul>
<h2 id="启动APP模式通信示例"><a href="#启动APP模式通信示例" class="headerlink" title="启动APP模式通信示例"></a>启动APP模式通信示例</h2><h3 id="protobuf-channel-publisher-app"><a href="#protobuf-channel-publisher-app" class="headerlink" title="protobuf channel publisher app"></a>protobuf channel publisher app</h3><p>一个基于 protobuf 协议与 local 后端的 channel 示例，演示内容包括：</p>
<ul>
<li>如何使用 protobuf 协议作为 channel 传输协议；</li>
<li>如何基于 App 模式创建模块的方式使用 Channel publish 功能；</li>
<li>如何基于 Module 方式使用 Channel subscribe 功能；</li>
<li>如何使用 local 类型的 channel 后端；</li>
<li>如何以 App 模式启动；</li>
</ul>
<h4 id="配置文件-cfg-local-deploy-local-ins-protobuf-channel-publisher-app-cfg-yaml​"><a href="#配置文件-cfg-local-deploy-local-ins-protobuf-channel-publisher-app-cfg-yaml​" class="headerlink" title="配置文件(cfg/local_deploy_local_ins_protobuf_channel_publisher_app_cfg.yaml​)"></a>配置文件(<code>cfg/local_deploy_local_ins_protobuf_channel_publisher_app_cfg.yaml</code>​)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aimrt:</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span> <span class="comment"># Trace/Debug/Info/Warn/Error/Fatal/Off</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_thread_pool</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">channel:</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">subscriber_use_inline_executor:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">subscriber_executor:</span> <span class="string">work_thread_pool</span></span><br><span class="line">    <span class="attr">pub_topics_options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">        <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br><span class="line">    <span class="attr">sub_topics_options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">        <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./libprotobuf_channel_sub_pkg.so</span> <span class="comment"># 订阅方使用的是之前以module模式编写的包</span></span><br><span class="line">        <span class="attr">enable_modules:</span> []</span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NormalPublisherModule</span> <span class="comment"># 启动发布模块 (App模式编写)</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NormalSubscriberModule</span> <span class="comment"># 启动订阅模块 (pkg模式编写)</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Module custom configuration</span></span><br><span class="line"><span class="attr">NormalPublisherModule:</span></span><br><span class="line">  <span class="attr">topic_name:</span> <span class="string">test_topic</span></span><br><span class="line">  <span class="attr">channel_frq:</span> <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">NormalSubscriberModule:</span></span><br><span class="line">  <span class="attr">topic_name:</span> <span class="string">test_topic</span></span><br></pre></td></tr></table></figure>

<h4 id="以app模式启动"><a href="#以app模式启动" class="headerlink" title="以app模式启动"></a>以app模式启动</h4><p>启动命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./normal_pb_chn_publisher_app ./cfg/local_deploy_local_ins_protobuf_channel_publisher_app_cfg.yaml</span><br></pre></td></tr></table></figure>

<p>**注意：**​<code>aim_cli</code>​工具不支持生成App模式代码框架，因此不会有相应的启动脚本，需要自行编写。</p>
<ul>
<li>可以在生成代码框架时，先使用pkg模式进行设置，之后对生成的配置文件、启动脚本进行修改即可</li>
</ul>
<p>编写一个app模式的启动脚本<code>start_local_deploy_local_ins_protobuf_channel_publisher_app.sh</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">./normal_pb_chn_publisher_app ./cfg/local_deploy_local_ins_protobuf_channel_publisher_app_cfg.yaml</span><br></pre></td></tr></table></figure>

<h3 id="protobuf-channel-subscriber-app"><a href="#protobuf-channel-subscriber-app" class="headerlink" title="protobuf channel subscriber app"></a>protobuf channel subscriber app</h3><p>一个基于 protobuf 协议与 local 后端的 channel 示例，演示内容包括：</p>
<ul>
<li>如何使用 protobuf 协议作为 channel 传输协议；</li>
<li>如何基于 App 模式创建模块的方式使用 Channel subscribe 功能；</li>
<li>如何基于 Module 方式使用 Channel publish 功能；</li>
<li>如何使用 local 类型的 channel 后端；</li>
<li>如何以 App 模式启动；</li>
</ul>
<h4 id="配置文件-cfg-local-deploy-local-ins-protobuf-channel-subscriber-app-cfg-yaml​"><a href="#配置文件-cfg-local-deploy-local-ins-protobuf-channel-subscriber-app-cfg-yaml​" class="headerlink" title="配置文件(cfg/local_deploy_local_ins_protobuf_channel_subscriber_app_cfg.yaml​)"></a>配置文件(<code>cfg/local_deploy_local_ins_protobuf_channel_subscriber_app_cfg.yaml</code>​)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aimrt:</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">core_lvl:</span> <span class="string">INFO</span> <span class="comment"># Trace/Debug/Info/Warn/Error/Fatal/Off</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">console</span></span><br><span class="line">  <span class="attr">executor:</span></span><br><span class="line">    <span class="attr">executors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_thread_pool</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">thread_num:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">channel:</span></span><br><span class="line">    <span class="attr">backends:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">subscriber_use_inline_executor:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">subscriber_executor:</span> <span class="string">work_thread_pool</span></span><br><span class="line">    <span class="attr">pub_topics_options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">        <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br><span class="line">    <span class="attr">sub_topics_options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">        <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="attr">pkgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./libprotobuf_channel_pub_pkg.so</span></span><br><span class="line">        <span class="attr">enable_modules:</span> [<span class="string">NormalPublisherModule</span>]</span><br><span class="line">    <span class="attr">modules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NormalPublisherModule</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NormalSubscriberModule</span></span><br><span class="line">        <span class="attr">log_lvl:</span> <span class="string">INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Module custom configuration</span></span><br><span class="line"><span class="attr">NormalPublisherModule:</span></span><br><span class="line">  <span class="attr">topic_name:</span> <span class="string">test_topic</span></span><br><span class="line">  <span class="attr">channel_frq:</span> <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">NormalSubscriberModule:</span></span><br><span class="line">  <span class="attr">topic_name:</span> <span class="string">test_topic</span></span><br></pre></td></tr></table></figure>

<h4 id="以app模式启动-1"><a href="#以app模式启动-1" class="headerlink" title="以app模式启动"></a>以app模式启动</h4><p>启动命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./normal_pb_chn_subscriber_app ./cfg/local_deploy_local_ins_protobuf_channel_subscriber_app_cfg.yaml</span><br></pre></td></tr></table></figure>

<p>**注意：**​<code>aim_cli</code>​工具不支持生成App模式代码框架，因此不会有相应的启动脚本，需要自行编写。</p>
<ul>
<li>可以在生成代码框架时，先使用pkg模式进行设置，之后对生成的配置文件、启动脚本进行修改即可</li>
</ul>
<p>编写一个app模式的启动脚本<code>start_local_deploy_local_ins_protobuf_channel_publisher_app.sh</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">./normal_pb_chn_subscriber_app ./cfg/local_deploy_local_ins_protobuf_channel_subscriber_app_cfg.yaml</span><br></pre></td></tr></table></figure>

<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="发布消息的流程"><a href="#发布消息的流程" class="headerlink" title="发布消息的流程"></a>发布消息的流程</h3><h4 id="✅-1-读取配置参数（如-topic-名称、发布频率）"><a href="#✅-1-读取配置参数（如-topic-名称、发布频率）" class="headerlink" title="✅ 1. 读取配置参数（如 topic 名称、发布频率）"></a>✅ 1. 读取配置参数（如 topic 名称、发布频率）</h4><ul>
<li><p><strong>作用</strong>：动态配置 topic 名、发布频率等运行参数。</p>
</li>
<li><p><strong>接口示例</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> file_path = core_.<span class="built_in">GetConfigurator</span>().<span class="built_in">GetConfigFilePath</span>();</span><br><span class="line">YAML::Node cfg_node = YAML::<span class="built_in">LoadFile</span>(std::<span class="built_in">string</span>(file_path));</span><br><span class="line">topic_name_ = cfg_node[<span class="string">&quot;topic_name&quot;</span>].<span class="built_in">as</span>&lt;std::string&gt;();</span><br><span class="line">channel_frq_ = cfg_node[<span class="string">&quot;channel_frq&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">double</span>&gt;();</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="✅-2-获取执行器-ExecutorRef（用于任务调度）"><a href="#✅-2-获取执行器-ExecutorRef（用于任务调度）" class="headerlink" title="✅ 2. 获取执行器 ExecutorRef（用于任务调度）"></a>✅ 2. 获取执行器 ExecutorRef（用于任务调度）</h4><ul>
<li><p><strong>作用</strong>：用于安排主发布任务的异步执行。</p>
</li>
<li><p><strong>接口</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">executor_ = core_.<span class="built_in">GetExecutorManager</span>().<span class="built_in">GetExecutor</span>(<span class="string">&quot;work_thread_pool&quot;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p><strong>验证是否支持定时调度</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(executor_ &amp;&amp; executor_.<span class="built_in">SupportTimerSchedule</span>(), ...);</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="✅-3-获取发布者-PublisherRef（指定-topic）"><a href="#✅-3-获取发布者-PublisherRef（指定-topic）" class="headerlink" title="✅ 3. 获取发布者 PublisherRef（指定 topic）"></a>✅ 3. 获取发布者 PublisherRef（指定 topic）</h4><ul>
<li><p><strong>作用</strong>：绑定发布主题，用于后续发送消息。</p>
</li>
<li><p><strong>接口</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publisher_ = core_.<span class="built_in">GetChannelHandle</span>().<span class="built_in">GetPublisher</span>(topic_name_);</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="✅-4-注册发布消息类型（绑定-Protobuf-类型）"><a href="#✅-4-注册发布消息类型（绑定-Protobuf-类型）" class="headerlink" title="✅ 4. 注册发布消息类型（绑定 Protobuf 类型）"></a>✅ 4. 注册发布消息类型（绑定 Protobuf 类型）</h4><ul>
<li><p><strong>作用</strong>：向系统注册将要发送的 Protobuf 消息类型。</p>
</li>
<li><p><strong>接口</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> ret = aimrt::channel::<span class="built_in">RegisterPublishType</span>&lt;Protobuf_channel::my_proto::ExampleEventMsg&gt;(publisher_);</span><br><span class="line"><span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(ret, <span class="string">&quot;注册发布类型失败&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="✅-5-创建-PublisherProxy（可选，简化发布）"><a href="#✅-5-创建-PublisherProxy（可选，简化发布）" class="headerlink" title="✅ 5. 创建 PublisherProxy（可选，简化发布）"></a>✅ 5. 创建 PublisherProxy（可选，简化发布）</h4><ul>
<li><p><strong>作用</strong>：封装 PublisherRef，便于发布消息，自动处理上下文。</p>
</li>
<li><p><strong>接口</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aimrt::<span class="function">channel::PublisherProxy&lt;Protobuf_channel::my_proto::ExampleEventMsg&gt; <span class="title">publisher_proxy</span><span class="params">(publisher_)</span></span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="✅-6-构造并填充消息对象"><a href="#✅-6-构造并填充消息对象" class="headerlink" title="✅ 6. 构造并填充消息对象"></a>✅ 6. 构造并填充消息对象</h4><ul>
<li><p><strong>作用</strong>：设置消息字段（如文本、数值）。</p>
</li>
<li><p><strong>接口</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Protobuf_channel::my_proto::ExampleEventMsg msg;</span><br><span class="line">msg.<span class="built_in">set_msg</span>(<span class="string">&quot;当前计数: &quot;</span> + std::<span class="built_in">to_string</span>(count));</span><br><span class="line">msg.<span class="built_in">set_num</span>(count);</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="✅-7-发布消息"><a href="#✅-7-发布消息" class="headerlink" title="✅ 7. 发布消息"></a>✅ 7. 发布消息</h4><ul>
<li><p><strong>作用</strong>：将消息写入通道，供订阅者消费。</p>
</li>
<li><p><strong>接口</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publisher_proxy.<span class="built_in">Publish</span>(msg);</span><br></pre></td></tr></table></figure></li>
</ul>
<p>‍</p>
<h4 id="🗂️-总结表（含具体接口）"><a href="#🗂️-总结表（含具体接口）" class="headerlink" title="🗂️ 总结表（含具体接口）"></a>🗂️ 总结表（含具体接口）</h4><table>
<thead>
<tr>
<th>步骤</th>
<th>描述</th>
<th>接口&#x2F;代码片段</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>获取配置参数</td>
<td>​<code>cfg_node[&quot;topic_name&quot;].as[std::string](std::string)()</code>​<br /><code>cfg_node[&quot;channel_frq&quot;].as&lt;double&gt;()</code>​</td>
</tr>
<tr>
<td>2</td>
<td>获取执行器</td>
<td>​<code>core_.GetExecutorManager().GetExecutor(&quot;work_thread_pool&quot;)</code>​</td>
</tr>
<tr>
<td>3</td>
<td>获取 Publisher</td>
<td>​<code>core_.GetChannelHandle().GetPublisher(topic_name_)</code>​</td>
</tr>
<tr>
<td>4</td>
<td>注册消息类型</td>
<td>​<code>RegisterPublishType&lt;ExampleEventMsg&gt;(publisher_)</code>​</td>
</tr>
<tr>
<td>5</td>
<td>创建 PublisherProxy</td>
<td>​<code>PublisherProxy&lt;ExampleEventMsg&gt; proxy(publisher_)</code>​</td>
</tr>
<tr>
<td>6</td>
<td>构造消息</td>
<td>​<code>msg.set_msg(...)</code>​,<code>msg.set_num(...)</code>​</td>
</tr>
<tr>
<td>7</td>
<td>发布消息</td>
<td>​<code>proxy.Publish(msg)</code>​</td>
</tr>
</tbody></table>
<h3 id="接收消息的流程"><a href="#接收消息的流程" class="headerlink" title="接收消息的流程"></a>接收消息的流程</h3><h4 id="✅-1-读取配置参数（如-topic-名称）"><a href="#✅-1-读取配置参数（如-topic-名称）" class="headerlink" title="✅ 1. 读取配置参数（如 topic 名称）"></a>✅ 1. 读取配置参数（如 topic 名称）</h4><ul>
<li><p><strong>作用</strong>：动态配置接收的 topic 名，便于部署时灵活调整。</p>
</li>
<li><p><strong>接口示例</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> file_path = core_.<span class="built_in">GetConfigurator</span>().<span class="built_in">GetConfigFilePath</span>();</span><br><span class="line">YAML::Node cfg_node = YAML::<span class="built_in">LoadFile</span>(std::<span class="built_in">string</span>(file_path));</span><br><span class="line">topic_name_ = cfg_node[<span class="string">&quot;topic_name&quot;</span>].<span class="built_in">as</span>&lt;std::string&gt;();</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="✅-2-获取订阅者-SubscriberRef（绑定到-topic）"><a href="#✅-2-获取订阅者-SubscriberRef（绑定到-topic）" class="headerlink" title="✅ 2. 获取订阅者 SubscriberRef（绑定到 topic）"></a>✅ 2. 获取订阅者 SubscriberRef（绑定到 topic）</h4><ul>
<li><p><strong>作用</strong>：从通道系统获取订阅者句柄，准备订阅对应的消息通道。</p>
</li>
<li><p><strong>接口</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subscriber_ = core_.<span class="built_in">GetChannelHandle</span>().<span class="built_in">GetSubscriber</span>(topic_name_);</span><br><span class="line"><span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(subscriber_, <span class="string">&quot;获取主题&#x27;&#123;&#125;&#x27;的订阅者失败&quot;</span>, topic_name_);</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="✅-3-注册订阅消息类型-绑定回调函数（完成订阅）"><a href="#✅-3-注册订阅消息类型-绑定回调函数（完成订阅）" class="headerlink" title="✅ 3. 注册订阅消息类型 + 绑定回调函数（完成订阅）"></a>✅ 3. 注册订阅消息类型 + 绑定回调函数（完成订阅）</h4><ul>
<li><p><strong>作用</strong>：声明要接收的消息类型 + 注册回调函数； 回调函数将在消息到达时被自动触发。</p>
</li>
<li><p><strong>接口</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> ret = aimrt::channel::<span class="built_in">Subscribe</span>&lt;Protobuf_channel::my_proto::ExampleEventMsg&gt;(</span><br><span class="line">    subscriber_,</span><br><span class="line">    std::<span class="built_in">bind</span>(&amp;NormalSubscriberModule::EventHandle, <span class="keyword">this</span>,</span><br><span class="line">              std::placeholders::_1, std::placeholders::_2));</span><br><span class="line"><span class="built_in">AIMRT_CHECK_ERROR_THROW</span>(ret, <span class="string">&quot;订阅消息失败&quot;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p><strong>说明</strong>：</p>
<ul>
<li>使用的是【函数风格】接口；</li>
<li>回调形式为【带 Context 参数】+【智能指针消息】；</li>
<li><strong>只能在模块的</strong> <strong>​<code>Initialize()</code>​</strong> ​ <strong>阶段调用订阅函数</strong>；</li>
<li>一个 <code>SubscriberRef</code>​ 不能重复订阅相同类型。</li>
</ul>
</li>
</ul>
<hr>
<h4 id="✅-4-实现回调函数，处理接收到的消息"><a href="#✅-4-实现回调函数，处理接收到的消息" class="headerlink" title="✅ 4. 实现回调函数，处理接收到的消息"></a>✅ 4. 实现回调函数，处理接收到的消息</h4><ul>
<li><p><strong>作用</strong>：处理订阅消息的内容，可访问上下文信息、执行业务逻辑。</p>
</li>
<li><p><strong>接口</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">NormalSubscriberModule::EventHandle</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    aimrt::channel::ContextRef ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> Protobuf_channel::my_proto::ExampleEventMsg&gt;&amp; data)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">AIMRT_INFO</span>(<span class="string">&quot;收到新消息，上下文: &#123;&#125;, 数据内容: &#123;&#125;&quot;</span>, ctx.<span class="built_in">ToString</span>(),</span><br><span class="line">             aimrt::<span class="built_in">Pb2CompactJson</span>(*data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>说明</strong>：</p>
<ul>
<li><code>ctx</code>​ 提供上下文信息（如消息来源、时间戳）；</li>
<li><code>data</code>​ 是 Protobuf 消息的 const 智能指针，可直接使用；</li>
<li>处理逻辑可以轻量，也可以将任务调度到其它执行器中（但执行器不是在订阅处指定的）。</li>
</ul>
</li>
</ul>
<hr>
<h4 id="🗂️-总结表（含具体接口）-1"><a href="#🗂️-总结表（含具体接口）-1" class="headerlink" title="🗂️ 总结表（含具体接口）"></a>🗂️ 总结表（含具体接口）</h4><table>
<thead>
<tr>
<th>步骤</th>
<th>描述</th>
<th>接口&#x2F;代码片段</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>获取配置参数（topic）</td>
<td>​<code>cfg_node[&quot;topic_name&quot;].as[std::string](std::string)()</code>​</td>
</tr>
<tr>
<td>2</td>
<td>获取 SubscriberRef</td>
<td>​<code>core_.GetChannelHandle().GetSubscriber(topic_name_)</code>​</td>
</tr>
<tr>
<td>3</td>
<td>注册消息回调</td>
<td>​<code>Subscribe&lt;ExampleEventMsg&gt;(subscriber_, callback)</code>​</td>
</tr>
<tr>
<td>4</td>
<td>实现回调处理函数</td>
<td>​<code>EventHandle(ContextRef, shared_ptr&lt;const Msg&gt;)</code>​</td>
</tr>
</tbody></table>
<h3 id="关于订阅方的执行器"><a href="#关于订阅方的执行器" class="headerlink" title="关于订阅方的执行器"></a>关于订阅方的执行器</h3><h4 id="❓1-为什么订阅方在代码中没有显式指定执行器？"><a href="#❓1-为什么订阅方在代码中没有显式指定执行器？" class="headerlink" title="❓1. 为什么订阅方在代码中没有显式指定执行器？"></a>❓1. 为什么订阅方在代码中没有显式指定执行器？</h4><p>在 AimRT 中，订阅方执行器的配置 <strong>不在订阅模块代码中指定</strong>，而是 <strong>通过配置文件的 Channel 后端参数进行集中管理</strong>，原因如下：</p>
<ul>
<li><strong>解耦设计理念</strong>：AimRT 框架采用高度模块化设计，模块本身只声明对 Topic 的订阅关系，具体使用哪个执行器（或是否同步处理）由 <code>channel.backends.options</code>​ 统一决定；</li>
<li><strong>配置驱动、逻辑清晰</strong>：通过配置控制订阅执行行为可以更灵活地调整运行时特性，例如从同步切换为异步、调整执行线程数，而无需更改模块实现；</li>
<li><strong>利于跨模块优化调度</strong>：在同一 Channel 后端中集中处理执行策略，有助于线程资源的统一调度和优化，避免各模块各自为政、造成资源浪费或线程争抢。</li>
</ul>
<p>因此：<strong>订阅方是否使用执行器，由</strong> <strong>​<code>channel.backends[].options</code>​</strong>​ <strong>中的</strong> <strong>​<code>subscriber_executor</code>​</strong>​ <strong>决定，而非模块代码内部。</strong></p>
<h4 id="🛠️-2-相关配置解释"><a href="#🛠️-2-相关配置解释" class="headerlink" title="🛠️ 2. 相关配置解释"></a>🛠️ 2. 相关配置解释</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">executor:</span></span><br><span class="line">  <span class="attr">executors:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">work_thread_pool</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">asio_thread</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">thread_num:</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>🔸 定义了一个线程池执行器 <code>work_thread_pool</code>​，基于 <code>asio_thread</code>​ 类型，拥有 4 个线程。</p>
<p>🔸 这个线程池将会执行消息发布循环、消息接收回调的代码</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">channel:</span></span><br><span class="line">  <span class="attr">backends:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">local</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">subscriber_use_inline_executor:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">subscriber_executor:</span> <span class="string">work_thread_pool</span></span><br></pre></td></tr></table></figure>

<p>🔸 配置了一个 <code>local</code>​ 类型的 Channel 后端：</p>
<ul>
<li><code>subscriber_use_inline_executor: false</code>​：表示不使用同步执行模式；</li>
<li><code>subscriber_executor: work_thread_pool</code>​：所有订阅回调将异步投递到 <code>work_thread_pool</code>​ 执行器中；</li>
<li>因此，<strong>订阅模块的回调逻辑不会阻塞发布方的</strong> <strong>​<code>Publish()</code>​</strong> ​ <strong>调用。</strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pub_topics_options:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">    <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br><span class="line"><span class="attr">sub_topics_options:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">topic_name:</span> <span class="string">&quot;(.*)&quot;</span></span><br><span class="line">    <span class="attr">enable_backends:</span> [<span class="string">local</span>]</span><br></pre></td></tr></table></figure>

<p>🔸 通配符 <code>(.*)</code>​ 匹配所有 Topic，使其均由 <code>local</code>​ 后端处理。</p>
<p>🔸 因此可以实现不同话题使用不同后端处理</p>
<h4 id="🔌-3-AimRT-插件机制"><a href="#🔌-3-AimRT-插件机制" class="headerlink" title="🔌 3. AimRT 插件机制"></a>🔌 3. AimRT 插件机制</h4><p>AimRT 的 <code>Channel</code>​ 通信机制是高度可扩展的 —— <strong>其后端实现支持插件化架构</strong>。除了内置的 <code>local</code>​ 后端之外，官方或第三方还可以实现如下多种通信形式的插件：</p>
<ul>
<li><strong>网络通信（如 TCP、UDP、Http）</strong></li>
<li><strong>中间件集成（如 ROS2 DDS）</strong></li>
</ul>
<p>这些插件均可作为 <code>channel.backends</code>​ 的新类型，通过配置加载并与发布&#x2F;订阅模块联动，实现模块间的远程、跨进程或跨平台消息传递。</p>
<p><strong>相关内容后续学习插件章节时再进行详细记录</strong></p>
<h1 id="pb-rpc示例"><a href="#pb-rpc示例" class="headerlink" title="pb_rpc示例"></a>pb_rpc示例</h1><p>‍</p>
</article><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2025/01/04/%E9%9A%8F%E8%AE%B0/sphinx%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">sphinx 使用指南</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/10/17/CPP/CMake/%E7%8E%B0%E4%BB%A3CMake/" title="现代CMake"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-10-17</div><div class="title">现代CMake</div></div></a></div><div><a href="/2024/11/03/CPP/CMake/%E7%8E%B0%E4%BB%A3%E5%8C%96CMake%E6%A8%A1%E5%9D%97%E5%8C%96%E9%A1%B9%E7%9B%AE%E6%8C%87%E5%8D%97/" title="现代CMake模块化项目指南"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-11-03</div><div class="title">现代CMake模块化项目指南</div></div></a></div><div><a href="/2024/11/20/CPP/CPP20%E5%8D%8F%E7%A8%8B/CPP20%E5%8D%8F%E7%A8%8B%E5%85%A5%E9%97%A8/" title="C++协程入门"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-11-20</div><div class="title">C++协程入门</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E9%85%8D%E7%BD%AE/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description">一个记录、分享自己学习过程的博客</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Ming</h1><div class="author-info__desc">MINGの部落格</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/MING-Z0/" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/484647453" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E9%93%BE%E4%B8%8E%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">工具链与基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#aimrt-cli%E2%80%8B-%E5%B7%A5%E5%85%B7"><span class="toc-number">1.1.</span> <span class="toc-text">aimrt_cli​ 工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">用法示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-number">1.1.2.</span> <span class="toc-text">配置文档示例：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMake-%E4%BE%9D%E8%B5%96%E4%BF%AE%E6%AD%A3%EF%BC%88cmake-GetAimRT-cmake%E2%80%8B%EF%BC%89"><span class="toc-number">1.1.3.</span> <span class="toc-text">CMake 依赖修正（cmake&#x2F;GetAimRT.cmake​）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aimrt-main%E4%B8%BB%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">aimrt_main主进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">项目工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F-App%E4%B8%8EPkg"><span class="toc-number">1.4.</span> <span class="toc-text">集成业务逻辑的两种方式(App与Pkg)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-number">1.5.</span> <span class="toc-text">执行器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HelloWorld%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.</span> <span class="toc-text">HelloWorld示例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%88configuration-helloworld-yaml%E2%80%8B-%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">配置文件（configuration_helloworld.yaml​ ）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#module%E7%9B%AE%E5%BD%95"><span class="toc-number">2.2.</span> <span class="toc-text">module目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HelloWorld-module"><span class="toc-number">2.2.1.</span> <span class="toc-text">HelloWorld_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89%EF%BC%88helloworld-module-h%E2%80%8B%EF%BC%89"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">模块定义（helloworld_module.h​）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%EF%BC%88helloworld-module-cc%E2%80%8B%EF%BC%89"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">模块实现（helloworld_module.cc​）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5"><span class="toc-number">2.2.1.2.1.</span> <span class="toc-text">初始化阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%98%B6%E6%AE%B5"><span class="toc-number">2.2.1.2.2.</span> <span class="toc-text">运行阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E9%98%B6%E6%AE%B5"><span class="toc-number">2.2.1.2.3.</span> <span class="toc-text">停止阶段</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pkg%E7%9B%AE%E5%BD%95"><span class="toc-number">2.3.</span> <span class="toc-text">Pkg目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pkg%E6%A8%A1%E5%BC%8F%E9%9B%86%E6%88%90%EF%BC%88pkg-main-cc%EF%BC%89"><span class="toc-number">2.3.1.</span> <span class="toc-text">Pkg模式集成（pkg_main.cc）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%AE%9A%E4%B9%89"><span class="toc-number">2.3.2.</span> <span class="toc-text">注册表定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%AE%8F"><span class="toc-number">2.3.3.</span> <span class="toc-text">注册宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E8%BF%90%E8%A1%8C"><span class="toc-number">2.3.4.</span> <span class="toc-text">加载运行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#App%E7%9B%AE%E5%BD%95"><span class="toc-number">2.4.</span> <span class="toc-text">App目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.4.1.</span> <span class="toc-text">核心接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%A8%A1%E5%9D%97%EF%BC%88helloworld-app-registration-mode%E2%80%8B%EF%BC%89%EF%BC%88%E6%8E%A8%E8%8D%90%E6%96%B9%E6%A1%88%EF%BC%89"><span class="toc-number">2.4.2.</span> <span class="toc-text">注册模块（helloworld_app_registration_mode​）（推荐方案）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9D%97%EF%BC%88-%E2%80%8Bhelloworld-app%E2%80%8B%EF%BC%89"><span class="toc-number">2.4.3.</span> <span class="toc-text">**创建模块（**​helloworld_app​）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Executor%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.</span> <span class="toc-text">Executor示例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%88configuration-executor-yaml%E2%80%8B%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">配置文件（configuration_executor.yaml​）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#module%E7%9B%AE%E5%BD%95-1"><span class="toc-number">3.2.</span> <span class="toc-text">module目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#executor-module"><span class="toc-number">3.2.1.</span> <span class="toc-text">executor_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89%EF%BC%88executor-module-h%E2%80%8B%EF%BC%89"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">模块定义（executor_module.h​）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%EF%BC%88executor-module-cc%E2%80%8B%EF%BC%89"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">模块实现（executor_module.cc​）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5-1"><span class="toc-number">3.2.1.2.1.</span> <span class="toc-text">初始化阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%98%B6%E6%AE%B5-1"><span class="toc-number">3.2.1.2.2.</span> <span class="toc-text">运行阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E9%98%B6%E6%AE%B5-1"><span class="toc-number">3.2.1.2.3.</span> <span class="toc-text">停止阶段</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.1.3.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#executor-co-module"><span class="toc-number">3.2.2.</span> <span class="toc-text">executor_co_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89%EF%BC%88executor-co-module-h%E2%80%8B%EF%BC%89"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">模块定义（executor_co_module.h​）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%EF%BC%88executor-co-module-cc%E2%80%8B%EF%BC%89"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">模块实现（executor_co_module.cc​）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5-2"><span class="toc-number">3.2.2.2.1.</span> <span class="toc-text">初始化阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%98%B6%E6%AE%B5-2"><span class="toc-number">3.2.2.2.2.</span> <span class="toc-text">运行阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E9%98%B6%E6%AE%B5-2"><span class="toc-number">3.2.2.2.3.</span> <span class="toc-text">停止阶段</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#executor-co-loop-module"><span class="toc-number">3.2.3.</span> <span class="toc-text">executor_co_loop_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89%EF%BC%88executor-co-loop-module-h%E2%80%8B%EF%BC%89"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">模块定义（executor_co_loop_module.h​）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0-executor-co-loop-module-cc%E2%80%8B"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">模块实现(executor_co_loop_module.cc​)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5-3"><span class="toc-number">3.2.3.2.1.</span> <span class="toc-text">初始化阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%98%B6%E6%AE%B5-3"><span class="toc-number">3.2.3.2.2.</span> <span class="toc-text">运行阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E9%98%B6%E6%AE%B5-3"><span class="toc-number">3.2.3.2.3.</span> <span class="toc-text">停止阶段</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="toc-number">3.2.3.3.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#real-time-module"><span class="toc-number">3.2.4.</span> <span class="toc-text">real_time_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89%EF%BC%88real-time-module-h%E2%80%8B%EF%BC%89"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">模块定义（real_time_module.h​）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%EF%BC%88real-time-module-cc%E2%80%8B%EF%BC%89"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">模块实现（real_time_module.cc​）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5-4"><span class="toc-number">3.2.4.2.1.</span> <span class="toc-text">初始化阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%98%B6%E6%AE%B5-4"><span class="toc-number">3.2.4.2.2.</span> <span class="toc-text">运行阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E9%98%B6%E6%AE%B5-4"><span class="toc-number">3.2.4.2.3.</span> <span class="toc-text">停止阶段</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-3"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#logger%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.</span> <span class="toc-text">logger示例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-configuration-logger-yaml%E2%80%8B"><span class="toc-number">4.1.</span> <span class="toc-text">配置文件(configuration_logger.yaml​)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#module%E7%9B%AE%E5%BD%95-2"><span class="toc-number">4.2.</span> <span class="toc-text">module目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#logger"><span class="toc-number">4.2.1.</span> <span class="toc-text">logger</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89%EF%BC%88logger-module-h%E2%80%8B%EF%BC%89"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">模块定义（logger_module.h​）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%EF%BC%88logger-module-cc%E2%80%8B%EF%BC%89"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">模块实现（logger_module.cc​）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-4"><span class="toc-number">4.2.1.3.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logger-rotate-file"><span class="toc-number">4.2.2.</span> <span class="toc-text">logger rotate file</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-5"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logger-specify-executor"><span class="toc-number">4.2.3.</span> <span class="toc-text">logger specify executor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-6"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logger-format"><span class="toc-number">4.2.4.</span> <span class="toc-text">logger format</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-7"><span class="toc-number">4.2.4.1.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logger-rotate-file-with-sync%EF%BC%880-8-x%E7%89%88%E6%9C%AC%E4%B8%8D%E6%94%AF%E6%8C%81%EF%BC%8C%E6%9C%80%E6%96%B0main%E5%88%86%E6%94%AF%E5%BC%80%E5%A7%8B%E6%94%AF%E6%8C%81%EF%BC%89"><span class="toc-number">4.2.5.</span> <span class="toc-text">logger rotate file with sync（0.8.x版本不支持，最新main分支开始支持）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-8"><span class="toc-number">4.2.5.1.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Parameter%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.</span> <span class="toc-text">Parameter示例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-configuration-parameter-yaml%E2%80%8B"><span class="toc-number">5.1.</span> <span class="toc-text">配置文件(configuration_parameter.yaml​)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#module%E7%9B%AE%E5%BD%95-3"><span class="toc-number">5.2.</span> <span class="toc-text">module目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#parameter-module"><span class="toc-number">5.2.1.</span> <span class="toc-text">parameter_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">模块定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">模块实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5-5"><span class="toc-number">5.2.1.2.1.</span> <span class="toc-text">初始化阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%98%B6%E6%AE%B5-5"><span class="toc-number">5.2.1.2.2.</span> <span class="toc-text">运行阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E9%98%B6%E6%AE%B5-5"><span class="toc-number">5.2.1.2.3.</span> <span class="toc-text">停止阶段</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-9"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">对应的启动配置文件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pb-chn%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.</span> <span class="toc-text">pb_chn示例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-configuration-protobuf-channel-yaml"><span class="toc-number">6.1.</span> <span class="toc-text">配置文件(configuration_protobuf_channel.yaml)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#protocols%E7%9B%AE%E5%BD%95"><span class="toc-number">6.2.</span> <span class="toc-text">protocols目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#my-proto-proto%E6%96%87%E4%BB%B6"><span class="toc-number">6.2.1.</span> <span class="toc-text">my_proto.proto文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMakeLists-txt%E6%96%87%E4%BB%B6"><span class="toc-number">6.2.2.</span> <span class="toc-text">CMakeLists.txt文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#module%E7%9B%AE%E5%BD%95-4"><span class="toc-number">6.3.</span> <span class="toc-text">module目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#normal-publisher-module"><span class="toc-number">6.3.1.</span> <span class="toc-text">normal_publisher_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E7%94%9F%E6%88%90%E7%9A%84%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6-CMakeLists-txt%E2%80%8B"><span class="toc-number">6.3.1.1.</span> <span class="toc-text">链接生成的消息文件(CMakeLists.txt​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89-normal-publisher-module-h%E2%80%8B"><span class="toc-number">6.3.1.2.</span> <span class="toc-text">模块定义(normal_publisher_module.h​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0-normal-publisher-module-cc%E2%80%8B"><span class="toc-number">6.3.1.3.</span> <span class="toc-text">模块实现(normal_publisher_module.cc​)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5-6"><span class="toc-number">6.3.1.3.1.</span> <span class="toc-text">初始化阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%98%B6%E6%AE%B5-6"><span class="toc-number">6.3.1.3.2.</span> <span class="toc-text">运行阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E9%98%B6%E6%AE%B5-6"><span class="toc-number">6.3.1.3.3.</span> <span class="toc-text">停止阶段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#normal-subscriber-module"><span class="toc-number">6.3.2.</span> <span class="toc-text">normal_subscriber_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E7%94%9F%E6%88%90%E7%9A%84%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6-CMakeLists-txt%E2%80%8B-1"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">链接生成的消息文件(CMakeLists.txt​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89-normal-subscriber-module-h%E2%80%8B"><span class="toc-number">6.3.2.2.</span> <span class="toc-text">模块定义(normal_subscriber_module.h​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0-normal-subscriber-module-cc%E2%80%8B"><span class="toc-number">6.3.2.3.</span> <span class="toc-text">模块实现(normal_subscriber_module.cc​)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5-7"><span class="toc-number">6.3.2.3.1.</span> <span class="toc-text">初始化阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%98%B6%E6%AE%B5-7"><span class="toc-number">6.3.2.3.2.</span> <span class="toc-text">运行阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E9%98%B6%E6%AE%B5-7"><span class="toc-number">6.3.2.3.3.</span> <span class="toc-text">停止阶段</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Pkg%E6%A8%A1%E5%BC%8F%E9%80%9A%E4%BF%A1%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.4.</span> <span class="toc-text">启动Pkg模式通信示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#protobuf-channel"><span class="toc-number">6.4.1.</span> <span class="toc-text">protobuf channel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-cfg-local-deploy-local-ins-protobuf-channel-cfg-yaml%E2%80%8B"><span class="toc-number">6.4.1.1.</span> <span class="toc-text">对应配置文件(cfg&#x2F;local_deploy_local_ins_protobuf_channel_cfg.yaml​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5pkg%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="toc-number">6.4.1.2.</span> <span class="toc-text">以pkg模式启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#protobuf-channel-single-pkg"><span class="toc-number">6.4.2.</span> <span class="toc-text">protobuf channel single pkg</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-cfg-local-deploy-local-ins-protobuf-channel-single-pkg-cfg-yaml%E2%80%8B"><span class="toc-number">6.4.2.1.</span> <span class="toc-text">对应配置文件(cfg&#x2F;local_deploy_local_ins_protobuf_channel_single_pkg_cfg.yaml​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5pkg%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8-1"><span class="toc-number">6.4.2.2.</span> <span class="toc-text">以pkg模式启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#App%E7%9B%AE%E5%BD%95-1"><span class="toc-number">6.5.</span> <span class="toc-text">App目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#normal-pb-chn-publisher-app"><span class="toc-number">6.5.1.</span> <span class="toc-text">normal_pb_chn_publisher_app</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5Protobuf%E7%94%9F%E6%88%90%E7%9A%84%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6-CMakeLists-txt%E2%80%8B"><span class="toc-number">6.5.1.1.</span> <span class="toc-text">链接Protobuf生成的消息文件(CMakeLists.txt​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0-main-cpp%E2%80%8B"><span class="toc-number">6.5.1.2.</span> <span class="toc-text">主函数(main.cpp​)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#normal-pb-chn-subscriber-app"><span class="toc-number">6.5.2.</span> <span class="toc-text">normal_pb_chn_subscriber_app</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5Protobuf%E7%94%9F%E6%88%90%E7%9A%84%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6-CMakeLists-txt%E2%80%8B-1"><span class="toc-number">6.5.2.1.</span> <span class="toc-text">链接Protobuf生成的消息文件(CMakeLists.txt​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0-main-cpp%E2%80%8B-1"><span class="toc-number">6.5.2.2.</span> <span class="toc-text">主函数(main.cpp​)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8APP%E6%A8%A1%E5%BC%8F%E9%80%9A%E4%BF%A1%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.6.</span> <span class="toc-text">启动APP模式通信示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#protobuf-channel-publisher-app"><span class="toc-number">6.6.1.</span> <span class="toc-text">protobuf channel publisher app</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-cfg-local-deploy-local-ins-protobuf-channel-publisher-app-cfg-yaml%E2%80%8B"><span class="toc-number">6.6.1.1.</span> <span class="toc-text">配置文件(cfg&#x2F;local_deploy_local_ins_protobuf_channel_publisher_app_cfg.yaml​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5app%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="toc-number">6.6.1.2.</span> <span class="toc-text">以app模式启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#protobuf-channel-subscriber-app"><span class="toc-number">6.6.2.</span> <span class="toc-text">protobuf channel subscriber app</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-cfg-local-deploy-local-ins-protobuf-channel-subscriber-app-cfg-yaml%E2%80%8B"><span class="toc-number">6.6.2.1.</span> <span class="toc-text">配置文件(cfg&#x2F;local_deploy_local_ins_protobuf_channel_subscriber_app_cfg.yaml​)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5app%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8-1"><span class="toc-number">6.6.2.2.</span> <span class="toc-text">以app模式启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">6.7.</span> <span class="toc-text">知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E6%B6%88%E6%81%AF%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">6.7.1.</span> <span class="toc-text">发布消息的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-1-%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%EF%BC%88%E5%A6%82-topic-%E5%90%8D%E7%A7%B0%E3%80%81%E5%8F%91%E5%B8%83%E9%A2%91%E7%8E%87%EF%BC%89"><span class="toc-number">6.7.1.1.</span> <span class="toc-text">✅ 1. 读取配置参数（如 topic 名称、发布频率）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-2-%E8%8E%B7%E5%8F%96%E6%89%A7%E8%A1%8C%E5%99%A8-ExecutorRef%EF%BC%88%E7%94%A8%E4%BA%8E%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%EF%BC%89"><span class="toc-number">6.7.1.2.</span> <span class="toc-text">✅ 2. 获取执行器 ExecutorRef（用于任务调度）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-3-%E8%8E%B7%E5%8F%96%E5%8F%91%E5%B8%83%E8%80%85-PublisherRef%EF%BC%88%E6%8C%87%E5%AE%9A-topic%EF%BC%89"><span class="toc-number">6.7.1.3.</span> <span class="toc-text">✅ 3. 获取发布者 PublisherRef（指定 topic）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-4-%E6%B3%A8%E5%86%8C%E5%8F%91%E5%B8%83%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B%EF%BC%88%E7%BB%91%E5%AE%9A-Protobuf-%E7%B1%BB%E5%9E%8B%EF%BC%89"><span class="toc-number">6.7.1.4.</span> <span class="toc-text">✅ 4. 注册发布消息类型（绑定 Protobuf 类型）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-5-%E5%88%9B%E5%BB%BA-PublisherProxy%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%8C%E7%AE%80%E5%8C%96%E5%8F%91%E5%B8%83%EF%BC%89"><span class="toc-number">6.7.1.5.</span> <span class="toc-text">✅ 5. 创建 PublisherProxy（可选，简化发布）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-6-%E6%9E%84%E9%80%A0%E5%B9%B6%E5%A1%AB%E5%85%85%E6%B6%88%E6%81%AF%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.7.1.6.</span> <span class="toc-text">✅ 6. 构造并填充消息对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-7-%E5%8F%91%E5%B8%83%E6%B6%88%E6%81%AF"><span class="toc-number">6.7.1.7.</span> <span class="toc-text">✅ 7. 发布消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%97%82%EF%B8%8F-%E6%80%BB%E7%BB%93%E8%A1%A8%EF%BC%88%E5%90%AB%E5%85%B7%E4%BD%93%E6%8E%A5%E5%8F%A3%EF%BC%89"><span class="toc-number">6.7.1.8.</span> <span class="toc-text">🗂️ 总结表（含具体接口）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">6.7.2.</span> <span class="toc-text">接收消息的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-1-%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%EF%BC%88%E5%A6%82-topic-%E5%90%8D%E7%A7%B0%EF%BC%89"><span class="toc-number">6.7.2.1.</span> <span class="toc-text">✅ 1. 读取配置参数（如 topic 名称）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-2-%E8%8E%B7%E5%8F%96%E8%AE%A2%E9%98%85%E8%80%85-SubscriberRef%EF%BC%88%E7%BB%91%E5%AE%9A%E5%88%B0-topic%EF%BC%89"><span class="toc-number">6.7.2.2.</span> <span class="toc-text">✅ 2. 获取订阅者 SubscriberRef（绑定到 topic）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-3-%E6%B3%A8%E5%86%8C%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B-%E7%BB%91%E5%AE%9A%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%EF%BC%88%E5%AE%8C%E6%88%90%E8%AE%A2%E9%98%85%EF%BC%89"><span class="toc-number">6.7.2.3.</span> <span class="toc-text">✅ 3. 注册订阅消息类型 + 绑定回调函数（完成订阅）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-4-%E5%AE%9E%E7%8E%B0%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%EF%BC%8C%E5%A4%84%E7%90%86%E6%8E%A5%E6%94%B6%E5%88%B0%E7%9A%84%E6%B6%88%E6%81%AF"><span class="toc-number">6.7.2.4.</span> <span class="toc-text">✅ 4. 实现回调函数，处理接收到的消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%97%82%EF%B8%8F-%E6%80%BB%E7%BB%93%E8%A1%A8%EF%BC%88%E5%90%AB%E5%85%B7%E4%BD%93%E6%8E%A5%E5%8F%A3%EF%BC%89-1"><span class="toc-number">6.7.2.5.</span> <span class="toc-text">🗂️ 总结表（含具体接口）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%AE%A2%E9%98%85%E6%96%B9%E7%9A%84%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-number">6.7.3.</span> <span class="toc-text">关于订阅方的执行器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9D%931-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%AE%A2%E9%98%85%E6%96%B9%E5%9C%A8%E4%BB%A3%E7%A0%81%E4%B8%AD%E6%B2%A1%E6%9C%89%E6%98%BE%E5%BC%8F%E6%8C%87%E5%AE%9A%E6%89%A7%E8%A1%8C%E5%99%A8%EF%BC%9F"><span class="toc-number">6.7.3.1.</span> <span class="toc-text">❓1. 为什么订阅方在代码中没有显式指定执行器？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%9B%A0%EF%B8%8F-2-%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E8%A7%A3%E9%87%8A"><span class="toc-number">6.7.3.2.</span> <span class="toc-text">🛠️ 2. 相关配置解释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%8C-3-AimRT-%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6"><span class="toc-number">6.7.3.3.</span> <span class="toc-text">🔌 3. AimRT 插件机制</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pb-rpc%E7%A4%BA%E4%BE%8B"><span class="toc-number">7.</span> <span class="toc-text">pb_rpc示例</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/05/18/AimRT/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/" title="AimRT官方示例解析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AimRT官方示例解析"/></a><div class="content"><a class="title" href="/2025/05/18/AimRT/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/AimRT%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90/" title="AimRT官方示例解析">AimRT官方示例解析</a><time datetime="2025-05-17T16:00:00.000Z" title="发表于 2025-05-18 00:00:00">2025-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/04/%E9%9A%8F%E8%AE%B0/sphinx%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="sphinx 使用指南"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="sphinx 使用指南"/></a><div class="content"><a class="title" href="/2025/01/04/%E9%9A%8F%E8%AE%B0/sphinx%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="sphinx 使用指南">sphinx 使用指南</a><time datetime="2025-01-03T16:00:00.000Z" title="发表于 2025-01-04 00:00:00">2025-01-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/20/CPP/CPP20%E5%8D%8F%E7%A8%8B/CPP20%E5%8D%8F%E7%A8%8B%E5%85%A5%E9%97%A8/" title="C++协程入门"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++协程入门"/></a><div class="content"><a class="title" href="/2024/11/20/CPP/CPP20%E5%8D%8F%E7%A8%8B/CPP20%E5%8D%8F%E7%A8%8B%E5%85%A5%E9%97%A8/" title="C++协程入门">C++协程入门</a><time datetime="2024-11-19T16:00:00.000Z" title="发表于 2024-11-20 00:00:00">2024-11-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/10/CPP/%E8%AE%BF%E5%AD%98%E4%BC%98%E5%8C%96/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E8%AE%BF%E5%AD%98%E4%BC%98%E5%8C%96/" title="深入浅出访存优化"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深入浅出访存优化"/></a><div class="content"><a class="title" href="/2024/11/10/CPP/%E8%AE%BF%E5%AD%98%E4%BC%98%E5%8C%96/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E8%AE%BF%E5%AD%98%E4%BC%98%E5%8C%96/" title="深入浅出访存优化">深入浅出访存优化</a><time datetime="2024-11-09T16:00:00.000Z" title="发表于 2024-11-10 00:00:00">2024-11-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/09/CPP/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/TBB%E5%BC%80%E5%90%AF%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%97%85/" title="TBB开启并行编程之旅"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/%E6%96%87%E7%AB%A0%E5%B0%81%E9%9D%A2/4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TBB开启并行编程之旅"/></a><div class="content"><a class="title" href="/2024/11/09/CPP/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/TBB%E5%BC%80%E5%90%AF%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%97%85/" title="TBB开启并行编程之旅">TBB开启并行编程之旅</a><time datetime="2024-11-08T16:00:00.000Z" title="发表于 2024-11-09 00:00:00">2024-11-09</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="/ming-zhanglu@outlook.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/配置/头像.jpg" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/ming-z0" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/484647453" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-上班摸鱼中.svg" alt="距离月入25k也就还差一个大佬带我~" title="距离月入25k也就还差一个大佬带我~"/><div id="runtimeTextTip"></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2025 By <a class="footer-bar-link" href="/" title="Ming" target="_blank">Ming</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  getScript('https://sdk.jinrishici.com/v2/browser/jinrishici.js').then(() => {
    jinrishici.load(result =>{
      if (true) {
        const sub = ["生活明朗&#44; 万物可爱&#44; 人间值得&#44; 未来可期."]
        const content = result.data.content
        sub.unshift(content)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = result.data.content
      }
    })
  })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">27</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">7</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://ming-blog.top/" title="MINGの部落格"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/配置/头像.jpg" alt="MINGの部落格"/><span class="back-menu-item-text">MINGの部落格</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/MING-Z0/" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AimRT/" style="font-size: 0.88rem;">AimRT<sup>1</sup></a><a href="/tags/CMake/" style="font-size: 0.88rem;">CMake<sup>2</sup></a><a href="/tags/CPP/" style="font-size: 0.88rem;">CPP<sup>21</sup></a><a href="/tags/CUDA/" style="font-size: 0.88rem;">CUDA<sup>10</sup></a><a href="/tags/STL/" style="font-size: 0.88rem;">STL<sup>5</sup></a><a href="/tags/%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97/" style="font-size: 0.88rem;">并行计算<sup>12</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" style="font-size: 0.88rem;">开发环境<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">开发语言<sup>5</sup></a><a href="/tags/%E6%9C%BA%E5%99%A8%E4%BA%BA/" style="font-size: 0.88rem;">机器人<sup>1</sup></a><a href="/tags/%E8%AE%BF%E5%AD%98%E4%BC%98%E5%8C%96/" style="font-size: 0.88rem;">访存优化<sup>1</sup></a><a href="/tags/%E9%9A%8F%E8%AE%B0/" style="font-size: 0.88rem;">随记<sup>5</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 0.88rem;">面试<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="12875524711" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.5"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/my/m/music/playlist?id=12875524711&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("04/01/2021 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-下班啦.svg";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@3.2.2/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://vercel-c6qs1so68-mings-projects-7cb05430.vercel.app/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://vercel-c6qs1so68-mings-projects-7cb05430.vercel.app/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://vercel-c6qs1so68-mings-projects-7cb05430.vercel.app/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "visitor@ming.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>